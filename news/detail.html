<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Chi tiết bài viết - NextPlay</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.2/font/bootstrap-icons.css">
  <link rel="stylesheet" href="../assets/css/style.css">
  <link rel="stylesheet" href="../assets/css/header.css">
  <link rel="stylesheet" href="../assets/css/footer.css">
  <link rel="stylesheet" href="../assets/css/news.css">
  <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
</head>
<body>
  <div data-include="header"></div>

  <div class="container mt-4 pt-5">
    <div class="row">
        <!-- Left Column: Article Content -->
        <div class="col-lg-8">
            <div class="article-container-fluid"> <!-- Renamed to avoid max-width constraint of old class -->
                <!-- Article Content -->
                <div id="article-content">
                    <div class="text-center py-5">
                        <div class="spinner-border text-primary" role="status"></div>
                    </div>
                </div>

                <!-- Read Next Section -->
                <div class="read-next-section mt-5">
                    <h3 class="news-section-title">Đọc tiếp</h3>
                    <div class="row" id="read-next-list">
                        <!-- Injected via JS -->
                    </div>
                </div>

                <!-- Comments Section -->
                <div class="comments-section mt-5">
                    <h3 class="comments-title">Bình luận (<span id="comment-count">0</span>)</h3>
                    
                    <!-- Add Comment Form -->
                    <div class="comment-form mb-4" id="comment-form-container">
                        <div class="d-flex gap-3">
                            <img id="current-user-avatar" src="../assets/images/default-avatar.png" class="comment-avatar" alt="User">
                            <div class="w-100">
                                <div class="d-flex align-items-center mb-2">
                                    <span class="me-2 text-secondary small">Đánh giá:</span>
                                    <div class="rating-select">
                                        <i class="bi bi-star-fill rating-star text-warning fs-5" data-value="1" onclick="setRating(1)" style="cursor: pointer;"></i>
                                        <i class="bi bi-star-fill rating-star text-warning fs-5" data-value="2" onclick="setRating(2)" style="cursor: pointer;"></i>
                                        <i class="bi bi-star-fill rating-star text-warning fs-5" data-value="3" onclick="setRating(3)" style="cursor: pointer;"></i>
                                        <i class="bi bi-star-fill rating-star text-warning fs-5" data-value="4" onclick="setRating(4)" style="cursor: pointer;"></i>
                                        <i class="bi bi-star-fill rating-star text-warning fs-5" data-value="5" onclick="setRating(5)" style="cursor: pointer;"></i>
                                    </div>
                                </div>
                                <textarea class="comment-input" id="comment-input" rows="3" placeholder="Chia sẻ ý kiến của bạn..."></textarea>
                                <div class="d-flex justify-content-end mt-2">
                                    <button class="btn btn-primary px-4 rounded-pill" onclick="postComment()"><span id="post-btn-text">Gửi</span></button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div id="login-prompt" class="alert alert-dark border-secondary text-center d-none">
                        Vui lòng <a href="../auth/login.html" class="text-info fw-bold">đăng nhập</a> để bình luận.
                    </div>

                    <!-- Comment List -->
                    <div class="comment-list" id="comment-list">
                        <!-- Comments injected here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Right Column: Sidebar -->
        <div class="col-lg-4">
            <!-- Sidebar Widget: Notable News -->
            <div class="sidebar-widget">
                <h3 class="widget-title">Đáng chú ý</h3>
                <div class="side-news-list" id="side-news-container">
                    <!-- Injected via JS -->
                </div>
            </div>

            <!-- Sidebar Widget: Categories -->
            <div class="sidebar-widget">
                <h3 class="widget-title">Chuyên mục</h3>
                <ul class="category-list">
                    <li class="category-item"><a href="#" class="category-link"><span>Tin Game</span></a></li>
                    <li class="category-item"><a href="#" class="category-link"><span>Esports</span></a></li>
                    <li class="category-item"><a href="#" class="category-link"><span>Review</span></a></li>
                    <li class="category-item"><a href="#" class="category-link"><span>Công nghệ</span></a></li>
                    <li class="category-item"><a href="#" class="category-link"><span>Cộng đồng</span></a></li>
                </ul>
            </div>
        </div>
    </div>
  </div>

  <div data-include="footer"></div>
  <script src="../env.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="../assets/js/include-components.js"></script>
  <script src="../assets/js/auth.js"></script>
  <script>
    let isEditing = false;

    document.addEventListener('DOMContentLoaded', async () => {
        const urlParams = new URLSearchParams(window.location.search);
        const newsId = parseInt(urlParams.get('id'));

        if (!newsId) {
            window.location.href = 'index.html';
            return;
        }

        try {
            // Ensure ENV is loaded
            if (!window.ENV || !window.ENV.API_URL) {
                console.error('ENV not loaded!');
                return;
            }
            const API_URL = window.ENV.API_URL;

            // 1. Fetch News Detail
            const response = await fetch(`${API_URL}/news/${newsId}`);
            const data = await response.json();

            if (data.status === 'success' && data.data) {
                const article = data.data;
                renderArticle(article);
                
                // Render Comments if available in the response
                if (article.comments) {
                    renderComments(article.comments);
                } else {
                    // Try fetching comments separately if not included
                    fetchComments(newsId);
                }

                // 2. Fetch All News for Sidebar/Related
                fetchRelatedNews(newsId);
                
                checkAuthForComments();
            } else {
                document.getElementById('article-content').innerHTML = '<div class="text-center text-danger py-5">Bài viết không tồn tại.</div>';
            }

        } catch (error) {
            console.error('Error loading news:', error);
            document.getElementById('article-content').innerHTML = '<div class="text-center text-danger py-5">Có lỗi xảy ra khi tải bài viết.</div>';
        }
    });

    async function fetchRelatedNews(currentId) {
        try {
            const response = await fetch(`${window.ENV.API_URL}/news`);
            const data = await response.json();
            if (data.status === 'success' && data.data) {
                const allNews = data.data;
                renderSidebar(allNews);
                renderReadNext(allNews, currentId);
            }
        } catch (e) {
            console.error('Error loading related news:', e);
        }
    }

    async function fetchComments(newsId) {
        try {
            const response = await fetch(`${window.ENV.API_URL}/news/${newsId}/comments`);
            const data = await response.json();
            if (data.status === 'success') {
                renderComments(data.data);
            }
        } catch (e) {
            console.error('Error loading comments:', e);
        }
    }

    function renderArticle(article) {
        // Format date
        const date = new Date(article.created_at).toLocaleDateString('vi-VN');
        
        const html = `
            <div class="article-header text-start">
                <div class="mb-3">
                    <span class="badge bg-danger text-uppercase px-3 py-2">${article.category || 'Tin tức'}</span>
                </div>
                <h1 class="article-title text-start mb-3" style="font-size: 2.5rem;">${article.title}</h1>
                <div class="article-meta justify-content-start mb-4">
                    <span class="text-white fw-bold"><i class="bi bi-person-circle text-primary"></i> ${article.author_name || 'Admin'}</span>
                    <span><i class="bi bi-calendar3"></i> ${date}</span>
                    <span><i class="bi bi-eye"></i> ${article.views} lượt xem</span>
                </div>
            </div>
            <img src="${article.thumbnail || '../assets/images/default-game.png'}" alt="${article.title}" class="article-image w-100 mb-4 shadow-lg" onerror="this.src='../assets/images/default-game.png'">
            <div class="article-content">
                ${article.content}
            </div>
            <div class="mt-5 pt-3 border-top border-secondary">
                <span class="text-secondary me-2">Nguồn:</span>
                <span class="text-white">${article.source || 'NextPlay'}</span>
            </div>
        `;
        document.getElementById('article-content').innerHTML = html;
        
        // Update Page Title
        document.title = `${article.title} - NextPlay News`;
    }

    function renderSidebar(newsList) {
        const sideItems = newsList.slice(0, 5); 
        const container = document.getElementById('side-news-container');
        if(!container) return;
        
        container.innerHTML = sideItems.map(item => `
            <div class="side-news-item">
                <a href="detail.html?id=${item.id}">
                    <img src="${item.thumbnail || '../assets/images/default-game.png'}" class="side-news-thumb" alt="${item.title}" onerror="this.src='../assets/images/default-game.png'">
                </a>
                <div class="side-news-content">
                    <h5 class="side-news-title">
                        <a href="detail.html?id=${item.id}">${item.title}</a>
                    </h5>
                    <div class="side-news-meta">
                        <span class="side-news-source">${item.source || 'NextPlay'}</span>
                        <span>${new Date(item.created_at).toLocaleDateString('vi-VN')}</span>
                    </div>
                </div>
            </div>
        `).join('');
    }

    function renderReadNext(newsList, currentId) {
        const nextItems = newsList.filter(n => n.id != currentId).slice(0, 3);
        const container = document.getElementById('read-next-list');
        if(!container) return;

        container.innerHTML = nextItems.map(item => `
            <div class="col-md-4">
                <div class="card bg-transparent border-0 h-100">
                    <div class="position-relative rounded-3 overflow-hidden mb-3 border border-secondary">
                        <img src="${item.thumbnail || '../assets/images/default-game.png'}" class="img-fluid w-100" style="height: 150px; object-fit: cover;" alt="${item.title}" onerror="this.src='../assets/images/default-game.png'">
                    </div>
                    <h5 class="card-title h6 fw-bold">
                        <a href="detail.html?id=${item.id}" class="text-white text-decoration-none hover-neon">${item.title}</a>
                    </h5>
                    <div class="small text-secondary">
                        <i class="bi bi-calendar3"></i> ${new Date(item.created_at).toLocaleDateString('vi-VN')}
                    </div>
                </div>
            </div>
        `).join('');
    }

    function renderComments(comments) {
        const countSpan = document.getElementById('comment-count');
        if(countSpan) countSpan.textContent = comments.length;
        
        const list = document.getElementById('comment-list');
        if(!list) return;

        if (comments.length === 0) {
            list.innerHTML = '<p class="text-secondary text-center py-3">Chưa có bình luận nào. Hãy là người đầu tiên!</p>';
            return;
        }

        const currentUserStr = localStorage.getItem('user');
        const currentUser = currentUserStr ? JSON.parse(currentUserStr) : null;
        const currentUserName = currentUser ? currentUser.uname : null;

        list.innerHTML = comments.map(c => {
            const isOwner = currentUserName === c.uname; // Assuming 'uname' is returned from join
            const avatarUrl = window.ENV.getAvatarUrl(c.avatar) || '/assets/images/default-avatar.png';
            const rating = c.rating || 5;
            const stars = '★'.repeat(rating) + '☆'.repeat(5 - rating);
            
            return `
            <div class="comment-item">
                <img src="${avatarUrl}" alt="${c.uname}" class="comment-avatar">
                <div class="comment-content w-100">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <span class="comment-author">${c.uname}</span>
                            <span class="text-warning ms-2 small">${stars}</span>
                            <span class="comment-date ms-2">${c.review_time || c.created_at}</span>
                        </div>
                        ${isOwner ? `
                        <div class="dropdown">
                            <button class="btn btn-sm btn-link text-secondary p-0" data-bs-toggle="dropdown">
                                <i class="bi bi-three-dots-vertical"></i>
                            </button>
                            <ul class="dropdown-menu dropdown-menu-dark dropdown-menu-end">
                                <li><a class="dropdown-item small" href="#" onclick="editComment('${c.content.replace(/'/g, "\\'")}', ${rating})"><i class="bi bi-pencil me-2"></i>Sửa</a></li>
                                <li><a class="dropdown-item small text-danger" href="#" onclick="deleteComment()"><i class="bi bi-trash me-2"></i>Xóa</a></li>
                            </ul>
                        </div>
                        ` : ''}
                    </div>
                    <p class="comment-text mt-1">${c.content}</p>
                </div>
            </div>
        `}).join('');
    }

    function checkAuthForComments() {
        const userStr = localStorage.getItem('user');
        if (userStr) {
            const user = JSON.parse(userStr);
            const formContainer = document.getElementById('comment-form-container');
            const loginPrompt = document.getElementById('login-prompt');
            const avatarImg = document.getElementById('current-user-avatar');
            
            if(formContainer) formContainer.classList.remove('d-none');
            if(loginPrompt) loginPrompt.classList.add('d-none');
            if(avatarImg) avatarImg.src = window.ENV.getAvatarUrl(user.avatar);
        } else {
            const formContainer = document.getElementById('comment-form-container');
            const loginPrompt = document.getElementById('login-prompt');
            
            if(formContainer) formContainer.classList.add('d-none');
            if(loginPrompt) loginPrompt.classList.remove('d-none');
        }
    }

    // Handle Rating Selection
    let currentRating = 5;
    function setRating(rating) {
        currentRating = rating;
        const stars = document.querySelectorAll('.rating-star');
        stars.forEach(star => {
            const starVal = parseInt(star.getAttribute('data-value'));
            if (starVal <= rating) {
                star.classList.add('text-warning');
                star.classList.remove('text-secondary');
            } else {
                star.classList.remove('text-warning');
                star.classList.add('text-secondary');
            }
        });
    }

    async function postComment() {
        const input = document.getElementById('comment-input');
        const content = input.value.trim();
        
        if (!content) return;

        if (!localStorage.getItem('user')) {
            alert('Vui lòng đăng nhập để bình luận');
            return;
        }

        const urlParams = new URLSearchParams(window.location.search);
        const newsId = parseInt(urlParams.get('id'));

        try {
            const response = await fetch(`${window.ENV.API_URL}/news/${newsId}/comments`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ 
                    content: content,
                    rating: currentRating
                }),
                credentials: 'include' // Important for session cookie
            });

            const result = await response.json();
            
            if (response.ok && result.status === 'success') {
                // Reload comments
                fetchComments(newsId);
                input.value = '';
                // Reset state
                isEditing = false;
                document.getElementById('post-btn-text').textContent = 'Gửi';
                currentRating = 5;
                setRating(5);
            } else {
                alert(result.message || 'Không thể gửi bình luận');
            }
        } catch (e) {
            console.error('Error posting comment:', e);
            alert('Có lỗi xảy ra khi gửi bình luận');
        }
    }

    async function deleteComment() {
        if(!confirm('Bạn có chắc muốn xóa bình luận này?')) return;

        const urlParams = new URLSearchParams(window.location.search);
        const newsId = parseInt(urlParams.get('id'));

        try {
            const response = await fetch(`${window.ENV.API_URL}/news/${newsId}/comments`, {
                method: 'DELETE',
                credentials: 'include'
            });

            const result = await response.json();
            
            if (response.ok && result.status === 'success') {
                fetchComments(newsId);
                // Reset form if we were editing
                if(isEditing) {
                    isEditing = false;
                    document.getElementById('comment-input').value = '';
                    document.getElementById('post-btn-text').textContent = 'Gửi';
                }
            } else {
                alert(result.message || 'Không thể xóa bình luận');
            }
        } catch (e) {
            console.error('Error deleting comment:', e);
            alert('Có lỗi xảy ra khi xóa bình luận');
        }
    }

    function editComment(content, rating) {
        isEditing = true;
        const input = document.getElementById('comment-input');
        input.value = content;
        input.focus();
        
        // Scroll to form
        document.getElementById('comment-form-container').scrollIntoView({ behavior: 'smooth' });
        
        // Set rating
        setRating(rating);
        
        // Change button text
        document.getElementById('post-btn-text').textContent = 'Cập nhật';
    }
  </script>
</body>
</html>
