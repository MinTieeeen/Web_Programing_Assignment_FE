<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Chi tiết bài viết - NextPlay</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.2/font/bootstrap-icons.css">
  <link rel="stylesheet" href="../assets/css/style.css">
  <link rel="stylesheet" href="../assets/css/header.css">
  <link rel="stylesheet" href="../assets/css/footer.css">
  <link rel="stylesheet" href="../assets/css/news.css">
</head>
<body>
  <div data-include="header"></div>

  <div class="article-container">
    <!-- Article Content -->
    <div id="article-content">
        <!-- Injected via JS -->
        <div class="text-center py-5">
            <div class="spinner-border text-primary" role="status"></div>
        </div>
    </div>

    <!-- Comments Section -->
    <div class="comments-section">
      <h3 class="comments-title">Bình luận (<span id="comment-count">0</span>)</h3>
      
      <!-- Add Comment Form -->
      <div class="comment-form" id="comment-form-container">
        <textarea class="comment-input" id="comment-input" rows="3" placeholder="Viết bình luận của bạn..."></textarea>
        <div class="d-flex justify-content-end">
          <button class="btn btn-primary-glow" onclick="postComment()">Gửi bình luận</button>
        </div>
      </div>
      <div id="login-prompt" class="alert alert-secondary bg-opacity-10 border-secondary text-center d-none">
        Vui lòng <a href="../auth/login.html" class="text-info">đăng nhập</a> để bình luận.
      </div>

      <!-- Comment List -->
      <div class="comment-list" id="comment-list">
        <!-- Comments injected here -->
      </div>
    </div>
  </div>

  <div data-include="footer"></div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="../assets/js/include-components.js"></script>
  <script src="../assets/js/auth.js"></script>
  <script>
    // Mock Data (Same as index.html for consistency)
    const mockNews = [
      {
        id: 1,
        title: "Giải đấu NextPlay Championship 2025 chính thức khởi tranh",
        content: `
            <p>Sự kiện eSports lớn nhất năm đã trở lại với tổng giải thưởng lên đến 1 tỷ đồng. Đăng ký ngay hôm nay để tranh tài cùng các cao thủ hàng đầu.</p>
            <p>Sau thành công rực rỡ của mùa giải 2024, NextPlay Championship 2025 hứa hẹn sẽ mang đến những trận đấu kịch tính và mãn nhãn hơn bao giờ hết. Giải đấu sẽ quy tụ 16 đội tuyển mạnh nhất khu vực, tranh tài ở 3 bộ môn: League of Legends, Valorant và CS2.</p>
            <h3>Cơ cấu giải thưởng</h3>
            <ul>
                <li>Vô địch: 500.000.000 VNĐ</li>
                <li>Á quân: 200.000.000 VNĐ</li>
                <li>Hạng 3-4: 100.000.000 VNĐ</li>
            </ul>
            <p>Vòng loại sẽ bắt đầu từ ngày 15/01/2025. Các đội tuyển có thể đăng ký trực tuyến tại website chính thức của giải đấu.</p>
        `,
        image: "https://images.unsplash.com/photo-1542751371-adc38448a05e?q=80&w=2070&auto=format&fit=crop",
        date: "01/12/2025",
        author: "Admin",
        views: 1200
      },
      {
        id: 2,
        title: "Top 10 game nhập vai đáng chơi nhất tháng 12",
        content: "<p>Nội dung chi tiết bài viết số 2...</p>",
        image: "https://images.unsplash.com/photo-1511512578047-dfb367046420?q=80&w=2071&auto=format&fit=crop",
        date: "28/11/2025",
        author: "Editor Choice",
        views: 850
      },
      // ... Add other items if needed for ID matching
      { id: 3, title: "Bản cập nhật mới...", content: "...", image: "...", date: "...", author: "...", views: 0 },
      { id: 4, title: "Hướng dẫn build PC...", content: "...", image: "...", date: "...", author: "...", views: 0 },
      { id: 5, title: "Review: 'Lost Kingdom'...", content: "...", image: "...", date: "...", author: "...", views: 0 }
    ];

    // Mock Comments
    let mockComments = [
        { id: 1, newsId: 1, user: "GamerPro99", avatar: null, content: "Giải thưởng hấp dẫn quá! Team mình sẽ đăng ký ngay.", date: "01/12/2025 10:30" },
        { id: 2, newsId: 1, user: "NoobMaster", avatar: null, content: "Hóng vòng chung kết, năm ngoái xem cuốn thực sự.", date: "01/12/2025 11:15" }
    ];

    document.addEventListener('DOMContentLoaded', () => {
        const urlParams = new URLSearchParams(window.location.search);
        const newsId = parseInt(urlParams.get('id'));

        if (!newsId) {
            window.location.href = 'index.html';
            return;
        }

        const article = mockNews.find(n => n.id === newsId);
        
        if (article) {
            renderArticle(article);
            renderComments(newsId);
            checkAuthForComments();
        } else {
            document.getElementById('article-content').innerHTML = '<div class="text-center text-danger py-5">Bài viết không tồn tại.</div>';
        }
    });

    function renderArticle(article) {
        const html = `
            <div class="article-header">
                <div class="article-meta mb-3">
                    <span><i class="bi bi-calendar3"></i> ${article.date}</span>
                    <span><i class="bi bi-person"></i> ${article.author}</span>
                    <span><i class="bi bi-eye"></i> ${article.views} lượt xem</span>
                </div>
                <h1 class="article-title">${article.title}</h1>
            </div>
            <img src="${article.image}" alt="${article.title}" class="article-image">
            <div class="article-content">
                ${article.content}
            </div>
        `;
        document.getElementById('article-content').innerHTML = html;
    }

    function renderComments(newsId) {
        const comments = mockComments.filter(c => c.newsId === newsId);
        document.getElementById('comment-count').textContent = comments.length;
        
        const list = document.getElementById('comment-list');
        if (comments.length === 0) {
            list.innerHTML = '<p class="text-secondary text-center">Chưa có bình luận nào. Hãy là người đầu tiên!</p>';
            return;
        }

        list.innerHTML = comments.map(c => `
            <div class="comment-item">
                <img src="${c.avatar || '../assets/images/default-avatar.png'}" alt="${c.user}" class="comment-avatar">
                <div class="comment-content">
                    <span class="comment-author">${c.user} <span class="comment-date">${c.date}</span></span>
                    <p class="comment-text">${c.content}</p>
                </div>
            </div>
        `).join('');
    }

    function checkAuthForComments() {
        const userStr = localStorage.getItem('user');
        if (userStr) {
            document.getElementById('comment-form-container').classList.remove('d-none');
            document.getElementById('login-prompt').classList.add('d-none');
        } else {
            document.getElementById('comment-form-container').classList.add('d-none');
            document.getElementById('login-prompt').classList.remove('d-none');
        }
    }

    function postComment() {
        const input = document.getElementById('comment-input');
        const content = input.value.trim();
        
        if (!content) return;

        const userStr = localStorage.getItem('user');
        if (!userStr) return;
        const user = JSON.parse(userStr);

        const urlParams = new URLSearchParams(window.location.search);
        const newsId = parseInt(urlParams.get('id'));

        const newComment = {
            id: mockComments.length + 1,
            newsId: newsId,
            user: user.uname || user.fname, // Use username or first name
            avatar: user.avatar ? `../assets/uploads/${user.avatar}` : null,
            content: content,
            date: new Date().toLocaleString('vi-VN')
        };

        // Add to mock array
        mockComments.unshift(newComment); // Add to top
        
        // Re-render
        renderComments(newsId);
        
        // Clear input
        input.value = '';
    }
  </script>
</body>
</html>
