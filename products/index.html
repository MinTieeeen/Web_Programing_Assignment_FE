<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Khám phá Game - NextPlay Store</title>
  <meta name="description" content="Tìm kiếm và mua sắm những tựa game hot nhất hiện nay. Kho game đa dạng thể loại: Hành động, RPG, Chiến thuật, Thể thao...">
  <meta name="keywords" content="kho game, mua game, game mới, game hot, rpg, fps, moba">

  <!-- Open Graph / Facebook -->
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://nextplay.com/products/">
  <meta property="og:title" content="Khám phá Game - NextPlay Store">
  <meta property="og:description" content="Tìm kiếm và mua sắm những tựa game hot nhất hiện nay tại NextPlay.">
  <meta property="og:image" content="https://nextplay.com/assets/images/logo.png">

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.2/font/bootstrap-icons.css" rel="stylesheet">
  <link rel="stylesheet" href="../assets/css/style.css">
  <link rel="stylesheet" href="../assets/css/header.css">
  <link rel="stylesheet" href="../assets/css/footer.css">
  <link rel="stylesheet" href="../assets/css/products.css">
</head>
<body>
  <div data-include="header"></div>

  <div class="container mt-5 mb-5" style="min-height: 80vh;">
    <div class="d-flex justify-content-between align-items-center mb-5">
      <div>
        <h1 class="text-white fw-bold mb-2">Khám phá Game</h1>
        <p class="text-secondary m-0">Tìm kiếm những tựa game đỉnh cao dành cho bạn</p>
      </div>
      <div class="d-flex gap-2">
        <select class="form-select bg-dark text-white border-secondary" style="width: 200px;">
          <option selected>Mới nhất</option>
          <option value="1">Giá thấp đến cao</option>
          <option value="2">Giá cao đến thấp</option>
          <option value="3">Phổ biến nhất</option>
        </select>
      </div>
    </div>
    
    <div class="row">
      <!-- Sidebar Filter -->
      <div class="col-lg-3 mb-4">
        <div class="filter-card">
          <h5 class="filter-title">Bộ lọc tìm kiếm</h5>
          
          <div class="filter-group mb-3">
            <span class="filter-label">Tìm kiếm</span>
            <input type="text" id="search-input" class="form-control bg-dark text-white border-secondary" placeholder="Nhập tên game...">
          </div>
          
          <div class="filter-group">
            <span class="filter-label">Thể loại</span>
            <label class="custom-checkbox">
              <input type="checkbox" value="action"> Hành động
            </label>
            <label class="custom-checkbox">
              <input type="checkbox" value="rpg"> Nhập vai (RPG)
            </label>
            <label class="custom-checkbox">
              <input type="checkbox" value="strategy"> Chiến thuật
            </label>
            <label class="custom-checkbox">
              <input type="checkbox" value="adventure"> Phiêu lưu
            </label>
            <label class="custom-checkbox">
              <input type="checkbox" value="sports"> Thể thao
            </label>
          </div>

          <div class="filter-group">
            <span class="filter-label">Giá</span>
            <label class="custom-checkbox">
              <input type="checkbox" value="free"> Miễn phí
            </label>
            <label class="custom-checkbox">
              <input type="checkbox" value="paid"> Có phí
            </label>
          </div>
          
          <button class="btn btn-primary w-100 mt-2">Áp dụng</button>
        </div>
      </div>

      <!-- Product Grid -->
      <div class="col-lg-9">
        <div id="games-grid" class="games-grid">
          <!-- Loading Skeletons -->
          <div class="skeleton-card"></div>
        </div>
        
        <!-- Pagination -->
        <div id="pagination-controls" class="pagination-container"></div>
      </div>
    </div>
  </div>

  <div data-include="footer"></div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="../env.js"></script>
  <script src="../assets/js/include-components.js"></script>
  <script src="../assets/js/auth.js?v=2"></script>
  <script>
    document.addEventListener('DOMContentLoaded', async () => {
        const grid = document.getElementById('games-grid');
        // const paginationContainer = document.querySelector('.pagination'); // Removed as it's no longer used here
        
        let currentPage = 1;
        const itemsPerPage = 9;
        let allGames = [];
        let masterGames = []; // Store full list for filtering

        try {
            // Ensure ENV is loaded
            if (!window.ENV || !window.ENV.API_URL) {
                throw new Error('ENV not loaded! Make sure env.js is included.');
            }
            const API_URL = window.ENV.API_URL;
            const response = await fetch(`${API_URL}/games`);
            if (!response.ok) throw new Error('API Error');
            const data = await response.json();
            
            if (data.status === 'success' && data.data) {
                allGames = data.data.map(game => ({
                    id: game.id || game.gid,
                    name: game.name || game.title,
                    price: game.price || 0,
                    image: game.image_url || game.image || '../assets/images/default-game.jpg',
                    category: game.category_name || game.category || 'Unknown',
                    tags: typeof game.tags === 'string' ? game.tags.split(',') : (Array.isArray(game.tags) ? game.tags : []),
                    description: game.description || 'No description available',
                    developer: game.developer || 'Unknown Developer',
                    publisher: game.publisher_name || game.publisher || 'Unknown Publisher',
                    releaseDate: game.release_date || 'TBA',
                    rating: game.rating || 0,
                    reviews: game.review_count || 0
                }));
                masterGames = [...allGames]; // Backup full list
            } else {
                throw new Error('Failed to fetch games');
            }
        } catch (error) {
            console.error('Error loading games:', error);
            // Show error message to user
            grid.innerHTML = '<div class="col-12 text-center"><h3>Error loading games. Please try again later.</h3></div>';
            return;
        }
            
            // Fallback to mock if empty (optional, but good for demo if DB is empty)
            if (allGames.length === 0) {
                console.warn('API returned empty list');
            }
            
            // Check for search query param
            const urlParams = new URLSearchParams(window.location.search);
            const searchQuery = urlParams.get('search');
            if (searchQuery) {
                document.getElementById('search-input').value = searchQuery;
                filterGames(searchQuery);
            } else {
                renderPage(currentPage);
            }



        // Search Input Handler
        const searchInput = document.getElementById('search-input');
        searchInput.addEventListener('input', (e) => {
            const keyword = e.target.value;
            filterGames(keyword);
        });

        function filterGames(keyword) {
            if (!keyword) {
                // Reset to all games if empty
                allGames = [...masterGames];
                renderPage(1);
                return;
            }
             
             const lowerKeyword = keyword.toLowerCase();
             const filtered = masterGames.filter(game => 
                 game.name.toLowerCase().includes(lowerKeyword)
             );
             
             // Update allGames to be the filtered list so pagination works on it
             allGames = filtered;
             renderPage(1);
        }

        function renderPage(page) {
            currentPage = page;
            const start = (page - 1) * itemsPerPage;
            const end = start + itemsPerPage;
            const gamesToRender = allGames.slice(start, end);
            
            renderGames(gamesToRender);
            renderPagination();
        }

        function renderGames(games) {
            if (!games || games.length === 0) {
                grid.innerHTML = '<div class="col-12 text-center text-white">Không tìm thấy game nào.</div>';
                return;
            }

            grid.innerHTML = games.map(game => `
                <div class="game-card">
                    <div class="game-img-wrapper">
                        <a href="detail.html?id=${game.id}">
                            <img src="${game.image}" alt="${game.name}" class="game-img" loading="lazy" onerror="this.src='../assets/images/default-game.jpg'">
                        </a>
                        <div class="game-overlay"></div>
                    </div>
                    <div class="game-body">
                        <div class="game-tags">
                            ${game.tags ? game.tags.map(tag => `<span class="game-tag">${tag}</span>`).join('') : `<span class="game-tag">${game.category}</span>`}
                        </div>
                        <h3 class="game-title" title="${game.name}">
                            <a href="detail.html?id=${game.id}" class="text-white text-decoration-none">${game.name}</a>
                        </h3>
                        <div class="game-price-row">
                            <span class="game-price ${game.price === 0 ? 'free' : ''}">
                                ${game.price === 0 ? 'Miễn phí' : new Intl.NumberFormat('vi-VN').format(game.price) + ' đ'}
                            </span>
                            <a href="detail.html?id=${game.id}" class="btn-buy-card">
                                Mua ngay
                            </a>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function renderPagination() {
            const totalPages = Math.ceil(allGames.length / itemsPerPage) || 1; // Default to 1 if 0
            const paginationContainer = document.getElementById('pagination-controls');
            
            // Always render, even if 1 page
            let html = `
                <button class="btn-page" id="btn-prev" ${currentPage === 1 ? 'disabled' : ''} onclick="changePage(${currentPage - 1})">
                    <i class="bi bi-chevron-left"></i>
                </button>
                
                <span class="page-info">${currentPage} / ${totalPages}</span>
                
                <button class="btn-page" id="btn-next" ${currentPage === totalPages ? 'disabled' : ''} onclick="changePage(${currentPage + 1})">
                    <i class="bi bi-chevron-right"></i>
                </button>
            `;

            paginationContainer.innerHTML = html;
        }

        // Expose changePage to global scope for onclick handlers
        window.changePage = function(page) {
            const totalPages = Math.ceil(allGames.length / itemsPerPage);
            if (page < 1 || page > totalPages) return;
            renderPage(page);
            // Scroll to top of grid
            document.querySelector('.container').scrollIntoView({ behavior: 'smooth' });
        }
    });
  </script>
</body>
</html>
