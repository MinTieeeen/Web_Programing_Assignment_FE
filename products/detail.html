<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Chi tiết Game - NextPlay</title>
  <meta name="description" content="Chi tiết sản phẩm game tại NextPlay">
  
  <!-- Open Graph / Facebook -->
  <meta property="og:type" content="website">
  <meta property="og:url" content="">
  <meta property="og:title" content="">
  <meta property="og:description" content="">
  <meta property="og:image" content="">

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.2/font/bootstrap-icons.css" rel="stylesheet">
  <link rel="stylesheet" href="../assets/css/style.css">
  <link rel="stylesheet" href="../assets/css/header.css">
  <link rel="stylesheet" href="../assets/css/footer.css">
  <link rel="stylesheet" href="../assets/css/product-detail.css">
</head>
<body>
  <div data-include="header"></div>

  <!-- Dynamic Content Container -->
  <div id="game-detail-container">
      <!-- Loading State -->
      <div class="d-flex justify-content-center align-items-center" style="height: 80vh;">
          <div class="spinner-border text-primary" role="status">
              <span class="visually-hidden">Loading...</span>
          </div>
      </div>
  </div>

  <div data-include="footer"></div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="../env.js?v=2"></script>
  <script src="../assets/js/include-components.js"></script>
  <script src="../assets/js/auth.js"></script>
  <script src="../assets/js/cart.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', async () => {
        const container = document.getElementById('game-detail-container');
        
        // Get Game ID from URL
        const urlParams = new URLSearchParams(window.location.search);
        const gameId = parseInt(urlParams.get('id'));

        if (!gameId) {
            window.location.href = 'index.html';
            return;
        }

        try {
            // Ensure ENV is loaded
            if (!window.ENV || !window.ENV.API_URL) {
                throw new Error('ENV not loaded! Make sure env.js is included.');
            }
            const API_URL = window.ENV.API_URL;
            const response = await fetch(`${API_URL}/games/${gameId}`);
            
            if (response.ok) {
                const data = await response.json();
                
                if (data.status === 'success' && data.data) {
                    // Handle both single object (getOne) and array (getAll filtered)
                    const game = Array.isArray(data.data) ? data.data[0] : data.data;
                    
                    if (game) {
                        window.currentGame = game;
                        renderGameDetail(game);
                    } else {
                        throw new Error('Game not found');
                    }
                } else {
                    throw new Error('Game not found');
                }
            } else {
                throw new Error('Failed to fetch game details');
            }
        } catch (error) {
            console.error('Error loading game details:', error);
            container.innerHTML = `
                <div class="container text-center py-5" style="margin-top: 100px;">
                    <h2 class="text-white">Không tìm thấy game</h2>
                    <p class="text-secondary">Game bạn đang tìm kiếm không tồn tại hoặc đã bị xóa.</p>
                    <a href="index.html" class="btn btn-primary mt-3">Quay lại cửa hàng</a>
                </div>
            `;
            return;
        }
    });

    function updateSEOTags(game) {
        document.title = `${game.name} - Mua ngay tại NextPlay`;
        
        // Meta Description
        const description = `Mua game ${game.name} bản quyền giá rẻ tại NextPlay. ${game.description.substring(0, 150)}...`;
        document.querySelector('meta[name="description"]').setAttribute('content', description);
        
        // Open Graph
        document.querySelector('meta[property="og:url"]').setAttribute('content', window.location.href);
        document.querySelector('meta[property="og:title"]').setAttribute('content', `${game.name} - NextPlay Store`);
        document.querySelector('meta[property="og:description"]').setAttribute('content', description);
        document.querySelector('meta[property="og:image"]').setAttribute('content', window.ENV.getThumbnailUrl(game.image));
    }

    function injectJSONLD(game) {
        const schema = {
            "@context": "https://schema.org/",
            "@type": "Product",
            "name": game.name,
            "image": window.ENV.getThumbnailUrl(game.image),
            "description": game.description,
            "brand": {
                "@type": "Brand",
                "name": game.publisher
            },
            "offers": {
                "@type": "Offer",
                "url": window.location.href,
                "priceCurrency": "VND",
                "price": game.price,
                "availability": "https://schema.org/InStock"
            },
            "aggregateRating": {
                "@type": "AggregateRating",
                "ratingValue": game.rating,
                "reviewCount": game.reviews
            }
        };

        const script = document.createElement('script');
        script.type = "application/ld+json";
        script.text = JSON.stringify(schema);
        document.head.appendChild(script);
    }

    function renderGameDetail(game) {
        const container = document.getElementById('game-detail-container');
        
        // Format Price - backend sends price as string
        const price = parseFloat(game.price) || 0;
        const priceDisplay = price === 0 ? 'Miễn phí' : new Intl.NumberFormat('vi-VN').format(price) + ' đ';
        
        // Generate Stars - use default rating if not provided
        const rating = parseFloat(game.rating) || 4.5;
        const fullStars = Math.floor(rating);
        const halfStar = rating % 1 >= 0.5;
        let starsHtml = '';
        for(let i=0; i<fullStars; i++) starsHtml += '★';
        if(halfStar) starsHtml += '½';
        
        // Handle tags and category
        const category = game.category || 'Game';
        const tags = game.tags ? (typeof game.tags === 'string' ? game.tags.split(',') : game.tags) : [];
        
        // Default reviews count
        const reviews = game.reviews || Math.floor(Math.random() * 1000) + 100;
        
        container.innerHTML = `
            <!-- Hero Section -->
            <div class="game-hero">
                <div class="game-hero-bg">
                    <img src="${window.ENV.getThumbnailUrl(game.image)}" alt="${game.name}" onerror="this.src='../assets/images/default-game.png'">
                </div>
                <div class="game-hero-overlay"></div>
                
                <div class="container game-hero-content">
                    <div class="row align-items-end">
                        <div class="col-lg-3 d-none d-lg-block">
                            <div class="game-poster-card">
                                <img src="${window.ENV.getThumbnailUrl(game.image)}" alt="${game.name}" class="game-poster-img" onerror="this.src='../assets/images/default-game.png'">
                            </div>
                        </div>
                        <div class="col-lg-9">
                            <div class="game-meta-tags">
                                <span class="game-meta-tag">${category}</span>
                                ${tags.length > 0 ? tags.map(tag => `<span class="game-meta-tag">${tag.trim()}</span>`).join('') : ''}
                            </div>
                            
                            <h1 class="game-title-large">${game.name}</h1>
                            <p class="game-description-short">${game.description}</p>
                            
                            <div class="d-flex align-items-center gap-4 mb-4">
                                <span class="game-price-large">${priceDisplay}</span>
                                <div class="d-flex align-items-center gap-2 text-warning">
                                    <span style="font-size: 1.2rem;">${starsHtml}</span>
                                    <span class="text-secondary">(${new Intl.NumberFormat('vi-VN').format(reviews)} đánh giá)</span>
                                </div>
                            </div>
                            
                            <div class="game-actions">
                                <button onclick="addToCartAndCheckout(${game.id})" class="btn-buy-large border-0 cursor-pointer">
                                    Mua ngay
                                </button>
                                <button onclick="addToCartOnly(${game.id})" class="btn-wishlist" title="Thêm vào giỏ hàng">
                                    Thêm vào giỏ hàng
                                </button>
                                <button class="btn-wishlist">
                                    ♥
                                </button>
                                </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Content Section -->
            <div class="game-content-section">
                <div class="container">
                    <div class="row">
                        <!-- Main Content -->
                        <div class="col-lg-8">
                            <div class="content-card">
                                <h3 class="section-title">Giới thiệu</h3>
                                <p class="text-secondary" style="line-height: 1.8;">
                                    ${game.description}
                                    <br><br>
                                    Trải nghiệm ${game.name} ngay hôm nay để khám phá thế giới đầy màu sắc và những thử thách cam go. Được phát triển bởi ${game.developer}, tựa game này hứa hẹn mang lại những giờ phút giải trí tuyệt vời.
                                </p>
                            </div>

                            <div class="content-card">
                                <h3 class="section-title">Đánh giá từ người chơi</h3>
                                <div class="review-stats">
                                    <div class="text-center">
                                        <div class="rating-big">${game.rating}</div>
                                        <div class="rating-stars">${starsHtml}</div>
                                        <div class="rating-count">${new Intl.NumberFormat('vi-VN').format(game.reviews)} bài đánh giá</div>
                                    </div>
                                    <div class="flex-grow-1 border-start border-secondary ps-4">
                                        <p class="text-white mb-1">Rất tích cực</p>
                                        <p class="text-secondary small">95% người chơi hài lòng với tựa game này.</p>
                                    </div>
                                </div>

                                <div class="reviews-list">
                                    <div class="review-item">
                                        <div class="review-header">
                                            <span class="reviewer-name">Gamer123</span>
                                            <span class="review-date">2 ngày trước</span>
                                        </div>
                                        <div class="text-warning mb-2">★★★★★</div>
                                        <p class="review-text">Game quá hay, đồ họa đẹp, cốt truyện cuốn hút. Rất đáng tiền!</p>
                                    </div>
                                    <div class="review-item">
                                        <div class="review-header">
                                            <span class="reviewer-name">ProPlayerVN</span>
                                            <span class="review-date">1 tuần trước</span>
                                        </div>
                                        <div class="text-warning mb-2">★★★★☆</div>
                                        <p class="review-text">Gameplay ổn, nhưng server đôi khi hơi lag. Hy vọng sẽ fix sớm.</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Sidebar Info -->
                        <div class="col-lg-4">
                            <div class="content-card">
                                <h3 class="section-title">Thông tin game</h3>
                                <div class="info-grid" style="grid-template-columns: 1fr;">
                                    <div class="info-item">
                                        <span class="info-label">Nhà phát triển</span>
                                        <span class="info-value">${game.developer}</span>
                                    </div>
                                    <div class="info-item">
                                        <span class="info-label">Nhà phát hành</span>
                                        <span class="info-value">${game.publisher}</span>
                                    </div>
                                    <div class="info-item">
                                        <span class="info-label">Ngày phát hành</span>
                                        <span class="info-value">${game.releaseDate}</span>
                                    </div>
                                    <div class="info-item">
                                        <span class="info-label">Thể loại</span>
                                        <span class="info-value">${game.category}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }

    // Cart Actions
    function addToCartOnly(gameId) {
        if (!localStorage.getItem('user')) {
            if(confirm('Bạn cần đăng nhập để thêm vào giỏ hàng. Đi đến trang đăng nhập?')) {
                window.location.href = '../auth/login.html';
            }
            return;
        }
        
        const game = window.currentGame || (window.mockGames && window.mockGames.find(g => g.id === gameId));
        
        if (game) {
            Cart.addItem(game);
        } else {
            alert('Không tìm thấy thông tin game!');
        }
    }

    function addToCartAndCheckout(gameId) {
        if (!localStorage.getItem('user')) {
            if(confirm('Bạn cần đăng nhập để mua hàng. Đi đến trang đăng nhập?')) {
                window.location.href = '../auth/login.html';
            }
            return;
        }
        
        const game = window.currentGame || (window.mockGames && window.mockGames.find(g => g.id === gameId));
        
        if (game) {
            Cart.addItem(game);
            // Wait a bit for the alert/async add to finish? 
            // Cart.addItem is async in my new implementation but here it's treated as sync?
            // Wait, Cart.addItem in cart.js is NOT async in the user's last edit (they reverted it or something? No, I see async in my previous edit but user might have changed it).
            // Let's check cart.js again.
            // But regardless, we redirect.
            setTimeout(() => {
                window.location.href = '../cart/index.html';
            }, 500);
        } else {
            alert('Không tìm thấy thông tin game!');
        }
    }
  </script>
</body>
</html>
