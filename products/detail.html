<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Chi tiết Game - NextPlay</title>
  <meta name="description" content="Chi tiết sản phẩm game tại NextPlay">
  
  <!-- Open Graph / Facebook -->
  <meta property="og:type" content="website">
  <meta property="og:url" content="">
  <meta property="og:title" content="">
  <meta property="og:description" content="">
  <meta property="og:image" content="">

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.2/font/bootstrap-icons.css" rel="stylesheet">
  <link rel="stylesheet" href="../assets/css/style.css">
  <link rel="stylesheet" href="../assets/css/header.css?v=sidebar_fix">
  <link rel="stylesheet" href="../assets/css/footer.css">
  <link rel="stylesheet" href="../assets/css/toast.css">
  <link rel="stylesheet" href="../assets/css/product-detail.css">
  <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
</head>
<body>
  <div data-include="header"></div>

  <!-- Dynamic Content Container -->
  <div id="game-detail-container">
      <!-- Loading State -->
      <div class="d-flex justify-content-center align-items-center" style="height: 80vh;">
          <div class="spinner-border text-primary" role="status">
              <span class="visually-hidden">Loading...</span>
          </div>
      </div>
  </div>

  <div data-include="footer"></div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="../env.js?v=2"></script>
  <script src="../assets/js/include-components.js?v=4"></script>
  <script src="../assets/js/auth.js?v=3"></script>
  <script src="../assets/js/toast.js"></script>
  <script src="../assets/js/cart.js?v=3"></script>
  <script>
    document.addEventListener('DOMContentLoaded', async () => {
        const container = document.getElementById('game-detail-container');
        
        // Get Game ID from URL
        const urlParams = new URLSearchParams(window.location.search);
        const gameId = parseInt(urlParams.get('id'));

        if (!gameId) {
            window.location.href = 'index.html';
            return;
        }

        try {
            // Ensure ENV is loaded
            if (!window.ENV || !window.ENV.API_URL) {
                throw new Error('ENV not loaded! Make sure env.js is included.');
            }
            const API_URL = window.ENV.API_URL;
            const response = await fetch(`${API_URL}/games/${gameId}`);
            
            if (response.ok) {
                const data = await response.json();
                
                if (data.status === 'success' && data.data) {
                    // Handle both single object (getOne) and array (getAll filtered)
                    const game = Array.isArray(data.data) ? data.data[0] : data.data;
                    
                    if (game) {
                        window.currentGame = game;
                        renderGameDetail(game);
                        updateSEOTags(game);
                        injectJSONLD(game);
                    } else {
                        throw new Error('Game not found');
                    }
                } else {
                    throw new Error('Game not found');
                }
            } else {
                throw new Error('Failed to fetch game details');
            }
        } catch (error) {
            console.error('Error loading game details:', error);
            container.innerHTML = `
                <div class="container text-center py-5" style="margin-top: 100px;">
                    <h2 class="text-white">Không tìm thấy game</h2>
                    <p class="text-secondary">Game bạn đang tìm kiếm không tồn tại hoặc đã bị xóa.</p>
                    <a href="index.html" class="btn btn-primary mt-3">Quay lại cửa hàng</a>
                </div>
            `;
            return;
        }
    });

    function updateSEOTags(game) {
        document.title = `${game.name} - Mua ngay tại NextPlay`;
        
        // Meta Description
        const description = `Mua game ${game.name} bản quyền giá rẻ tại NextPlay. ${game.description.substring(0, 150)}...`;
        document.querySelector('meta[name="description"]').setAttribute('content', description);
        
        // Open Graph
        document.querySelector('meta[property="og:url"]').setAttribute('content', window.location.href);
        document.querySelector('meta[property="og:title"]').setAttribute('content', `${game.name} - NextPlay Store`);
        document.querySelector('meta[property="og:description"]').setAttribute('content', description);
        document.querySelector('meta[property="og:image"]').setAttribute('content', window.ENV.getThumbnailUrl(game.image));
    }

    function injectJSONLD(game) {
        const schema = {
            "@context": "https://schema.org/",
            "@type": "Product",
            "name": game.name,
            "image": window.ENV.getThumbnailUrl(game.image),
            "description": game.description,
            "brand": {
                "@type": "Brand",
                "name": game.publisher
            },
            "offers": {
                "@type": "Offer",
                "url": window.location.href,
                "priceCurrency": "VND",
                "price": game.price,
                "availability": "https://schema.org/InStock"
            },
            "aggregateRating": {
                "@type": "AggregateRating",
                "ratingValue": game.rating,
                "reviewCount": game.reviews
            }
        };

        const script = document.createElement('script');
        script.type = "application/ld+json";
        script.text = JSON.stringify(schema);
        document.head.appendChild(script);
    }

    let isEditingReview = false;
    let currentRating = 5;

    async function renderGameDetail(game) {
        const container = document.getElementById('game-detail-container');
        
        // Fetch Reviews
        let reviews = [];
        try {
            const reviewRes = await fetch(`${window.ENV.API_URL}/feedback/game/${game.id}`);
            const reviewData = await reviewRes.json();
            if (reviewData.status === 'success') {
                reviews = reviewData.data;
            }
        } catch (e) {
            console.error('Error loading reviews:', e);
        }

        // Check Ownership
        let isOwned = false;
        const userStr = localStorage.getItem('user');
        if (userStr) {
            try {
                const libRes = await fetch(`${window.ENV.API_URL}/library`, {
                    credentials: 'include'
                });
                const libData = await libRes.json();
                if (libData.status === 'success' && Array.isArray(libData.data)) {
                    isOwned = libData.data.some(g => g.id === game.id);
                }
            } catch (e) {
                console.error('Error checking ownership:', e);
            }
        }

        // Calculate average rating from real reviews if available
        let displayRating = game.rating;
        let displayReviewCount = game.reviews;
        
        if (reviews.length > 0) {
            const totalRating = reviews.reduce((acc, r) => acc + parseFloat(r.rating), 0);
            displayRating = (totalRating / reviews.length).toFixed(1);
            displayReviewCount = reviews.length;
        }

        // Prepare variables for rendering
        const category = game.category || 'Game';
        let tags = [];
        if (Array.isArray(game.tags)) {
            tags = game.tags;
        } else if (typeof game.tags === 'string') {
            tags = game.tags.split(',');
        }
        const priceDisplay = new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(game.price);

        // Generate Stars
        const fullStars = Math.floor(displayRating);
        const halfStar = displayRating % 1 >= 0.5;
        let starsHtml = '';
        for(let i=0; i<fullStars; i++) starsHtml += '★';
        if(halfStar) starsHtml += '½';

        container.innerHTML = `
            <!-- Hero Section -->
            <div class="game-hero">
                <div class="game-hero-bg">
                    <img src="${window.ENV.getThumbnailUrl(game.image)}" alt="${game.name}" onerror="this.src='../assets/images/default-game.png'">
                </div>
                <div class="game-hero-overlay"></div>
                
                <div class="container game-hero-content">
                    <div class="row align-items-end">
                        <div class="col-lg-3 d-none d-lg-block">
                            <div class="game-poster-card">
                                <img src="${window.ENV.getThumbnailUrl(game.image)}" alt="${game.name}" class="game-poster-img" onerror="this.src='../assets/images/default-game.png'">
                            </div>
                        </div>
                        <div class="col-lg-9">
                            <div class="game-meta-tags">
                                <span class="game-meta-tag">${category}</span>
                                ${tags.length > 0 ? tags.map(tag => `<span class="game-meta-tag">${tag.trim()}</span>`).join('') : ''}
                            </div>
                            
                            <h1 class="game-title-large">${game.name}</h1>
                            <p class="game-description-short">${game.description}</p>
                            
                            <div class="d-flex align-items-center gap-4 mb-4">
                                <span class="game-price-large">${priceDisplay}</span>
                                <div class="d-flex align-items-center gap-2 text-warning">
                                    <span style="font-size: 1.2rem;">${starsHtml}</span>
                                    <span class="text-secondary">(${new Intl.NumberFormat('vi-VN').format(displayReviewCount)} đánh giá)</span>
                                </div>
                            </div>
                            
                            <div class="game-actions">
                                ${isOwned ? `
                                    <button class="btn-buy-large border-0 cursor-not-allowed" style="background: #2d3748; color: #a0aec0;" disabled>
                                        Đã sở hữu
                                    </button>
                                ` : `
                                    <button onclick="addToCartAndCheckout(${game.id})" class="btn-buy-large border-0 cursor-pointer">
                                        Mua ngay
                                    </button>
                                    <button onclick="addToCartOnly(${game.id})" class="btn-wishlist" title="Thêm vào giỏ hàng">
                                        Thêm vào giỏ hàng
                                    </button>
                                `}
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Content Section -->
            <div class="game-content-section">
                <div class="container">
                    <div class="row">
                        <!-- Main Content -->
                        <div class="col-lg-8">
                            <div class="content-card">
                                <h3 class="section-title">Giới thiệu</h3>
                                <p class="text-secondary" style="line-height: 1.8; color: #b9bfc4">
                                    ${game.description}
                                    <br><br>
                                    Trải nghiệm ${game.name} ngay hôm nay để khám phá thế giới đầy màu sắc và những thử thách cam go. Được phát triển bởi ${game.developer}, tựa game này hứa hẹn mang lại những giờ phút giải trí tuyệt vời.
                                </p>
                            </div>

                            <div class="content-card">
                                <h3 class="section-title">Đánh giá từ người chơi</h3>
                                <div class="review-stats">
                                    <div class="text-center">
                                        <div class="rating-big">${displayRating}</div>
                                        <div class="rating-stars">${starsHtml}</div>
                                        <div class="rating-count">${new Intl.NumberFormat('vi-VN').format(displayReviewCount)} bài đánh giá</div>
                                    </div>
                                    <div class="flex-grow-1 border-start border-secondary ps-4">
                                        <p class="text-white mb-1">Rất tích cực</p>
                                        <p class="text-secondary small">95% người chơi hài lòng với tựa game này.</p>
                                    </div>
                                </div>

                                <!-- Redesigned Review Form (Matches News) -->
                                <div class="comments-section mt-4">
                                    <h3 class="comments-title">Bình luận (<span id="review-count">${displayReviewCount}</span>)</h3>
                                    
                                    <div class="comment-form mb-4" id="review-form-container">
                                        <div class="d-flex gap-3">
                                            <img id="current-user-avatar" src="../assets/images/default-avatar.png" class="comment-avatar" alt="User">
                                            <div class="w-100">
                                                <div class="d-flex align-items-center mb-2">
                                                    <span class="me-2 text-secondary small">Đánh giá:</span>
                                                    <div class="rating-select">
                                                        <i class="bi bi-star-fill rating-star text-secondary fs-5" data-value="1" onclick="setRating(1)" style="cursor: pointer;"></i>
                                                        <i class="bi bi-star-fill rating-star text-secondary fs-5" data-value="2" onclick="setRating(2)" style="cursor: pointer;"></i>
                                                        <i class="bi bi-star-fill rating-star text-secondary fs-5" data-value="3" onclick="setRating(3)" style="cursor: pointer;"></i>
                                                        <i class="bi bi-star-fill rating-star text-secondary fs-5" data-value="4" onclick="setRating(4)" style="cursor: pointer;"></i>
                                                        <i class="bi bi-star-fill rating-star text-secondary fs-5" data-value="5" onclick="setRating(5)" style="cursor: pointer;"></i>
                                                    </div>
                                                </div>
                                                <textarea class="comment-input" id="review-input" rows="3" placeholder="Chia sẻ ý kiến của bạn..."></textarea>
                                                <div class="d-flex justify-content-end mt-2">
                                                    <button class="btn btn-secondary me-2 d-none" id="cancel-edit-btn" onclick="cancelEdit()">Hủy</button>
                                                    <button class="btn btn-primary px-4 rounded-pill" onclick="postReview()"><span id="post-btn-text">Gửi</span></button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div id="login-prompt" class="alert alert-dark border-secondary text-center d-none">
                                        Vui lòng <a href="../auth/login.html" class="text-info fw-bold">đăng nhập</a> để viết đánh giá.
                                    </div>

                                    <div class="comment-list mt-4" id="reviews-list">
                                        <!-- Reviews injected here -->
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Sidebar Info -->
                        <div class="col-lg-4">
                            <div class="content-card">
                                <h3 class="section-title">Thông tin game</h3>
                                <div class="info-grid" style="grid-template-columns: 1fr;">
                                    <div class="info-item">
                                        <span class="info-label">Nhà phát triển</span>
                                        <span class="info-value">${game.developer}</span>
                                    </div>
                                    <div class="info-item">
                                        <span class="info-label">Nhà phát hành</span>
                                        <span class="info-value">${game.publisher}</span>
                                    </div>
                                    <div class="info-item">
                                        <span class="info-label">Ngày phát hành</span>
                                        <span class="info-value">${game.releaseDate}</span>
                                    </div>
                                    <div class="info-item">
                                        <span class="info-label">Thể loại</span>
                                        <span class="info-value">${game.category}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        renderReviewsList(reviews);
        checkAuthForReviews(isOwned);
        setRating(5); // Default rating
    }

    function renderReviewsList(reviews) {
        const list = document.getElementById('reviews-list');
        if (!list) return;

        if (reviews.length === 0) {
            list.innerHTML = '<p class="text-secondary text-center py-3">Chưa có đánh giá nào. Hãy là người đầu tiên!</p>';
            return;
        }

        const currentUserStr = localStorage.getItem('user');
        const currentUser = currentUserStr ? JSON.parse(currentUserStr) : null;
        const currentUserName = currentUser ? currentUser.uname : null;

        list.innerHTML = reviews.map(r => {
            const isOwner = currentUserName === r.reviewer_name;
            const avatarUrl = window.ENV.getAvatarUrl(r.reviewer_avatar);
            const rating = r.rating || 5;
            const stars = '★'.repeat(Math.floor(rating)) + '☆'.repeat(5 - Math.floor(rating));
            
            return `
            <div class="comment-item">
                <img src="${avatarUrl}" alt="${r.reviewer_name}" class="comment-avatar">
                <div class="comment-content w-100">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <span class="comment-author">${r.reviewer_name}</span>
                            <span class="text-warning ms-2 small">${stars}</span>
                            <span class="comment-date ms-2">${r.feedback_time}</span>
                        </div>
                        ${isOwner ? `
                        <div class="dropdown">
                            <button class="btn btn-sm btn-link text-secondary p-0" data-bs-toggle="dropdown">
                                <i class="bi bi-three-dots-vertical"></i>
                            </button>
                            <ul class="dropdown-menu dropdown-menu-dark dropdown-menu-end">
                                <li><a class="dropdown-item small" href="#" onclick="editReview('${r.content.replace(/'/g, "\\'")}', ${rating})"><i class="bi bi-pencil me-2"></i>Sửa</a></li>
                                <li><a class="dropdown-item small text-danger" href="#" onclick="deleteReview()"><i class="bi bi-trash me-2"></i>Xóa</a></li>
                            </ul>
                        </div>
                        ` : ''}
                    </div>
                    <p class="comment-text mt-1">${r.content}</p>
                </div>
            </div>
        `}).join('');
    }

    function checkAuthForReviews(isOwned) {
        const userStr = localStorage.getItem('user');
        const formContainer = document.getElementById('review-form-container');
        const loginPrompt = document.getElementById('login-prompt');
        const avatarImg = document.getElementById('current-user-avatar');
        
        if (userStr) {
            const user = JSON.parse(userStr);
            if (isOwned) {
                if(formContainer) formContainer.classList.remove('d-none');
                if(loginPrompt) loginPrompt.classList.add('d-none');
                if(avatarImg) avatarImg.src = window.ENV.getAvatarUrl(user.avatar);
            } else {
                // Logged in but doesn't own game -> Hide everything
                if(formContainer) formContainer.classList.add('d-none');
                if(loginPrompt) loginPrompt.classList.add('d-none');
            }
        } else {
            // Not logged in -> Show login prompt
            if(formContainer) formContainer.classList.add('d-none');
            if(loginPrompt) loginPrompt.classList.remove('d-none');
        }
    }

    function setRating(rating) {
        currentRating = rating;
        const stars = document.querySelectorAll('.rating-star');
        stars.forEach(star => {
            const starVal = parseInt(star.getAttribute('data-value'));
            if (starVal <= rating) {
                star.classList.add('text-warning');
                star.classList.remove('text-secondary');
            } else {
                star.classList.remove('text-warning');
                star.classList.add('text-secondary');
            }
        });
    }

    function editReview(content, rating) {
        isEditingReview = true;
        const input = document.getElementById('review-input');
        input.value = content;
        input.focus();
        
        setRating(rating);
        
        document.getElementById('post-btn-text').textContent = 'Cập nhật';
        document.getElementById('cancel-edit-btn').classList.remove('d-none');
        
        document.getElementById('review-form-container').scrollIntoView({ behavior: 'smooth' });
    }

    function cancelEdit() {
        isEditingReview = false;
        document.getElementById('review-input').value = '';
        setRating(5);
        document.getElementById('post-btn-text').textContent = 'Gửi';
        document.getElementById('cancel-edit-btn').classList.add('d-none');
    }

    async function postReview() {
        const input = document.getElementById('review-input');
        const content = input.value.trim();
        
        if (!content) {
            Toast.warning('Vui lòng nhập nội dung đánh giá');
            return;
        }

        if (!localStorage.getItem('user')) {
            Toast.warning('Vui lòng đăng nhập để đánh giá');
            return;
        }

        const urlParams = new URLSearchParams(window.location.search);
        const gameId = parseInt(urlParams.get('id'));
        const method = isEditingReview ? 'PUT' : 'POST';
        const url = isEditingReview 
            ? `${window.ENV.API_URL}/feedback/game/${gameId}`
            : `${window.ENV.API_URL}/feedback`;

        const body = isEditingReview 
            ? { content: content, rating: currentRating }
            : { Gid: gameId, content: content, rating: currentRating };

        try {
            const response = await fetch(url, {
                method: method,
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(body),
                credentials: 'include'
            });

            const result = await response.json();
            
            if (response.ok && result.status === 'success') {
                // Reload page to refresh reviews
                window.location.reload();
            } else {
                Toast.error(result.message || 'Không thể gửi đánh giá');
            }
        } catch (e) {
            console.error('Error posting review:', e);
            Toast.error('Có lỗi xảy ra khi gửi đánh giá');
        }
    }

    async function deleteReview() {
        if(!confirm('Bạn có chắc muốn xóa đánh giá này?')) return;

        const urlParams = new URLSearchParams(window.location.search);
        const gameId = parseInt(urlParams.get('id'));

        try {
            const response = await fetch(`${window.ENV.API_URL}/feedback/game/${gameId}`, {
                method: 'DELETE',
                credentials: 'include'
            });

            const result = await response.json();
            
            if (response.ok && result.status === 'success') {
                window.location.reload();
            } else {
                Toast.error(result.message || 'Không thể xóa đánh giá');
            }
        } catch (e) {
            console.error('Error deleting review:', e);
            Toast.error('Có lỗi xảy ra khi xóa đánh giá');
        }
    }

    // Cart Actions
    function addToCartOnly(gameId) {
        if (!localStorage.getItem('user')) {
            Toast.warning('Bạn cần đăng nhập để thêm vào giỏ hàng');
            return;
        }
        
        const game = window.currentGame || (window.mockGames && window.mockGames.find(g => g.id === gameId));
        
        if (game) {
            Cart.addItem(game);
        } else {
            Toast.error('Không tìm thấy thông tin game!');
        }
    }

    function addToCartAndCheckout(gameId) {
        if (!localStorage.getItem('user')) {
            Toast.warning('Bạn cần đăng nhập để mua hàng');
            return;
        }
        
        const game = window.currentGame || (window.mockGames && window.mockGames.find(g => g.id === gameId));
        
        if (game) {
            Cart.addItem(game);
            setTimeout(() => {
                window.location.href = '../cart/index.html';
            }, 500);
        } else {
            Toast.error('Không tìm thấy thông tin game!');
        }
    }
  </script>
</body>
</html>
