<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Chi tiết Game - NextPlay</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="../assets/css/style.css">
  <link rel="stylesheet" href="../assets/css/header.css">
  <link rel="stylesheet" href="../assets/css/footer.css">
  <link rel="stylesheet" href="../assets/css/product-detail.css">
</head>
<body>
  <div data-include="header"></div>

  <!-- Dynamic Content Container -->
  <div id="game-detail-container">
      <!-- Loading State -->
      <div class="d-flex justify-content-center align-items-center" style="height: 80vh;">
          <div class="spinner-border text-primary" role="status">
              <span class="visually-hidden">Loading...</span>
          </div>
      </div>
  </div>

  <div data-include="footer"></div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="../assets/js/include-components.js"></script>
  <script src="../assets/js/auth.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', async () => {
        const container = document.getElementById('game-detail-container');
        
        // Get Game ID from URL
        const urlParams = new URLSearchParams(window.location.search);
        const gameId = parseInt(urlParams.get('id'));

        if (!gameId) {
            window.location.href = 'index.html';
            return;
        }

        try {
            // Fetch game details from backend
            const response = await fetch(`http://localhost:80/nextplay/index.php/games?id=${gameId}`);
            
            if (response.ok) {
                const data = await response.json();
                
                if (data.status === 'success' && data.data && data.data.length > 0) {
                    const game = data.data[0];
                    renderGameDetail(game);
                } else {
                    throw new Error('Game not found');
                }
            } else {
                throw new Error('Failed to fetch game details');
            }
        } catch (error) {
            console.error('Error loading game details:', error);
            container.innerHTML = `
                <div class="container text-center py-5" style="margin-top: 100px;">
                    <h2 class="text-white">Không tìm thấy game</h2>
                    <p class="text-secondary">Game bạn đang tìm kiếm không tồn tại hoặc đã bị xóa.</p>
                    <a href="index.html" class="btn btn-primary mt-3">Quay lại cửa hàng</a>
                </div>
            `;
            return;
        }
    });

    function renderGameDetail(game) {
        const container = document.getElementById('game-detail-container');
        
        // Format Price - backend sends price as string
        const price = parseFloat(game.price) || 0;
        const priceDisplay = price === 0 ? 'Miễn phí' : new Intl.NumberFormat('vi-VN').format(price) + ' đ';
        
        // Generate Stars - use default rating if not provided
        const rating = parseFloat(game.rating) || 4.5;
        const fullStars = Math.floor(rating);
        const halfStar = rating % 1 >= 0.5;
        let starsHtml = '';
        for(let i=0; i<fullStars; i++) starsHtml += '★';
        if(halfStar) starsHtml += '½';
        
        // Handle tags and category
        const category = game.category || 'Game';
        const tags = game.tags ? (typeof game.tags === 'string' ? game.tags.split(',') : game.tags) : [];
        
        // Default reviews count
        const reviews = game.reviews || Math.floor(Math.random() * 1000) + 100;
        
        container.innerHTML = `
            <!-- Hero Section -->
            <div class="game-hero">
                <div class="game-hero-bg">
                    <img src="${game.image}" alt="${game.name}">
                </div>
                <div class="game-hero-overlay"></div>
                
                <div class="container game-hero-content">
                    <div class="row align-items-end">
                        <div class="col-lg-3 d-none d-lg-block">
                            <div class="game-poster-card">
                                <img src="${game.image}" alt="${game.name}" class="game-poster-img">
                            </div>
                        </div>
                        <div class="col-lg-9">
                            <div class="game-meta-tags">
                                <span class="game-meta-tag">${category}</span>
                                ${tags.length > 0 ? tags.map(tag => `<span class="game-meta-tag">${tag.trim()}</span>`).join('') : ''}
                            </div>
                            
                            <h1 class="game-title-large">${game.name}</h1>
                            <p class="game-description-short">${game.description}</p>
                            
                            <div class="d-flex align-items-center gap-4 mb-4">
                                <span class="game-price-large">${priceDisplay}</span>
                                <div class="d-flex align-items-center gap-2 text-warning">
                                    <span style="font-size: 1.2rem;">${starsHtml}</span>
                                    <span class="text-secondary">(${new Intl.NumberFormat('vi-VN').format(reviews)} đánh giá)</span>
                                </div>
                            </div>
                            
                            <div class="game-actions">
                                <a href="#" class="btn-buy-large">
                                    Mua ngay
                                </a>
                                <button class="btn-wishlist">
                                    ♥
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Content Section -->
            <div class="game-content-section">
                <div class="container">
                    <div class="row">
                        <!-- Main Content -->
                        <div class="col-lg-8">
                            <div class="content-card">
                                <h3 class="section-title">Giới thiệu</h3>
                                <p class="text-secondary" style="line-height: 1.8;">
                                    ${game.description}
                                    <br><br>
                                    Trải nghiệm ${game.name} ngay hôm nay để khám phá thế giới đầy màu sắc và những thử thách cam go. Được phát triển bởi ${game.developer}, tựa game này hứa hẹn mang lại những giờ phút giải trí tuyệt vời.
                                </p>
                            </div>

                            <div class="content-card">
                                <h3 class="section-title">Đánh giá từ người chơi</h3>
                                <div class="review-stats">
                                    <div class="text-center">
                                        <div class="rating-big">${game.rating}</div>
                                        <div class="rating-stars">${starsHtml}</div>
                                        <div class="rating-count">${new Intl.NumberFormat('vi-VN').format(game.reviews)} bài đánh giá</div>
                                    </div>
                                    <div class="flex-grow-1 border-start border-secondary ps-4">
                                        <p class="text-white mb-1">Rất tích cực</p>
                                        <p class="text-secondary small">95% người chơi hài lòng với tựa game này.</p>
                                    </div>
                                </div>

                                <div class="reviews-list">
                                    <div class="review-item">
                                        <div class="review-header">
                                            <span class="reviewer-name">Gamer123</span>
                                            <span class="review-date">2 ngày trước</span>
                                        </div>
                                        <div class="text-warning mb-2">★★★★★</div>
                                        <p class="review-text">Game quá hay, đồ họa đẹp, cốt truyện cuốn hút. Rất đáng tiền!</p>
                                    </div>
                                    <div class="review-item">
                                        <div class="review-header">
                                            <span class="reviewer-name">ProPlayerVN</span>
                                            <span class="review-date">1 tuần trước</span>
                                        </div>
                                        <div class="text-warning mb-2">★★★★☆</div>
                                        <p class="review-text">Gameplay ổn, nhưng server đôi khi hơi lag. Hy vọng sẽ fix sớm.</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Sidebar Info -->
                        <div class="col-lg-4">
                            <div class="content-card">
                                <h3 class="section-title">Thông tin game</h3>
                                <div class="info-grid" style="grid-template-columns: 1fr;">
                                    <div class="info-item">
                                        <span class="info-label">Nhà phát triển</span>
                                        <span class="info-value">${game.developer}</span>
                                    </div>
                                    <div class="info-item">
                                        <span class="info-label">Nhà phát hành</span>
                                        <span class="info-value">${game.publisher}</span>
                                    </div>
                                    <div class="info-item">
                                        <span class="info-label">Ngày phát hành</span>
                                        <span class="info-value">${game.releaseDate}</span>
                                    </div>
                                    <div class="info-item">
                                        <span class="info-label">Thể loại</span>
                                        <span class="info-value">${game.category}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }
  </script>
</body>
</html>
