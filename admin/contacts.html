<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Publishers - NextPlay Admin</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@tabler/core@latest/dist/css/tabler.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@tabler/icons-webfont@latest/dist/tabler-icons.min.css">
    <style>@import url('https://rsms.me/inter/inter.css');</style>
</head>
<body class="layout-fluid">
    <script src="https://cdn.jsdelivr.net/npm/@tabler/core@latest/dist/js/tabler.min.js"></script>
    <div class="page">
        <aside class="navbar navbar-vertical navbar-expand-lg" data-bs-theme="dark">
            <div class="container-fluid">
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#sidebar-menu"><span class="navbar-toggler-icon"></span></button>
                <h1 class="navbar-brand navbar-brand-autodark"><a href="/admin/index.html"><i class="ti ti-device-gamepad-2 me-2"></i><span>NextPlay Admin</span></a></h1>
                <div class="collapse navbar-collapse" id="sidebar-menu">
                    <ul class="navbar-nav pt-lg-3">
                        <li class="nav-item"><a class="nav-link" href="/admin/index.html"><span class="nav-link-icon"><i class="ti ti-home"></i></span><span class="nav-link-title">Dashboard</span></a></li>
                        <li class="nav-item"><a class="nav-link" href="/admin/users.html"><span class="nav-link-icon"><i class="ti ti-users"></i></span><span class="nav-link-title">Users</span></a></li>
                        <li class="nav-item"><a class="nav-link" href="/admin/admin-users.html"><span class="nav-link-icon"><i class="ti ti-shield-check"></i></span><span class="nav-link-title">Admins</span></a></li>
                        <li class="nav-item"><a class="nav-link" href="/admin/products.html"><span class="nav-link-icon"><i class="ti ti-device-gamepad-2"></i></span><span class="nav-link-title">Games</span></a></li>
                        <li class="nav-item"><a class="nav-link" href="/admin/orders.html"><span class="nav-link-icon"><i class="ti ti-shopping-cart"></i></span><span class="nav-link-title">Orders</span></a></li>
                        <li class="nav-item"><a class="nav-link" href="/admin/comments.html"><span class="nav-link-icon"><i class="ti ti-message-circle"></i></span><span class="nav-link-title">Reviews</span></a></li>
                        <li class="nav-item"><a class="nav-link active" href="/admin/contacts.html"><span class="nav-link-icon"><i class="ti ti-building"></i></span><span class="nav-link-title">Publishers</span></a></li>
                        <li class="nav-item"><a class="nav-link" href="/admin/posts.html"><span class="nav-link-icon"><i class="ti ti-category"></i></span><span class="nav-link-title">Categories</span></a></li>
                        <li class="nav-item"><a class="nav-link" href="/admin/faqs.html"><span class="nav-link-icon"><i class="ti ti-help"></i></span><span class="nav-link-title">FAQs</span></a></li>
                        <li class="nav-item"><a class="nav-link" href="/admin/news.html"><span class="nav-link-icon"><i class="ti ti-news"></i></span><span class="nav-link-title">News</span></a></li>
                        <li class="nav-item"><a class="nav-link" href="/admin/feedback.html"><span class="nav-link-icon"><i class="ti ti-star"></i></span><span class="nav-link-title">Feedback</span></a></li>
                        <li class="nav-item"><a class="nav-link" href="/admin/settings.html"><span class="nav-link-icon"><i class="ti ti-settings"></i></span><span class="nav-link-title">Settings</span></a></li>
                        <li class="nav-item mt-auto"><a class="nav-link text-danger" href="#" onclick="logout()"><span class="nav-link-icon"><i class="ti ti-logout"></i></span><span class="nav-link-title">Logout</span></a></li>
                    </ul>
                </div>
            </div>
        </aside>
        <div class="page-wrapper">
            <header class="navbar navbar-expand-md d-none d-lg-flex d-print-none">
                <div class="container-xl">
                    <div class="navbar-nav flex-row order-md-last">
                        <div class="nav-item dropdown">
                            <a href="#" class="nav-link d-flex lh-1 text-reset p-0" data-bs-toggle="dropdown">
                                <span class="avatar avatar-sm bg-primary" id="userAvatar">A</span>
                                <div class="d-none d-xl-block ps-2"><div id="userName">Admin</div><div class="mt-1 small text-muted">Administrator</div></div>
                            </a>
                            <div class="dropdown-menu dropdown-menu-end dropdown-menu-arrow">
                                <a href="/admin/settings.html" class="dropdown-item"><i class="ti ti-settings me-2"></i>Settings</a>
                                <div class="dropdown-divider"></div>
                                <a href="#" class="dropdown-item text-danger" onclick="logout()"><i class="ti ti-logout me-2"></i>Logout</a>
                            </div>
                        </div>
                    </div>
                </div>
            </header>
            <div class="page-header d-print-none">
                <div class="container-xl">
                    <div class="row align-items-center">
                        <div class="col-auto">
                            <div class="page-pretitle">Management</div>
                            <h2 class="page-title">Publishers</h2>
                        </div>
                        <div class="col-auto ms-auto">
                            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addPublisherModal"><i class="ti ti-plus me-2"></i>Add Publisher</button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="page-body">
                <div class="container-xl">
                    <!-- Search -->
                    <div class="card mb-3">
                        <div class="card-body">
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <div class="input-icon">
                                        <span class="input-icon-addon"><i class="ti ti-search"></i></span>
                                        <input type="text" class="form-control" id="searchPublisher" placeholder="Search publishers...">
                                    </div>
                                </div>
                                <div class="col-md-2">
                                    <button class="btn btn-secondary w-100" onclick="resetFilters()"><i class="ti ti-refresh me-1"></i>Reset</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- Stats -->
                    <div class="row row-deck row-cards mb-3">
                        <div class="col-sm-6 col-lg-4">
                            <div class="card card-sm">
                                <div class="card-body">
                                    <div class="row align-items-center">
                                        <div class="col-auto"><span class="bg-primary text-white avatar"><i class="ti ti-building"></i></span></div>
                                        <div class="col"><div class="font-weight-medium" id="totalPublishers">0</div><div class="text-muted">Total Publishers</div></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-sm-6 col-lg-4">
                            <div class="card card-sm">
                                <div class="card-body">
                                    <div class="row align-items-center">
                                        <div class="col-auto"><span class="bg-green text-white avatar"><i class="ti ti-device-gamepad-2"></i></span></div>
                                        <div class="col"><div class="font-weight-medium" id="totalGames">0</div><div class="text-muted">Total Games</div></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-sm-6 col-lg-4">
                            <div class="card card-sm">
                                <div class="card-body">
                                    <div class="row align-items-center">
                                        <div class="col-auto"><span class="bg-azure text-white avatar"><i class="ti ti-chart-bar"></i></span></div>
                                        <div class="col"><div class="font-weight-medium" id="avgGames">0</div><div class="text-muted">Avg Games/Publisher</div></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- Table -->
                    <div class="card">
                        <div class="card-header"><h3 class="card-title">Publishers List</h3></div>
                        <div class="table-responsive">
                            <table class="table table-vcenter card-table table-striped">
                                <thead><tr><th>ID</th><th>Publisher</th><th>Location</th><th>Tax Code</th><th>Games</th><th class="w-1">Actions</th></tr></thead>
                                <tbody id="publishersTableBody"><tr><td colspan="6" class="text-center text-muted">Loading...</td></tr></tbody>
                            </table>
                        </div>
                        <div class="card-footer d-flex align-items-center">
                            <p class="m-0 text-muted">Showing <span id="showingCount">0</span> of <span id="totalCount">0</span> publishers</p>
                        </div>
                    </div>
                </div>
            </div>
            <footer class="footer footer-transparent d-print-none"><div class="container-xl"><div class="text-center">Copyright &copy; 2024 NextPlay.</div></div></footer>
        </div>
    </div>

    <!-- Add Publisher Modal -->
    <div class="modal modal-blur fade" id="addPublisherModal" tabindex="-1">
        <div class="modal-dialog modal-lg"><div class="modal-content">
            <div class="modal-header"><h5 class="modal-title">Add Publisher</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
            <div class="modal-body">
                <form id="addPublisherForm">
                    <div class="row mb-3">
                        <div class="col-md-6"><label class="form-label">Username *</label><input type="text" class="form-control" name="uname" required></div>
                        <div class="col-md-6"><label class="form-label">Email *</label><input type="email" class="form-control" name="email" required></div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6"><label class="form-label">Password *</label><input type="password" class="form-control" name="password" required minlength="8"></div>
                        <div class="col-md-6"><label class="form-label">Date of Birth *</label><input type="date" class="form-control" name="DOB" required></div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6"><label class="form-label">First Name *</label><input type="text" class="form-control" name="fname" required></div>
                        <div class="col-md-6"><label class="form-label">Last Name *</label><input type="text" class="form-control" name="lname" required></div>
                    </div>
                    <div class="mb-3"><label class="form-label">Description *</label><textarea class="form-control" name="description" rows="3" required></textarea></div>
                    <div class="row mb-3">
                        <div class="col-md-6"><label class="form-label">Tax Code *</label><input type="text" class="form-control" name="taxcode" required></div>
                        <div class="col-md-6"><label class="form-label">Location *</label><input type="text" class="form-control" name="location" required></div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="addPublisher()">Add Publisher</button>
            </div>
        </div></div>
    </div>

    <!-- Edit Publisher Modal -->
    <div class="modal modal-blur fade" id="editPublisherModal" tabindex="-1">
        <div class="modal-dialog modal-lg"><div class="modal-content">
            <div class="modal-header"><h5 class="modal-title">Edit Publisher</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
            <div class="modal-body">
                <form id="editPublisherForm">
                    <input type="hidden" name="uid" id="editPublisherId">
                    <div class="row mb-3">
                        <div class="col-md-6"><label class="form-label">First Name</label><input type="text" class="form-control" name="fname" id="editFname"></div>
                        <div class="col-md-6"><label class="form-label">Last Name</label><input type="text" class="form-control" name="lname" id="editLname"></div>
                    </div>
                    <div class="mb-3"><label class="form-label">Email</label><input type="email" class="form-control" name="email" id="editEmail"></div>
                    <div class="mb-3"><label class="form-label">Description</label><textarea class="form-control" name="description" id="editDescription" rows="3"></textarea></div>
                    <div class="row mb-3">
                        <div class="col-md-6"><label class="form-label">Tax Code</label><input type="text" class="form-control" name="taxcode" id="editTaxcode"></div>
                        <div class="col-md-6"><label class="form-label">Location</label><input type="text" class="form-control" name="location" id="editLocation"></div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="updatePublisher()">Save Changes</button>
            </div>
        </div></div>
    </div>

    <!-- View Publisher Modal -->
    <div class="modal modal-blur fade" id="viewPublisherModal" tabindex="-1">
        <div class="modal-dialog modal-lg"><div class="modal-content">
            <div class="modal-header"><h5 class="modal-title">Publisher Details</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
            <div class="modal-body" id="viewPublisherBody"></div>
        </div></div>
    </div>

    <script src="../env.js"></script>
    <script>
        const API_BASE_URL = window.ENV?.API_URL || '';
        let allPublishers = [], allGames = [];
        
        function logout() { 
            fetch(`${API_BASE_URL}/users/logout`, { method: 'POST', credentials: 'include' })
            .finally(() => window.location.href = '/admin/login.html'); 
        }

        async function loadData() {
            try {
                const [pubRes, gamesRes] = await Promise.all([
                    fetch(`${API_BASE_URL}/publishers`, { credentials: 'include' }),
                    fetch(`${API_BASE_URL}/games`, { credentials: 'include' })
                ]);
                const pubData = await pubRes.json();
                const gamesData = await gamesRes.json();
                
                if (pubData.status === 'success') allPublishers = pubData.data || [];
                if (gamesData.status === 'success') allGames = gamesData.data || [];
                
                updateStats();
                renderPublishers();
            } catch (e) { console.error(e); }
        }

        function updateStats() {
            document.getElementById('totalPublishers').textContent = allPublishers.length;
            document.getElementById('totalGames').textContent = allGames.length;
            const avg = allPublishers.length > 0 ? (allGames.length / allPublishers.length).toFixed(1) : 0;
            document.getElementById('avgGames').textContent = avg;
        }

        function renderPublishers() {
            const tbody = document.getElementById('publishersTableBody');
            const search = document.getElementById('searchPublisher').value.toLowerCase();
            
            let filtered = allPublishers;
            if (search) {
                filtered = allPublishers.filter(p => 
                    (p.fname + ' ' + p.lname).toLowerCase().includes(search) ||
                    (p.description || '').toLowerCase().includes(search) ||
                    (p.location || '').toLowerCase().includes(search)
                );
            }
            
            document.getElementById('showingCount').textContent = filtered.length;
            document.getElementById('totalCount').textContent = allPublishers.length;
            
            if (filtered.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">No publishers found</td></tr>';
                return;
            }
            
            tbody.innerHTML = filtered.map(p => {
                const gameCount = allGames.filter(g => g.publisherid == p.uid).length;
                const name = `${p.fname || ''} ${p.lname || ''}`.trim() || p.uname || 'Unknown';
                return `
                    <tr>
                        <td class="text-muted">${p.uid}</td>
                        <td>
                            <div class="d-flex align-items-center">
                                <span class="avatar avatar-sm bg-azure me-2"><i class="ti ti-building"></i></span>
                                <div>
                                    <div class="font-weight-medium">${name}</div>
                                    <div class="text-muted small">${p.email || ''}</div>
                                </div>
                            </div>
                        </td>
                        <td>${p.location || '-'}</td>
                        <td><code>${p.taxcode || '-'}</code></td>
                        <td><span class="badge bg-primary">${gameCount} games</span></td>
                        <td>
                            <div class="btn-list flex-nowrap">
                                <button class="btn btn-sm btn-outline-primary" onclick="viewPublisher(${p.uid})" title="View"><i class="ti ti-eye"></i></button>
                                <button class="btn btn-sm btn-primary" onclick="editPublisher(${p.uid})" title="Edit"><i class="ti ti-edit"></i></button>
                                <button class="btn btn-sm btn-danger" onclick="deletePublisher(${p.uid})" title="Delete"><i class="ti ti-trash"></i></button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function resetFilters() {
            document.getElementById('searchPublisher').value = '';
            renderPublishers();
        }

        async function addPublisher() {
            const form = document.getElementById('addPublisherForm');
            const data = Object.fromEntries(new FormData(form));
            try {
                const res = await fetch(`${API_BASE_URL}/publishers/register`, {
                    method: 'POST', 
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include', 
                    body: JSON.stringify(data)
                });
                const result = await res.json();
                if (result.status === 'success') {
                    bootstrap.Modal.getInstance(document.getElementById('addPublisherModal')).hide();
                    form.reset(); 
                    loadData();
                    alert('Publisher added successfully!');
                } else {
                    alert(result.message || 'Error adding publisher');
                }
            } catch (e) { 
                console.error(e); 
                alert('Error adding publisher');
            }
        }

        function viewPublisher(uid) {
            const pub = allPublishers.find(p => p.uid === uid);
            if (!pub) return;
            
            const gameCount = allGames.filter(g => g.publisherid == uid).length;
            const pubGames = allGames.filter(g => g.publisherid == uid);
            const name = `${pub.fname || ''} ${pub.lname || ''}`.trim() || pub.uname;
            
            document.getElementById('viewPublisherBody').innerHTML = `
                <div class="row">
                    <div class="col-md-6">
                        <h4>${name}</h4>
                        <p class="text-muted">${pub.email}</p>
                        <hr>
                        <p><strong>Location:</strong> ${pub.location || 'N/A'}</p>
                        <p><strong>Tax Code:</strong> <code>${pub.taxcode || 'N/A'}</code></p>
                        <p><strong>Description:</strong></p>
                        <p class="text-muted">${pub.description || 'No description'}</p>
                    </div>
                    <div class="col-md-6">
                        <h5>Games (${gameCount})</h5>
                        <div class="list-group list-group-flush" style="max-height: 300px; overflow-y: auto;">
                            ${pubGames.length > 0 ? pubGames.map(g => `
                                <div class="list-group-item d-flex justify-content-between align-items-center">
                                    <span>${g.name}</span>
                                    <span class="badge bg-primary">${formatCurrency(g.cost)}</span>
                                </div>
                            `).join('') : '<div class="list-group-item text-muted">No games yet</div>'}
                        </div>
                    </div>
                </div>
            `;
            new bootstrap.Modal(document.getElementById('viewPublisherModal')).show();
        }

        function editPublisher(uid) {
            const pub = allPublishers.find(p => p.uid === uid);
            if (!pub) return;
            
            document.getElementById('editPublisherId').value = pub.uid;
            document.getElementById('editFname').value = pub.fname || '';
            document.getElementById('editLname').value = pub.lname || '';
            document.getElementById('editEmail').value = pub.email || '';
            document.getElementById('editDescription').value = pub.description || '';
            document.getElementById('editTaxcode').value = pub.taxcode || '';
            document.getElementById('editLocation').value = pub.location || '';
            
            new bootstrap.Modal(document.getElementById('editPublisherModal')).show();
        }

        async function updatePublisher() {
            const form = document.getElementById('editPublisherForm');
            const data = Object.fromEntries(new FormData(form));
            const uid = data.uid;
            
            try {
                const res = await fetch(`${API_BASE_URL}/publishers/${uid}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify(data)
                });
                const result = await res.json();
                if (result.status === 'success') {
                    bootstrap.Modal.getInstance(document.getElementById('editPublisherModal')).hide();
                    loadData();
                    alert('Publisher updated successfully!');
                } else {
                    alert(result.message || 'Error updating publisher');
                }
            } catch (e) {
                console.error(e);
                alert('Error updating publisher');
            }
        }

        async function deletePublisher(uid) {
            if (!confirm('Are you sure you want to delete this publisher? This will also delete the associated user account.')) return;
            try {
                const res = await fetch(`${API_BASE_URL}/publishers/${uid}`, { 
                    method: 'DELETE', 
                    credentials: 'include' 
                });
                const result = await res.json();
                if (result.status === 'success') {
                    loadData();
                    alert('Publisher deleted successfully!');
                } else {
                    alert(result.message || 'Error deleting publisher');
                }
            } catch (e) { 
                console.error(e); 
                alert('Error deleting publisher');
            }
        }

        function formatCurrency(amount) {
            return new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(amount || 0);
        }

        document.getElementById('searchPublisher').addEventListener('input', renderPublishers);
        document.addEventListener('DOMContentLoaded', loadData);
    </script>
</body>
</html>
