<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>News - NextPlay Admin</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@tabler/core@latest/dist/css/tabler.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@tabler/icons-webfont@latest/dist/tabler-icons.min.css">
    <style>
        @import url('https://rsms.me/inter/inter.css');
        .news-thumb { width: 120px; height: 80px; object-fit: cover; border-radius: 4px; }
    </style>
</head>
<body class="layout-fluid">
    <script src="https://cdn.jsdelivr.net/npm/@tabler/core@latest/dist/js/tabler.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <div class="page">
        <aside class="navbar navbar-vertical navbar-expand-lg" data-bs-theme="dark">
            <div class="container-fluid">
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#sidebar-menu"><span class="navbar-toggler-icon"></span></button>
                <h1 class="navbar-brand navbar-brand-autodark"><a href="/admin/index.html"><i class="ti ti-device-gamepad-2 me-2"></i><span>NextPlay Admin</span></a></h1>
                <div class="collapse navbar-collapse" id="sidebar-menu">
                    <ul class="navbar-nav pt-lg-3">
                        <li class="nav-item"><a class="nav-link" href="/admin/index.html"><span class="nav-link-icon"><i class="ti ti-home"></i></span><span class="nav-link-title">Dashboard</span></a></li>
                        <li class="nav-item"><a class="nav-link" href="/admin/users.html"><span class="nav-link-icon"><i class="ti ti-users"></i></span><span class="nav-link-title">Users</span></a></li>
                        <li class="nav-item"><a class="nav-link" href="/admin/admin-users.html"><span class="nav-link-icon"><i class="ti ti-shield-check"></i></span><span class="nav-link-title">Admins</span></a></li>
                        <li class="nav-item"><a class="nav-link" href="/admin/products.html"><span class="nav-link-icon"><i class="ti ti-device-gamepad-2"></i></span><span class="nav-link-title">Games</span></a></li>
                        <li class="nav-item"><a class="nav-link" href="/admin/orders.html"><span class="nav-link-icon"><i class="ti ti-shopping-cart"></i></span><span class="nav-link-title">Orders</span></a></li>
                        <li class="nav-item"><a class="nav-link" href="/admin/comments.html"><span class="nav-link-icon"><i class="ti ti-message-circle"></i></span><span class="nav-link-title">Reviews</span></a></li>
                        <li class="nav-item"><a class="nav-link" href="/admin/contacts.html"><span class="nav-link-icon"><i class="ti ti-building"></i></span><span class="nav-link-title">Publishers</span></a></li>
                        <li class="nav-item"><a class="nav-link" href="/admin/posts.html"><span class="nav-link-icon"><i class="ti ti-category"></i></span><span class="nav-link-title">Categories</span></a></li>
                        <li class="nav-item"><a class="nav-link" href="/admin/faqs.html"><span class="nav-link-icon"><i class="ti ti-help"></i></span><span class="nav-link-title">FAQs</span></a></li>
                        <li class="nav-item"><a class="nav-link active" href="/admin/news.html"><span class="nav-link-icon"><i class="ti ti-news"></i></span><span class="nav-link-title">News</span></a></li>
                        <li class="nav-item"><a class="nav-link" href="/admin/feedback.html"><span class="nav-link-icon"><i class="ti ti-star"></i></span><span class="nav-link-title">Feedback</span></a></li>
                        <li class="nav-item"><a class="nav-link" href="/admin/settings.html"><span class="nav-link-icon"><i class="ti ti-settings"></i></span><span class="nav-link-title">Settings</span></a></li>
                        <li class="nav-item mt-auto"><a class="nav-link text-danger" href="#" onclick="logout()"><span class="nav-link-icon"><i class="ti ti-logout"></i></span><span class="nav-link-title">Logout</span></a></li>
                    </ul>
                </div>
            </div>
        </aside>
        <div class="page-wrapper">
            <header class="navbar navbar-expand-md d-none d-lg-flex d-print-none">
                <div class="container-xl">
                    <div class="navbar-nav flex-row order-md-last">
                        <div class="nav-item dropdown">
                            <a href="#" class="nav-link d-flex lh-1 text-reset p-0" data-bs-toggle="dropdown">
                                <span class="avatar avatar-sm bg-primary" id="userAvatar">A</span>
                                <div class="d-none d-xl-block ps-2"><div id="userName">Admin</div><div class="mt-1 small text-muted">Administrator</div></div>
                            </a>
                            <div class="dropdown-menu dropdown-menu-end dropdown-menu-arrow">
                                <a href="/admin/settings.html" class="dropdown-item"><i class="ti ti-settings me-2"></i>Settings</a>
                                <div class="dropdown-divider"></div>
                                <a href="#" class="dropdown-item text-danger" onclick="logout()"><i class="ti ti-logout me-2"></i>Logout</a>
                            </div>
                        </div>
                    </div>
                </div>
            </header>
            <div class="page-header d-print-none">
                <div class="container-xl">
                    <div class="row align-items-center">
                        <div class="col-auto">
                            <div class="page-pretitle">Content Management</div>
                            <h2 class="page-title">News Articles</h2>
                        </div>
                        <div class="col-auto ms-auto">
                            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addNewsModal"><i class="ti ti-plus me-2"></i>Add News</button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="page-body">
                <div class="container-xl">
                    <!-- Stats -->
                    <div class="row row-deck row-cards mb-3">
                        <div class="col-sm-6 col-lg-3">
                            <div class="card card-sm">
                                <div class="card-body">
                                    <div class="row align-items-center">
                                        <div class="col-auto"><span class="bg-primary text-white avatar"><i class="ti ti-news"></i></span></div>
                                        <div class="col"><div class="font-weight-medium" id="totalNews">0</div><div class="text-muted">Total Articles</div></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-sm-6 col-lg-3">
                            <div class="card card-sm">
                                <div class="card-body">
                                    <div class="row align-items-center">
                                        <div class="col-auto"><span class="bg-green text-white avatar"><i class="ti ti-eye"></i></span></div>
                                        <div class="col"><div class="font-weight-medium" id="totalViews">0</div><div class="text-muted">Total Views</div></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- News Table -->
                    <div class="card">
                        <div class="card-header"><h3 class="card-title">News Articles</h3></div>
                        <div class="table-responsive">
                            <table class="table table-vcenter card-table table-striped">
                                <thead>
                                    <tr>
                                        <th>Article</th>
                                        <th>Category</th>
                                        <th>Author</th>
                                        <th>Views</th>
                                        <th>Date</th>
                                        <th class="w-1">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="newsTableBody">
                                    <tr><td colspan="7" class="text-center text-muted">Loading...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            <footer class="footer footer-transparent d-print-none"><div class="container-xl"><div class="text-center">Copyright &copy; 2024 NextPlay.</div></div></footer>
        </div>
    </div>

    <!-- Add News Modal -->
    <div class="modal modal-blur fade" id="addNewsModal" tabindex="-1">
        <div class="modal-dialog modal-lg"><div class="modal-content">
            <div class="modal-header"><h5 class="modal-title">Add News Article</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
            <div class="modal-body">
                <form id="addNewsForm">
                    <div class="mb-3"><label class="form-label">Title *</label><input type="text" class="form-control" name="title" required></div>
                    <div class="mb-3"><label class="form-label">Content *</label><textarea class="form-control" name="content" rows="5" required></textarea></div>
                    <div class="row mb-3">
                        <div class="col-md-6"><label class="form-label">Category</label><input type="text" class="form-control" name="category" placeholder="e.g., Esports, Updates"></div>
                        <div class="col-md-6"><label class="form-label">Source</label><input type="text" class="form-control" name="source" placeholder="e.g., NextPlay Team"></div>
                    </div>
                    <div class="mb-3"><label class="form-label">Thumbnail URL</label><input type="url" class="form-control" name="thumbnail"></div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="addNews()">Add Article</button>
            </div>
        </div></div>
    </div>

    <!-- Edit News Modal -->
    <div class="modal modal-blur fade" id="editNewsModal" tabindex="-1">
        <div class="modal-dialog modal-lg"><div class="modal-content">
            <div class="modal-header"><h5 class="modal-title">Edit News Article</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
            <div class="modal-body">
                <form id="editNewsForm">
                    <input type="hidden" name="id" id="editNewsId">
                    <div class="mb-3"><label class="form-label">Title *</label><input type="text" class="form-control" name="title" id="editNewsTitle" required></div>
                    <div class="mb-3"><label class="form-label">Content *</label><textarea class="form-control" name="content" id="editNewsContent" rows="5" required></textarea></div>
                    <div class="row mb-3">
                        <div class="col-md-6"><label class="form-label">Category</label><input type="text" class="form-control" name="category" id="editNewsCategory"></div>
                        <div class="col-md-6"><label class="form-label">Source</label><input type="text" class="form-control" name="source" id="editNewsSource"></div>
                    </div>
                    <div class="mb-3"><label class="form-label">Thumbnail URL</label><input type="url" class="form-control" name="thumbnail" id="editNewsThumbnail"></div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="updateNews()">Save Changes</button>
            </div>
        </div></div>
    </div>

    <!-- View News Modal -->
    <div class="modal modal-blur fade" id="viewNewsModal" tabindex="-1">
        <div class="modal-dialog modal-lg"><div class="modal-content">
            <div class="modal-header"><h5 class="modal-title">News Article Details</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
            <div class="modal-body">
                <div class="mb-3">
                    <img id="viewNewsThumbnail" src="" class="img-fluid rounded mb-3" style="max-height: 300px; width: 100%; object-fit: cover;" onerror="this.style.display='none'">
                </div>
                <h3 id="viewNewsTitle" class="mb-2">Title</h3>
                <div class="d-flex gap-3 mb-3">
                    <span class="badge bg-azure-lt" id="viewNewsCategory">Category</span>
                    <span class="text-muted"><i class="ti ti-eye me-1"></i><span id="viewNewsViews">0</span> views</span>
                    <span class="text-muted"><i class="ti ti-calendar me-1"></i><span id="viewNewsDate">Date</span></span>
                </div>
                <div class="d-flex align-items-center mb-3">
                    <span class="avatar avatar-sm me-2" id="viewNewsAuthorAvatar">A</span>
                    <div>
                        <div class="small text-muted">Author</div>
                        <div id="viewNewsAuthor">Unknown</div>
                    </div>
                </div>
                <hr>
                <div id="viewNewsContent" style="white-space: pre-wrap;">Content</div>
                <hr>
                <div class="row g-3 text-muted small">
                    <div class="col-md-6"><strong>Source:</strong> <span id="viewNewsSource">-</span></div>
                    <div class="col-md-6"><strong>ID:</strong> <span id="viewNewsId">-</span></div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="viewNewsEditBtn">Edit Article</button>
            </div>
        </div></div>
    </div>

    <script src="../env.js"></script>
    <script>
        const API_BASE_URL = window.ENV?.API_URL || '';
        let newsList = [];
        
        function logout() { 
            fetch(`${API_BASE_URL}/users/logout`, { method: 'POST', credentials: 'include' })
            .finally(() => window.location.href = '/admin/login.html'); 
        }

        async function loadData() {
            try {
                const res = await fetch(`${API_BASE_URL}/news`, { credentials: 'include' });
                const data = await res.json();
                if (data.status === 'success') {
                    newsList = Array.isArray(data.data) ? data.data : [];
                    updateStats();
                    renderNews();
                }
            } catch (e) { console.error(e); }
        }

        function updateStats() {
            document.getElementById('totalNews').textContent = newsList.length;
            const totalViews = newsList.reduce((sum, n) => sum + (n.views || 0), 0);
            document.getElementById('totalViews').textContent = totalViews.toLocaleString();
        }

        function renderNews() {
            const tbody = document.getElementById('newsTableBody');
            if (newsList.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">No news articles found</td></tr>';
                return;
            }
            
            tbody.innerHTML = newsList.map(news => `
                <tr>
                    <td>
                        <div class="d-flex align-items-center">
                            <img src="${news.thumbnail || 'https://placehold.co/120x80?text=No+Image'}" class="news-thumb me-3" onerror="this.onerror=null;this.src='https://placehold.co/120x80?text=No+Image'">
                            <div>
                                <div class="font-weight-medium">${news.title}</div>
                                <div class="text-muted small">ID: ${news.id}</div>
                            </div>
                        </div>
                    </td>
                    <td><span class="badge bg-azure-lt">${news.category || 'General'}</span></td>
                    <td>
                        <div class="d-flex align-items-center">
                            <span class="avatar avatar-xs me-2" style="background-image: url('${news.author_avatar || ''}')">${!news.author_avatar ? (news.author_name || 'A')[0].toUpperCase() : ''}</span>
                            ${news.author_name || 'Unknown'}
                        </div>
                    </td>
                    <td>${(news.views || 0).toLocaleString()}</td>
                    <td>${news.created_at ? new Date(news.created_at).toLocaleDateString() : 'N/A'}</td>
                    <td>
                        <div class="btn-list flex-nowrap">
                            <button class="btn btn-sm btn-info" onclick="viewNews(${news.id})" title="View"><i class="ti ti-eye"></i></button>
                            <button class="btn btn-sm btn-primary" onclick="editNews(${news.id})" title="Edit"><i class="ti ti-edit"></i></button>
                            <button class="btn btn-sm btn-danger" onclick="deleteNews(${news.id})" title="Delete"><i class="ti ti-trash"></i></button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        async function addNews() {
            const form = document.getElementById('addNewsForm');
            const formData = new FormData(form);
            const data = {};
            
            for (let [key, value] of formData.entries()) {
                data[key] = value;
            }

            try {
                const res = await fetch(`${API_BASE_URL}/news`, {
                    method: 'POST', 
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include', 
                    body: JSON.stringify(data)
                });
                const result = await res.json();
                if (result.status === 'success') {
                    bootstrap.Modal.getInstance(document.getElementById('addNewsModal')).hide();
                    form.reset();
                    loadData();
                    alert('News article added successfully!');
                } else {
                    alert(result.message || 'Error adding news');
                }
            } catch (e) { console.error(e); alert('Error adding news'); }
        }

        function viewNews(id) {
            const news = newsList.find(n => n.id == id);
            if (!news) return;
            
            const thumb = document.getElementById('viewNewsThumbnail');
            if (news.thumbnail) {
                thumb.src = news.thumbnail;
                thumb.style.display = 'block';
            } else {
                thumb.style.display = 'none';
            }
            document.getElementById('viewNewsTitle').textContent = news.title || 'Untitled';
            document.getElementById('viewNewsCategory').textContent = news.category || 'General';
            document.getElementById('viewNewsViews').textContent = (news.views || 0).toLocaleString();
            document.getElementById('viewNewsDate').textContent = news.created_at ? new Date(news.created_at).toLocaleDateString() : 'N/A';
            document.getElementById('viewNewsAuthor').textContent = news.author_name || 'Unknown';
            const authorAvatar = document.getElementById('viewNewsAuthorAvatar');
            if (news.author_avatar) {
                authorAvatar.style.backgroundImage = `url('${news.author_avatar}')`;
                authorAvatar.textContent = '';
            } else {
                authorAvatar.style.backgroundImage = '';
                authorAvatar.textContent = (news.author_name || 'A')[0].toUpperCase();
            }
            document.getElementById('viewNewsContent').textContent = news.content || 'No content';
            document.getElementById('viewNewsSource').textContent = news.source || '-';
            document.getElementById('viewNewsId').textContent = news.id;
            
            document.getElementById('viewNewsEditBtn').onclick = () => {
                bootstrap.Modal.getInstance(document.getElementById('viewNewsModal')).hide();
                editNews(id);
            };
            
            new bootstrap.Modal(document.getElementById('viewNewsModal')).show();
        }

        function editNews(id) {
            const news = newsList.find(n => n.id == id);
            if (!news) return;
            
            document.getElementById('editNewsId').value = news.id;
            document.getElementById('editNewsTitle').value = news.title || '';
            document.getElementById('editNewsContent').value = news.content || '';
            document.getElementById('editNewsCategory').value = news.category || '';
            document.getElementById('editNewsSource').value = news.source || '';
            document.getElementById('editNewsThumbnail').value = news.thumbnail || '';
            
            new bootstrap.Modal(document.getElementById('editNewsModal')).show();
        }

        async function updateNews() {
            const form = document.getElementById('editNewsForm');
            const formData = new FormData(form);
            const data = {};
            
            for (let [key, value] of formData.entries()) {
                data[key] = value;
            }
            
            const id = data.id;
            
            try {
                const res = await fetch(`${API_BASE_URL}/news/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify(data)
                });
                const result = await res.json();
                if (result.status === 'success') {
                    bootstrap.Modal.getInstance(document.getElementById('editNewsModal')).hide();
                    loadData();
                    alert('News article updated successfully!');
                } else {
                    alert(result.message || 'Error updating news');
                }
            } catch (e) { console.error(e); alert('Error updating news'); }
        }

        async function deleteNews(id) {
            if (!confirm('Are you sure you want to delete this news article?')) return;
            
            try {
                const res = await fetch(`${API_BASE_URL}/news/${id}`, { 
                    method: 'DELETE', 
                    credentials: 'include' 
                });
                const result = await res.json();
                if (result.status === 'success') {
                    loadData();
                    alert('News article deleted successfully!');
                } else {
                    alert(result.message || 'Error deleting news');
                }
            } catch (e) { console.error(e); alert('Error deleting news'); }
        }

        document.addEventListener('DOMContentLoaded', loadData);
    </script>
</body>
</html>
