<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Game Feedback - NextPlay Admin</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@tabler/core@latest/dist/css/tabler.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@tabler/icons-webfont@latest/dist/tabler-icons.min.css">
    <style>@import url('https://rsms.me/inter/inter.css');</style>
</head>
<body class="layout-fluid">
    <script src="https://cdn.jsdelivr.net/npm/@tabler/core@latest/dist/js/tabler.min.js"></script>
    <div class="page">
        <aside class="navbar navbar-vertical navbar-expand-lg" data-bs-theme="dark">
            <div class="container-fluid">
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#sidebar-menu"><span class="navbar-toggler-icon"></span></button>
                <h1 class="navbar-brand navbar-brand-autodark"><a href="/admin/index.html"><i class="ti ti-device-gamepad-2 me-2"></i><span>NextPlay Admin</span></a></h1>
                <div class="collapse navbar-collapse" id="sidebar-menu">
                    <ul class="navbar-nav pt-lg-3">
                        <li class="nav-item"><a class="nav-link" href="/admin/index.html"><span class="nav-link-icon"><i class="ti ti-home"></i></span><span class="nav-link-title">Dashboard</span></a></li>
                        <li class="nav-item"><a class="nav-link" href="/admin/users.html"><span class="nav-link-icon"><i class="ti ti-users"></i></span><span class="nav-link-title">Users</span></a></li>
                        <li class="nav-item"><a class="nav-link" href="/admin/admin-users.html"><span class="nav-link-icon"><i class="ti ti-shield-check"></i></span><span class="nav-link-title">Admins</span></a></li>
                        <li class="nav-item"><a class="nav-link" href="/admin/products.html"><span class="nav-link-icon"><i class="ti ti-device-gamepad-2"></i></span><span class="nav-link-title">Games</span></a></li>
                        <li class="nav-item"><a class="nav-link" href="/admin/orders.html"><span class="nav-link-icon"><i class="ti ti-shopping-cart"></i></span><span class="nav-link-title">Orders</span></a></li>
                        <li class="nav-item"><a class="nav-link" href="/admin/comments.html"><span class="nav-link-icon"><i class="ti ti-message-circle"></i></span><span class="nav-link-title">Reviews</span></a></li>
                        <li class="nav-item"><a class="nav-link" href="/admin/contacts.html"><span class="nav-link-icon"><i class="ti ti-building"></i></span><span class="nav-link-title">Publishers</span></a></li>
                        <li class="nav-item"><a class="nav-link" href="/admin/posts.html"><span class="nav-link-icon"><i class="ti ti-category"></i></span><span class="nav-link-title">Categories</span></a></li>
                        <li class="nav-item"><a class="nav-link" href="/admin/faqs.html"><span class="nav-link-icon"><i class="ti ti-help"></i></span><span class="nav-link-title">FAQs</span></a></li>
                        <li class="nav-item"><a class="nav-link" href="/admin/news.html"><span class="nav-link-icon"><i class="ti ti-news"></i></span><span class="nav-link-title">News</span></a></li>
                        <li class="nav-item"><a class="nav-link active" href="/admin/feedback.html"><span class="nav-link-icon"><i class="ti ti-star"></i></span><span class="nav-link-title">Feedback</span></a></li>
                        <li class="nav-item"><a class="nav-link" href="/admin/settings.html"><span class="nav-link-icon"><i class="ti ti-settings"></i></span><span class="nav-link-title">Settings</span></a></li>
                        <li class="nav-item mt-auto"><a class="nav-link text-danger" href="#" onclick="logout()"><span class="nav-link-icon"><i class="ti ti-logout"></i></span><span class="nav-link-title">Logout</span></a></li>
                    </ul>
                </div>
            </div>
        </aside>
        <div class="page-wrapper">
            <header class="navbar navbar-expand-md d-none d-lg-flex d-print-none">
                <div class="container-xl">
                    <div class="navbar-nav flex-row order-md-last">
                        <div class="nav-item dropdown">
                            <a href="#" class="nav-link d-flex lh-1 text-reset p-0" data-bs-toggle="dropdown">
                                <span class="avatar avatar-sm bg-primary" id="userAvatar">A</span>
                                <div class="d-none d-xl-block ps-2"><div id="userName">Admin</div><div class="mt-1 small text-muted">Administrator</div></div>
                            </a>
                            <div class="dropdown-menu dropdown-menu-end dropdown-menu-arrow">
                                <a href="/admin/settings.html" class="dropdown-item"><i class="ti ti-settings me-2"></i>Settings</a>
                                <div class="dropdown-divider"></div>
                                <a href="#" class="dropdown-item text-danger" onclick="logout()"><i class="ti ti-logout me-2"></i>Logout</a>
                            </div>
                        </div>
                    </div>
                </div>
            </header>
            <div class="page-header d-print-none">
                <div class="container-xl">
                    <div class="row align-items-center">
                        <div class="col-auto">
                            <div class="page-pretitle">Content Management</div>
                            <h2 class="page-title">Game Feedback & Reviews</h2>
                        </div>
                    </div>
                </div>
            </div>
            <div class="page-body">
                <div class="container-xl">
                    <!-- Stats -->
                    <div class="row row-deck row-cards mb-3">
                        <div class="col-sm-6 col-lg-3">
                            <div class="card card-sm">
                                <div class="card-body">
                                    <div class="row align-items-center">
                                        <div class="col-auto"><span class="bg-primary text-white avatar"><i class="ti ti-message-circle"></i></span></div>
                                        <div class="col"><div class="font-weight-medium" id="totalFeedback">0</div><div class="text-muted">Total Reviews</div></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-sm-6 col-lg-3">
                            <div class="card card-sm">
                                <div class="card-body">
                                    <div class="row align-items-center">
                                        <div class="col-auto"><span class="bg-yellow text-white avatar"><i class="ti ti-star"></i></span></div>
                                        <div class="col"><div class="font-weight-medium" id="avgRating">0</div><div class="text-muted">Avg Rating</div></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-sm-6 col-lg-3">
                            <div class="card card-sm">
                                <div class="card-body">
                                    <div class="row align-items-center">
                                        <div class="col-auto"><span class="bg-green text-white avatar"><i class="ti ti-thumb-up"></i></span></div>
                                        <div class="col"><div class="font-weight-medium" id="positiveReviews">0</div><div class="text-muted">Positive (4-5★)</div></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-sm-6 col-lg-3">
                            <div class="card card-sm">
                                <div class="card-body">
                                    <div class="row align-items-center">
                                        <div class="col-auto"><span class="bg-red text-white avatar"><i class="ti ti-thumb-down"></i></span></div>
                                        <div class="col"><div class="font-weight-medium" id="negativeReviews">0</div><div class="text-muted">Negative (1-2★)</div></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Filters -->
                    <div class="card mb-3">
                        <div class="card-body">
                            <div class="row g-3">
                                <div class="col-md-4">
                                    <input type="text" class="form-control" id="searchFeedback" placeholder="Search by game or user...">
                                </div>
                                <div class="col-md-3">
                                    <select class="form-select" id="ratingFilter">
                                        <option value="">All Ratings</option>
                                        <option value="5">5 Stars</option>
                                        <option value="4">4 Stars</option>
                                        <option value="3">3 Stars</option>
                                        <option value="2">2 Stars</option>
                                        <option value="1">1 Star</option>
                                    </select>
                                </div>
                                <div class="col-md-2">
                                    <button class="btn btn-secondary w-100" onclick="resetFilters()"><i class="ti ti-refresh me-1"></i>Reset</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Feedback Table -->
                    <div class="card">
                        <div class="card-header"><h3 class="card-title">All Game Reviews</h3></div>
                        <div class="table-responsive">
                            <table class="table table-vcenter card-table table-striped">
                                <thead>
                                    <tr>
                                        <th>User</th>
                                        <th>Game</th>
                                        <th>Rating</th>
                                        <th>Content</th>
                                        <th>Date</th>
                                        <th class="w-1">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="feedbackTableBody">
                                    <tr><td colspan="6" class="text-center text-muted">Loading...</td></tr>
                                </tbody>
                            </table>
                        </div>
                        <div class="card-footer d-flex align-items-center">
                            <p class="m-0 text-muted">Showing <span id="showingFrom">0</span> to <span id="showingTo">0</span> of <span id="totalEntries">0</span></p>
                            <ul class="pagination m-0 ms-auto" id="pagination"></ul>
                        </div>
                    </div>
                </div>
            </div>
            <footer class="footer footer-transparent d-print-none"><div class="container-xl"><div class="text-center">Copyright &copy; 2024 NextPlay.</div></div></footer>
        </div>
    </div>

    <script src="../env.js"></script>
    <script>
        const API_BASE_URL = window.ENV?.API_URL || '';
        let feedbackList = [];
        let currentPage = 1;
        const itemsPerPage = 10;
        
        function logout() { 
            fetch(`${API_BASE_URL}/users/logout`, { method: 'POST', credentials: 'include' })
            .finally(() => window.location.href = '/admin/login.html'); 
        }

        async function loadData() {
            try {
                const res = await fetch(`${API_BASE_URL}/feedback`, { credentials: 'include' });
                const data = await res.json();
                if (data.status === 'success') {
                    feedbackList = Array.isArray(data.data) ? data.data : [];
                    updateStats();
                    renderFeedback();
                }
            } catch (e) { console.error(e); }
        }

        function updateStats() {
            document.getElementById('totalFeedback').textContent = feedbackList.length;
            
            if (feedbackList.length > 0) {
                const totalRating = feedbackList.reduce((sum, f) => sum + (f.rating || 0), 0);
                document.getElementById('avgRating').textContent = (totalRating / feedbackList.length).toFixed(1);
            }
            
            const positive = feedbackList.filter(f => f.rating >= 4).length;
            const negative = feedbackList.filter(f => f.rating <= 2).length;
            document.getElementById('positiveReviews').textContent = positive;
            document.getElementById('negativeReviews').textContent = negative;
        }

        function renderStars(rating) {
            return Array(5).fill(0).map((_, i) => 
                `<i class="ti ti-star${i < rating ? '-filled text-yellow' : ' text-muted'}"></i>`
            ).join('');
        }

        function renderFeedback() {
            const tbody = document.getElementById('feedbackTableBody');
            const search = document.getElementById('searchFeedback').value.toLowerCase();
            const ratingFilter = document.getElementById('ratingFilter').value;

            let filtered = feedbackList.filter(f => {
                const matchSearch = (f.game_name || '').toLowerCase().includes(search) || 
                                   (f.uname || '').toLowerCase().includes(search) ||
                                   (f.content || '').toLowerCase().includes(search);
                const matchRating = !ratingFilter || f.rating == ratingFilter;
                return matchSearch && matchRating;
            });

            const totalPages = Math.ceil(filtered.length / itemsPerPage);
            const start = (currentPage - 1) * itemsPerPage;
            const paginated = filtered.slice(start, start + itemsPerPage);

            document.getElementById('showingFrom').textContent = filtered.length ? start + 1 : 0;
            document.getElementById('showingTo').textContent = Math.min(start + itemsPerPage, filtered.length);
            document.getElementById('totalEntries').textContent = filtered.length;

            if (paginated.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">No reviews found</td></tr>';
                return;
            }

            tbody.innerHTML = paginated.map(fb => `
                <tr>
                    <td>
                        <div class="d-flex align-items-center">
                            <span class="avatar avatar-sm bg-primary me-2">${(fb.uname || 'U')[0].toUpperCase()}</span>
                            ${fb.uname || 'Unknown'}
                        </div>
                    </td>
                    <td><span class="badge bg-azure-lt">${fb.game_name || 'N/A'}</span></td>
                    <td>${renderStars(fb.rating)}</td>
                    <td>
                        <div style="max-width: 300px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                            ${fb.content || 'No content'}
                        </div>
                    </td>
                    <td>${fb.feedback_time ? new Date(fb.feedback_time).toLocaleDateString() : 'N/A'}</td>
                    <td>
                        <button class="btn btn-sm btn-danger" onclick="deleteFeedback(${fb.customerid}, ${fb.Gid})">
                            <i class="ti ti-trash"></i>
                        </button>
                    </td>
                </tr>
            `).join('');

            renderPagination(totalPages);
        }

        function renderPagination(totalPages) {
            const pagination = document.getElementById('pagination');
            let html = `<li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
                <a class="page-link" href="#" onclick="goToPage(${currentPage - 1})"><i class="ti ti-chevron-left"></i></a>
            </li>`;
            for (let i = 1; i <= Math.min(totalPages, 5); i++) {
                html += `<li class="page-item ${currentPage === i ? 'active' : ''}">
                    <a class="page-link" href="#" onclick="goToPage(${i})">${i}</a>
                </li>`;
            }
            html += `<li class="page-item ${currentPage === totalPages || totalPages === 0 ? 'disabled' : ''}">
                <a class="page-link" href="#" onclick="goToPage(${currentPage + 1})"><i class="ti ti-chevron-right"></i></a>
            </li>`;
            pagination.innerHTML = html;
        }

        function goToPage(page) {
            currentPage = page;
            renderFeedback();
        }

        function resetFilters() {
            document.getElementById('searchFeedback').value = '';
            document.getElementById('ratingFilter').value = '';
            currentPage = 1;
            renderFeedback();
        }

        async function deleteFeedback(customerid, gid) {
            if (!confirm('Are you sure you want to delete this review?')) return;
            
            try {
                const res = await fetch(`${API_BASE_URL}/feedback/${customerid}/${gid}`, { 
                    method: 'DELETE', 
                    credentials: 'include' 
                });
                const result = await res.json();
                if (result.status === 'success') {
                    loadData();
                    alert('Review deleted successfully!');
                } else {
                    alert(result.message || 'Error deleting review');
                }
            } catch (e) { console.error(e); alert('Error deleting review'); }
        }

        document.getElementById('searchFeedback').addEventListener('input', () => { currentPage = 1; renderFeedback(); });
        document.getElementById('ratingFilter').addEventListener('change', () => { currentPage = 1; renderFeedback(); });

        document.addEventListener('DOMContentLoaded', loadData);
    </script>
</body>
</html>
