<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Game Management - Admin Dashboard</title>
    <!-- Tabler Core -->
    <link href="../assets/tabler/css/tabler.min.css" rel="stylesheet"/>
    <link href="../assets/tabler/css/tabler-flags.min.css" rel="stylesheet"/>
    <link href="../assets/tabler/css/tabler-payments.min.css" rel="stylesheet"/>
    <link href="../assets/tabler/css/tabler-vendors.min.css" rel="stylesheet"/>
    <link href="../assets/css/toast.css" rel="stylesheet"/>
    <style>
      @import url('https://rsms.me/inter/inter.css');
      :root {
      	--tblr-font-sans-serif: 'Inter Var', -apple-system, BlinkMacSystemFont, San Francisco, Segoe UI, Roboto, Helvetica Neue, sans-serif;
      }
      body {
      	font-feature-settings: "cv03", "cv04", "cv11";
      }
    </style>
</head>
<body>
    <script src="../assets/tabler/js/tabler-theme.min.js"></script>
    <div class="page">
        <!-- Sidebar -->
        <div id="sidebarContainer"></div>

        <div class="page-wrapper">
            <!-- Navbar -->
            <div id="navbarContainer"></div>

            <!-- Page Header -->
            <div class="page-header d-print-none">
                <div class="container-xl">
                    <div class="row g-2 align-items-center">
                        <div class="col">
                            <h2 class="page-title">
                                Quản lý trò chơi
                            </h2>
                        </div>
                        <div class="col-auto ms-auto d-print-none">
                            <div class="btn-list">

                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Page Body -->
            <div class="page-body">
                <div class="container-xl">
                    <!-- Stats Cards -->
                    <div class="row row-deck row-cards mb-4">
                        <div class="col-sm-6 col-lg-3">
                            <div class="card">
                                <div class="card-body">
                                    <div class="d-flex align-items-center">
                                        <div class="subheader">Tổng số trò chơi</div>
                                    </div>
                                    <div class="h1 mb-3" id="totalGamesCount">...</div>
                                    <div class="d-flex mb-2">
                                        <div>Tất cả trò chơi trong danh mục</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-sm-6 col-lg-3">
                            <div class="card">
                                <div class="card-body">
                                    <div class="d-flex align-items-center">
                                        <div class="subheader">Đã duyệt</div>
                                    </div>
                                    <div class="h1 mb-3" id="approvedGamesCount">...</div>
                                    <div class="d-flex mb-2">
                                        <div class="text-success">
                                            <span class="status-dot status-dot-animated bg-success me-1"></span>
                                            Đang hoạt động trên cửa hàng
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-sm-6 col-lg-3">
                            <div class="card">
                                <div class="card-body">
                                    <div class="d-flex align-items-center">
                                        <div class="subheader">Chờ duyệt</div>
                                    </div>
                                    <div class="h1 mb-3" id="pendingGamesCount">0</div>
                                    <div class="d-flex mb-2">
                                        <div>Đang chờ xem xét</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-sm-6 col-lg-3">
                            <div class="card">
                                <div class="card-body">
                                    <div class="d-flex align-items-center">
                                        <div class="subheader">Tổng giá trị</div>
                                    </div>
                                    <div class="h1 mb-3" id="totalDownloads">...</div>
                                    <div class="d-flex mb-2">
                                        <div>Tổng giá trị danh mục</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Filters -->
                    <div class="card mb-3">
                        <div class="card-body">
                            <div class="row g-2">
                                <div class="col-md-3">
                                    <div class="input-icon">
                                        <span class="input-icon-addon">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M10 10m-7 0a7 7 0 1 0 14 0a7 7 0 0 0 -14 0" /><path d="M21 21l-6 -6" /></svg>
                                        </span>
                                        <input type="text" class="form-control" id="searchGame" placeholder="Tìm kiếm trò chơi...">
                                    </div>
                                </div>
                                <div class="col-md-2">
                                    <select class="form-select" id="categoryFilter">
                                        <option value="">Tất cả danh mục</option>
                                        <option value="action">Hành động</option>
                                        <option value="adventure">Phiêu lưu</option>
                                        <option value="rpg">RPG</option>
                                        <option value="strategy">Chiến thuật</option>
                                        <option value="simulation">Mô phỏng</option>
                                    </select>
                                </div>
                                <div class="col-md-2">
                                    <select class="form-select" id="publisherFilter">
                                        <option value="">Tất cả nhà phát hành</option>
                                        <!-- Dynamic options -->
                                    </select>
                                </div>
                                <div class="col-md-2">
                                    <select class="form-select" id="statusFilter">
                                        <option value="">Tất cả trạng thái</option>
                                        <option value="approved">Đã duyệt</option>
                                        <option value="pending">Chờ duyệt</option>
                                        <option value="rejected">Từ chối</option>
                                    </select>
                                </div>
                                <div class="col-md-2">
                                    <select class="form-select" id="sortBy">
                                        <option value="name">Tên (A-Z)</option>
                                        <option value="name_desc">Tên (Z-A)</option>
                                        <option value="price">Giá (Thấp-Cao)</option>
                                        <option value="price_desc">Giá (Cao-Thấp)</option>
                                        <option value="downloads">Đánh giá (Nhiều nhất)</option>
                                        <option value="downloads_desc">Đánh giá (Ít nhất)</option>
                                        <option value="date">Ngày (Mới nhất)</option>
                                        <option value="date_desc">Ngày (Cũ nhất)</option>
                                    </select>
                                </div>
                                <div class="col-md-1">
                                    <button class="btn btn-outline-secondary w-100" onclick="resetFilters()">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M20 11a8.1 8.1 0 0 0 -15.5 -2m-.5 -4v4h4" /><path d="M4 13a8.1 8.1 0 0 0 15.5 2m.5 4v-4h-4" /></svg>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Games Table -->
                    <div class="card">
                        <div class="table-responsive">
                            <table class="table card-table table-vcenter text-nowrap datatable" id="gamesTable">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Trò chơi</th>
                                        <th>Nhà phát hành</th>
                                        <th>Danh mục</th>
                                        <th>Phiên bản</th>
                                        <th>Giá</th>
                                        <th>Lượt tải</th>
                                        <th>Trạng thái</th>
                                        <th>Thao tác</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Dynamic content -->
                                </tbody>
                            </table>
                        </div>
                        <div class="card-footer d-flex align-items-center justify-content-center">
                            <ul class="pagination m-0" id="gamesPagination">
                                <!-- Pagination will be generated dynamically -->
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
            
             <footer class="footer footer-transparent d-print-none">
                <div class="container-xl">
                    <div class="row text-center align-items-center flex-row-reverse">
                        <div class="col-12 col-lg-auto mt-3 mt-lg-0">
                            <ul class="list-inline list-inline-dots mb-0">
                                <li class="list-inline-item">
                                    Copyright &copy; 2025
                                    <a href="." class="link-secondary">Game Store</a>.
                                    All rights reserved.
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
            </footer>
        </div>
    </div>



    <!-- Game Details Modal -->
    <div class="modal modal-blur fade" id="gameDetailsModal" tabindex="-1" role="dialog" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Chi tiết trò chơi</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="gameDetailsContent">
                    <!-- Dynamic content -->
                </div>
                <div class="modal-footer">
                    <div class="d-flex w-100 justify-content-between">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                        <div>
                             <button type="button" class="btn btn-primary" onclick="editGame()" id="editBtn">
                                <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M4 20h4l10.5 -10.5a1.5 1.5 0 0 0 -4 -4l-10.5 10.5v4" /><path d="M13.5 6.5l4 4" /></svg>
                                Sửa
                            </button>
                            <button type="button" class="btn btn-danger" onclick="deleteCurrentGame()" id="deleteBtn">
                                <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M4 7l16 0" /><path d="M10 11l0 6" /><path d="M14 11l0 6" /><path d="M5 7l1 12a2 2 0 0 0 2 2h8a2 2 0 0 0 2 -2l1 -12" /><path d="M9 7v-3a1 1 0 0 1 1 -1h4a1 1 0 0 1 1 1v3" /></svg>
                                Xóa
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Game Modal -->
    <div class="modal modal-blur fade" id="editGameModal" tabindex="-1" role="dialog" aria-hidden="true">
        <div class="modal-dialog modal-xl modal-dialog-centered" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Sửa trò chơi</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="editGameForm">
                        <input type="hidden" id="editGameId">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Tên trò chơi</label>
                                    <input type="text" class="form-control" id="editGameName" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Phiên bản</label>
                                    <input type="text" class="form-control" id="editGameVersion">
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">Danh mục</label>
                                    <select class="form-select" id="editGameCategory"></select>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">Giá (VND)</label>
                                    <input type="number" class="form-control" id="editGamePrice" step="1000" required>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">URL Hình ảnh</label>
                                    <input type="text" class="form-control" id="editGameThumbnail">
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Nhà phát triển</label>
                                    <input type="text" class="form-control" id="editGameDeveloper">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Nhà phát hành</label>
                                    <select class="form-select" id="editGamePublisher">
                                        <option value="">Chọn nhà phát hành</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Mô tả</label>
                            <textarea class="form-control" id="editGameDescription" rows="4"></textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Tags (phân cách bằng dấu phẩy)</label>
                            <input type="text" class="form-control" id="editGameTags">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn me-auto" data-bs-dismiss="modal">Hủy</button>
                    <button type="button" class="btn btn-primary" onclick="updateGame()">Lưu thay đổi</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../assets/tabler/js/tabler.min.js"></script>
    <script src="../env.js?v=2"></script>
    <script src="../assets/js/admin/utils.js?v=2"></script>
    <script src="../assets/js/admin/components.js?v=2"></script>
    <script src="../assets/js/toast.js?v=2"></script>
    <script>
        // Ensure ENV is loaded
        if (!window.ENV || !window.ENV.API_URL) {
            document.body.innerHTML = '<div class="alert alert-danger m-5"><h4>Configuration Error</h4><p>ENV not loaded! Make sure env.js is included and API_URL is configured.</p></div>';
            throw new Error('[admin/products.html] ENV not loaded!');
        }
        const API_BASE_URL = window.ENV.API_URL;
        let allGames = [];
        let allCategories = [];
        let allPublishers = [];
        let currentPage = 1;
        let pageSize = 10;
        let currentGameId = null;

        // Initialize page
        document.addEventListener('DOMContentLoaded', async () => {
            const authResult = await AdminUtils.checkAuthentication();
            if (authResult) {
                await AdminComponents.init('products');
                await Promise.all([loadCategories(), loadPublishers(), loadGames()]);
                setupFilters();
            }
        });

        // Load categories for filter and form
        async function loadCategories() {
            try {
                const response = await fetch(`${API_BASE_URL}/categories`, {
                    credentials: 'include',
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
                });
                const result = await response.json();
                if (result.status === 'success') {
                    allCategories = result.data;
                    populateCategoryDropdowns();
                }
            } catch (error) {
                console.error('Error loading categories:', error);
            }
        }

        // Load publishers
        async function loadPublishers() {
            try {
                const response = await fetch(`${API_BASE_URL}/publishers`, {
                    credentials: 'include',
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
                });
                const result = await response.json();
                if (result.status === 'success') {
                    allPublishers = result.data;
                    populatePublisherDropdowns();
                }
            } catch (error) {
                console.error('Error loading publishers:', error);
            }
        }

        function populateCategoryDropdowns() {
            const selectors = ['categoryFilter', 'gameCategory', 'editGameCategory'];
            selectors.forEach(id => {
                const select = document.getElementById(id);
                if (select) {
                    const isFilter = id === 'categoryFilter';
                    select.innerHTML = isFilter ? '<option value="">Tất cả danh mục</option>' : '<option value="">Chọn danh mục</option>';
                    allCategories.forEach(cat => {
                        select.innerHTML += `<option value="${cat.name}">${cat.name}</option>`;
                    });
                }
            });
        }

        // Load games from database
        async function loadGames() {
            try {
                const response = await fetch(`${API_BASE_URL}/games`, {
                    credentials: 'include',
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
                });
                const result = await response.json();
                
                if (result.status === 'success') {
                    allGames = result.data;
                    updateStats();
                    displayGames();
                } else {
                    console.error('Failed to load games:', result.message);
                }
            } catch (error) {
                console.error('Error loading games:', error);
            }
        }

        function populatePublisherDropdowns() {
            // Populate Filter
            const filterSelect = document.getElementById('publisherFilter');
            if (filterSelect) {
                filterSelect.innerHTML = '<option value="">Tất cả nhà phát hành</option>';
                allPublishers.forEach(pub => {
                    filterSelect.innerHTML += `<option value="${pub.uid}">${pub.uname}</option>`;
                });
            }

            // Populate Add Form


            // Populate Edit Form (if needed dynamically, though handled in openEditModal maybe?)
            // We can pre-populate the options, and select the value later
            const editSelect = document.getElementById('editGamePublisher');
            // Check if editGamePublisher is input or select. In HTML it was input text. It should be select.
            // I will change it to select in a separate edit or handle it here if I can change HTML too.
            // The previous HTML view showed it as input type="text". I should change it to select.
        }

        function updateStats() {
            const approved = allGames.filter(g => g.status === 'approved').length;
            const pending = allGames.filter(g => g.status === 'pending').length;
            
            document.getElementById('totalGamesCount').textContent = allGames.length;
            document.getElementById('approvedGamesCount').textContent = approved;
            document.getElementById('pendingGamesCount').textContent = pending;
            
            const totalRevenue = allGames.reduce((sum, game) => sum + (parseFloat(game.price) || 0), 0);
            document.getElementById('totalDownloads').textContent = AdminUtils.formatCurrency(totalRevenue);
        }

        function setupFilters() {
            ['searchGame', 'categoryFilter', 'publisherFilter', 'statusFilter', 'sortBy'].forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.addEventListener('change', () => {
                        currentPage = 1;
                        displayGames();
                    });
                    if (id === 'searchGame') {
                        element.addEventListener('input', () => {
                            currentPage = 1;
                            displayGames();
                        });
                    }
                }
            });
        }

        function resetFilters() {
            document.getElementById('searchGame').value = '';
            document.getElementById('categoryFilter').value = '';
            document.getElementById('publisherFilter').value = '';
            document.getElementById('statusFilter').value = ''; // Reset to show all
            document.getElementById('sortBy').value = 'name';
            currentPage = 1;
            displayGames();
        }

        function getFilteredGames() {
            const searchTerm = document.getElementById('searchGame').value.toLowerCase();
            const category = document.getElementById('categoryFilter').value;
            const publisher = document.getElementById('publisherFilter').value;
            const status = document.getElementById('statusFilter').value;
            const sortBy = document.getElementById('sortBy').value;

            let filtered = allGames.filter(game => {
                const matchSearch = game.name.toLowerCase().includes(searchTerm);
                const matchCategory = !category || game.category === category;
                const matchPublisher = !publisher || game.publisherid == publisher || (game.publisher && game.publisher.toString() === publisher);
                const matchStatus = !status || (game.status || 'pending') === status;
                return matchSearch && matchCategory && matchPublisher && matchStatus;
            });

            // Sorting
            filtered.sort((a, b) => {
                switch(sortBy) {
                    case 'name': return a.name.localeCompare(b.name);
                    case 'name_desc': return b.name.localeCompare(a.name);
                    case 'price': return (parseFloat(a.price) || 0) - (parseFloat(b.price) || 0);
                    case 'price_desc': return (parseFloat(b.price) || 0) - (parseFloat(a.price) || 0);
                    case 'downloads': return (b.reviews || 0) - (a.reviews || 0);
                    case 'downloads_desc': return (a.reviews || 0) - (b.reviews || 0);
                    case 'date': return new Date(b.releaseDate || 0) - new Date(a.releaseDate || 0);
                    case 'date_desc': return new Date(a.releaseDate || 0) - new Date(b.releaseDate || 0);
                    default: return 0;
                }
            });

            return filtered;
        }

        function renderPagination(totalItems) {
            const totalPages = Math.ceil(totalItems / pageSize);
            const pagination = document.getElementById('gamesPagination');
            pagination.innerHTML = '';

            // Previous
            pagination.innerHTML += `
                <li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
                    <a class="page-link" href="#" onclick="changePage(${currentPage - 1})">Trước</a>
                </li>
            `;

            // Pages
            for (let i = 1; i <= totalPages; i++) {
                if (i === 1 || i === totalPages || (i >= currentPage - 2 && i <= currentPage + 2)) {
                    pagination.innerHTML += `
                        <li class="page-item ${currentPage === i ? 'active' : ''}">
                            <a class="page-link" href="#" onclick="changePage(${i})">${i}</a>
                        </li>
                    `;
                } else if (i === currentPage - 3 || i === currentPage + 3) {
                    pagination.innerHTML += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
                }
            }

            // Next
            pagination.innerHTML += `
                <li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
                    <a class="page-link" href="#" onclick="changePage(${currentPage + 1})">Sau</a>
                </li>
            `;
        }

        function changePage(page) {
            const filtered = getFilteredGames(); // Recalculate to get correct total pages
            const totalPages = Math.ceil(filtered.length / pageSize);
            if (page >= 1 && page <= totalPages) {
                currentPage = page;
                displayGames();
            }
        }

        function viewGame(id) {
            const game = allGames.find(g => g.id == id);
            if (!game) return;
            
            currentGameId = id;
            const statusBadges = {
                'active': '<span class="badge bg-success">Hoạt động</span>',
                'approved': '<span class="badge bg-success">Đã duyệt</span>',
                'pending': '<span class="badge bg-warning">Chờ duyệt</span>',
                'rejected': '<span class="badge bg-danger">Từ chối</span>'
            };

             // Get publisher name
             let pubName = game.publisher_name || game.publisher;
             if (!pubName && game.publisherid) {
                 const pub = allPublishers.find(p => p.uid == game.publisherid);
                 pubName = pub ? pub.uname : 'Unknown';
             }

            const content = `
                <div class="row">
                    <div class="col-md-4">
                        <img src="${game.image || 'https://placehold.co/400x300'}" class="img-fluid rounded mb-3" onerror="this.src='https://placehold.co/400x300'">
                        <div class="mb-3">
                            <label class="form-label">Trạng thái</label>
                            <div>${statusBadges[game.status || 'pending'] || statusBadges['pending']}</div>
                        </div>
                    </div>
                    <div class="col-md-8">
                        <h3>${game.name} <span class="badge bg-secondary-lt ms-2">${game.version || '1.0'}</span></h3>
                        <p><strong>Nhà phát hành:</strong> ${pubName || '-'}</p>
                        <p><strong>Nhà phát triển:</strong> ${game.developer || '-'}</p>
                        <p><strong>Danh mục:</strong> ${game.category || '-'}</p>
                        <p><strong>Giá:</strong> ${AdminUtils.formatCurrency(game.price)}</p>
                        <p><strong>Tags:</strong> ${game.tags && Array.isArray(game.tags) ? game.tags.map(t => `<span class="badge bg-blue-lt me-1">${t}</span>`).join('') : '-'}</p>
                        <div class="hr-text">Mô tả</div>
                        <p>${game.description || 'Chưa có mô tả'}</p>
                    </div>
                </div>
            `;
            
            document.getElementById('gameDetailsContent').innerHTML = content;
            new bootstrap.Modal(document.getElementById('gameDetailsModal')).show();
        }

        function openEditModal(id) {
            const game = allGames.find(g => g.id == id);
            if (!game) return;
            
            currentGameId = id;
            document.getElementById('editGameId').value = game.id;
            document.getElementById('editGameName').value = game.name;
            document.getElementById('editGameVersion').value = game.version || '';
            document.getElementById('editGamePrice').value = game.price;
            document.getElementById('editGameThumbnail').value = game.image || '';
            document.getElementById('editGameDeveloper').value = game.developer || '';
            document.getElementById('editGameDescription').value = game.description || '';
            document.getElementById('editGameTags').value = game.tags && Array.isArray(game.tags) ? game.tags.join(', ') : '';
            
            // Set selects
            const pubSelect = document.getElementById('editGamePublisher');
            // Ensure publisher select is populated first if it wasn't
            if (pubSelect.options.length <= 1 && allPublishers.length > 0) {
                 pubSelect.innerHTML = '<option value="">Chọn nhà phát hành</option>';
                 allPublishers.forEach(pub => {
                    pubSelect.innerHTML += `<option value="${pub.uid}">${pub.uname}</option>`;
                });
            }
            pubSelect.value = game.publisherid || '';
            
            const catSelect = document.getElementById('editGameCategory');
            catSelect.value = game.category || '';

            new bootstrap.Modal(document.getElementById('editGameModal')).show();
        }

        function displayGames() {
            const filtered = getFilteredGames();
            const tbody = document.querySelector('#gamesTable tbody');
            
            const startIdx = (currentPage - 1) * pageSize;
            const endIdx = startIdx + pageSize;
            const pageGames = filtered.slice(startIdx, endIdx);

            if (pageGames.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" class="text-center text-muted py-4">Không tìm thấy trò chơi</td></tr>';
                renderPagination(0);
                return;
            }

            tbody.innerHTML = pageGames.map(game => {
                const statusBadges = {
                    'active': '<span class="badge bg-success me-1"></span> Hoạt động',
                    'approved': '<span class="badge bg-success me-1"></span> Đã duyệt',
                    'pending': '<span class="badge bg-warning me-1"></span> Chờ duyệt',
                    'rejected': '<span class="badge bg-danger me-1"></span> Từ chối'
                };
                const status = game.status || 'pending';
                const statusBadge = statusBadges[status] || statusBadges['pending'];

                let actionButtons = `
                    <button class="btn btn-outline-info btn-icon" onclick="viewGame(${game.id})" title="Xem chi tiết">
                        <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M10 12a2 2 0 1 0 4 0a2 2 0 0 0 -4 0" /><path d="M21 12c-2.4 4 -5.4 6 -9 6c-3.6 0 -6.6 -2 -9 -6c2.4 -4 5.4 -6 9 -6c3.6 0 6.6 2 9 6" /></svg>
                    </button>
                    <button class="btn btn-outline-primary btn-icon" onclick="openEditModal(${game.id})" title="Sửa">
                        <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M4 20h4l10.5 -10.5a1.5 1.5 0 0 0 -4 -4l-10.5 10.5v4" /><path d="M13.5 6.5l4 4" /></svg>
                    </button>
                    <button class="btn btn-outline-danger btn-icon" onclick="deleteGame(${game.id})" title="Xóa">
                        <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M4 7l16 0" /><path d="M10 11l0 6" /><path d="M14 11l0 6" /><path d="M5 7l1 12a2 2 0 0 0 2 2h8a2 2 0 0 0 2 -2l1 -12" /><path d="M9 7v-3a1 1 0 0 1 1 -1h4a1 1 0 0 1 1 1v3" /></svg>
                    </button>
                `;

                if (status === 'pending') {
                    actionButtons = `
                        <button class="btn btn-outline-success btn-icon" onclick="updateGameStatus(${game.id}, 'approved')" title="Duyệt">
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M5 12l5 5l10 -10" /></svg>
                        </button>
                        <button class="btn btn-outline-warning btn-icon" onclick="updateGameStatus(${game.id}, 'rejected')" title="Từ chối">
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M18 6l-12 12" /><path d="M6 6l12 12" /></svg>
                        </button>
                        ${actionButtons}
                    `;
                }

                // Get publisher name from object or string
                let pubName = game.publisher_name || game.publisher;
                if (!pubName && game.publisherid) {
                    const pub = allPublishers.find(p => p.uid == game.publisherid);
                    pubName = pub ? pub.uname : 'Unknown';
                }

                return `
                <tr>
                    <td><span class="text-muted">${game.id}</span></td>
                    <td>
                        <div class="d-flex align-items-center">
                            <img src="${game.image || 'https://placehold.co/50'}" 
                                 alt="${game.name}" 
                                 style="width: 40px; height: 40px; object-fit: cover; border-radius: 4px;" 
                                 class="me-2"
                                 onerror="this.src='https://placehold.co/50'">
                            <div class="font-weight-medium">${game.name}</div>
                        </div>
                    </td>
                    <td>${pubName || '-'}</td>
                    <td><span class="badge bg-secondary-lt">${game.category || 'N/A'}</span></td>
                    <td>${game.version || '1.0'}</td>
                    <td>${AdminUtils.formatCurrency(game.price)}</td>
                    <td>${game.reviews || 0}</td>
                    <td>${statusBadge}</td>
                    <td>
                        <div class="btn-list flex-nowrap">
                            ${actionButtons}
                        </div>
                    </td>
                </tr>
            `}).join('');

            renderPagination(filtered.length);
        }

        // ... helpers ...

        // Update game status
        function updateGameStatus(gameId, status) {
            const action = status === 'approved' ? 'duyệt' : 'từ chối';
            Toast.confirm(`Bạn có chắc chắn muốn ${action} trò chơi này?`, async () => {
                try {
                    const response = await fetch(`${API_BASE_URL}/games/${gameId}/status`, {
                        method: 'PATCH',
                        credentials: 'include',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${localStorage.getItem('token')}`
                        },
                        body: JSON.stringify({ status: status })
                    });

                    const result = await response.json();
                    if (result.status === 'success') {
                        Toast.success('Cập nhật trạng thái thành công!');
                        await loadGames();
                    } else {
                        Toast.error('Lỗi: ' + result.message);
                    }
                } catch (error) {
                    console.error('Error updating status:', error);
                    Toast.error('Lỗi cập nhật trạng thái');
                }
            });
        }

        // Delete game
        function deleteGame(gameId) {
            Toast.confirm('Bạn có chắc chắn muốn xóa trò chơi này không?', async () => {
                try {
                    const response = await fetch(`${API_BASE_URL}/games/${gameId}`, {
                        method: 'DELETE',
                        credentials: 'include',
                        headers: {
                            'Authorization': `Bearer ${localStorage.getItem('token')}`
                        }
                    });
                    const result = await response.json();
                    if (result.status === 'success') {
                        Toast.success('Xóa trò chơi thành công!');
                        await loadGames();
                    } else {
                        Toast.error('Xóa thất bại: ' + result.message);
                    }
                } catch (error) {
                    console.error('Error deleting game:', error);
                    Toast.error('Lỗi khi xóa trò chơi');
                }
            });
        }

        // Update game
        async function updateGame() {
            const gameId = document.getElementById('editGameId').value;
            const gameData = {
                name: document.getElementById('editGameName').value,
                version: document.getElementById('editGameVersion').value,
                category: document.getElementById('editGameCategory').value,
                price: parseFloat(document.getElementById('editGamePrice').value),
                thumbnail: document.getElementById('editGameThumbnail').value,
                developer: document.getElementById('editGameDeveloper').value,
                publisherid: document.getElementById('editGamePublisher').value, // Send publisherid
                description: document.getElementById('editGameDescription').value,
                tags: document.getElementById('editGameTags').value.split(',').map(t => t.trim()), // Format tags
                status: 'pending' // Or keep existing? For now let's set to pending on edit for re-review? Or keep?
            };
            
            // Should probably fetch existing status to preserve it or let admin decide. 
            // Simplified: If admin edits, status likely remains unless stated.
            // But we didn't add status field to edit form. 
            // Let's grab the current game object to keep status.
            const currentGame = allGames.find(g => g.id == gameId);
            if (currentGame) {
                gameData.status = currentGame.status;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/games/${gameId}`, {
                    method: 'PUT',
                    credentials: 'include',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: JSON.stringify(gameData)
                });

                const result = await response.json();
                if (result.status === 'success') {
                    Toast.success('Cập nhật trò chơi thành công!');
                    bootstrap.Modal.getInstance(document.getElementById('editGameModal')).hide();
                    await loadGames();
                } else {
                    Toast.error('Cập nhật trò chơi thất bại: ' + result.message);
                }
            } catch (error) {
                console.error('Error updating game:', error);
                Toast.error('Lỗi cập nhật trò chơi');
            }
        }

        // Save new game




        function deleteCurrentGame() {
            if (currentGameId) {
                bootstrap.Modal.getInstance(document.getElementById('gameDetailsModal')).hide();
                deleteGame(currentGameId);
            }
        }

        function editGame() {
            if (currentGameId) {
                bootstrap.Modal.getInstance(document.getElementById('gameDetailsModal')).hide();
                openEditModal(currentGameId);
            }
        }
    </script>
</body>
</html>