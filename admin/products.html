<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Games - NextPlay Admin</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@tabler/core@latest/dist/css/tabler.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@tabler/icons-webfont@latest/dist/tabler-icons.min.css">
    <style>@import url('https://rsms.me/inter/inter.css'); .game-img { width: 80px; height: 45px; object-fit: cover; border-radius: 4px; }</style>
</head>
<body class="layout-fluid">
    <script src="https://cdn.jsdelivr.net/npm/@tabler/core@latest/dist/js/tabler.min.js"></script>
    
    <div class="page">
        <!-- Sidebar -->
        <aside class="navbar navbar-vertical navbar-expand-lg" data-bs-theme="dark">
            <div class="container-fluid">
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#sidebar-menu"><span class="navbar-toggler-icon"></span></button>
                <h1 class="navbar-brand navbar-brand-autodark"><a href="/admin/index.html"><i class="ti ti-device-gamepad-2 me-2"></i><span class="nav-link-title">NextPlay Admin</span></a></h1>
                <div class="collapse navbar-collapse" id="sidebar-menu">
                    <ul class="navbar-nav pt-lg-3">
                        <li class="nav-item"><a class="nav-link" href="/admin/index.html"><span class="nav-link-icon d-md-none d-lg-inline-block"><i class="ti ti-home"></i></span><span class="nav-link-title">Dashboard</span></a></li>
                        <li class="nav-item"><a class="nav-link" href="/admin/users.html"><span class="nav-link-icon d-md-none d-lg-inline-block"><i class="ti ti-users"></i></span><span class="nav-link-title">Users</span></a></li>
                        <li class="nav-item"><a class="nav-link" href="/admin/admin-users.html"><span class="nav-link-icon d-md-none d-lg-inline-block"><i class="ti ti-shield-check"></i></span><span class="nav-link-title">Admins</span></a></li>
                        <li class="nav-item"><a class="nav-link active" href="/admin/products.html"><span class="nav-link-icon d-md-none d-lg-inline-block"><i class="ti ti-device-gamepad-2"></i></span><span class="nav-link-title">Games</span></a></li>
                        <li class="nav-item"><a class="nav-link" href="/admin/orders.html"><span class="nav-link-icon d-md-none d-lg-inline-block"><i class="ti ti-shopping-cart"></i></span><span class="nav-link-title">Orders</span></a></li>
                        <li class="nav-item"><a class="nav-link" href="/admin/comments.html"><span class="nav-link-icon d-md-none d-lg-inline-block"><i class="ti ti-message-circle"></i></span><span class="nav-link-title">Reviews</span></a></li>
                        <li class="nav-item"><a class="nav-link" href="/admin/contacts.html"><span class="nav-link-icon d-md-none d-lg-inline-block"><i class="ti ti-building"></i></span><span class="nav-link-title">Publishers</span></a></li>
                        <li class="nav-item"><a class="nav-link" href="/admin/posts.html"><span class="nav-link-icon d-md-none d-lg-inline-block"><i class="ti ti-category"></i></span><span class="nav-link-title">Categories</span></a></li>
                        <li class="nav-item"><a class="nav-link" href="/admin/faqs.html"><span class="nav-link-icon d-md-none d-lg-inline-block"><i class="ti ti-help"></i></span><span class="nav-link-title">FAQs</span></a></li>
                        <li class="nav-item"><a class="nav-link" href="/admin/news.html"><span class="nav-link-icon d-md-none d-lg-inline-block"><i class="ti ti-news"></i></span><span class="nav-link-title">News</span></a></li>
                        <li class="nav-item"><a class="nav-link" href="/admin/feedback.html"><span class="nav-link-icon d-md-none d-lg-inline-block"><i class="ti ti-star"></i></span><span class="nav-link-title">Feedback</span></a></li>
                        <li class="nav-item"><a class="nav-link" href="/admin/settings.html"><span class="nav-link-icon d-md-none d-lg-inline-block"><i class="ti ti-settings"></i></span><span class="nav-link-title">Settings</span></a></li>
                        <li class="nav-item mt-auto"><a class="nav-link text-danger" href="#" onclick="logout()"><span class="nav-link-icon d-md-none d-lg-inline-block"><i class="ti ti-logout"></i></span><span class="nav-link-title">Logout</span></a></li>
                    </ul>
                </div>
            </div>
        </aside>

        <div class="page-wrapper">
            <header class="navbar navbar-expand-md d-none d-lg-flex d-print-none">
                <div class="container-xl">
                    <div class="navbar-nav flex-row order-md-last">
                        <div class="d-none d-md-flex me-3"><a href="/" class="nav-link px-0"><i class="ti ti-home"></i></a></div>
                        <div class="nav-item dropdown">
                            <a href="#" class="nav-link d-flex lh-1 text-reset p-0" data-bs-toggle="dropdown">
                                <span class="avatar avatar-sm bg-primary" id="userAvatar">A</span>
                                <div class="d-none d-xl-block ps-2"><div id="userName">Admin</div><div class="mt-1 small text-muted">Administrator</div></div>
                            </a>
                            <div class="dropdown-menu dropdown-menu-end dropdown-menu-arrow">
                                <a href="/admin/settings.html" class="dropdown-item"><i class="ti ti-settings me-2"></i> Settings</a>
                                <div class="dropdown-divider"></div>
                                <a href="#" class="dropdown-item text-danger" onclick="logout()"><i class="ti ti-logout me-2"></i> Logout</a>
                            </div>
                        </div>
                    </div>
                </div>
            </header>

            <div class="page-header d-print-none">
                <div class="container-xl">
                    <div class="row align-items-center">
                        <div class="col-auto">
                            <div class="page-pretitle">Management</div>
                            <h2 class="page-title">Games</h2>
                        </div>
                        <div class="col-auto ms-auto">
                            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addGameModal">
                                <i class="ti ti-plus me-2"></i> Add Game
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="page-body">
                <div class="container-xl">
                    <!-- Stats -->
                    <div class="row row-deck row-cards mb-3">
                        <div class="col-sm-6 col-lg-3">
                            <div class="card card-sm">
                                <div class="card-body">
                                    <div class="row align-items-center">
                                        <div class="col-auto"><span class="bg-primary text-white avatar"><i class="ti ti-device-gamepad-2"></i></span></div>
                                        <div class="col"><div class="font-weight-medium" id="totalGames">0</div><div class="text-muted">Total Games</div></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-sm-6 col-lg-3">
                            <div class="card card-sm">
                                <div class="card-body">
                                    <div class="row align-items-center">
                                        <div class="col-auto"><span class="bg-green text-white avatar"><i class="ti ti-check"></i></span></div>
                                        <div class="col"><div class="font-weight-medium" id="activeGames">0</div><div class="text-muted">Active</div></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-sm-6 col-lg-3">
                            <div class="card card-sm">
                                <div class="card-body">
                                    <div class="row align-items-center">
                                        <div class="col-auto"><span class="bg-yellow text-white avatar"><i class="ti ti-tag"></i></span></div>
                                        <div class="col"><div class="font-weight-medium" id="onSaleGames">0</div><div class="text-muted">On Sale</div></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-sm-6 col-lg-3">
                            <div class="card card-sm">
                                <div class="card-body">
                                    <div class="row align-items-center">
                                        <div class="col-auto"><span class="bg-azure text-white avatar"><i class="ti ti-category"></i></span></div>
                                        <div class="col"><div class="font-weight-medium" id="totalCategories">0</div><div class="text-muted">Categories</div></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Filters -->
                    <div class="card mb-3">
                        <div class="card-body">
                            <div class="row g-3">
                                <div class="col-md-4">
                                    <div class="input-icon">
                                        <span class="input-icon-addon"><i class="ti ti-search"></i></span>
                                        <input type="text" class="form-control" id="searchGame" placeholder="Search games...">
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <select class="form-select" id="categoryFilter">
                                        <option value="">All Categories</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <select class="form-select" id="publisherFilter">
                                        <option value="">All Publishers</option>
                                    </select>
                                </div>
                                <div class="col-md-2">
                                    <button class="btn btn-secondary w-100" onclick="resetFilters()"><i class="ti ti-refresh me-1"></i> Reset</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Games Table -->
                    <div class="card">
                        <div class="card-header"><h3 class="card-title">Games List</h3></div>
                        <div class="table-responsive">
                            <table class="table table-vcenter card-table table-striped">
                                <thead>
                                    <tr>
                                        <th>Game</th>
                                        <th>Category</th>
                                        <th>Publisher</th>
                                        <th>Price</th>
                                        <th>Status</th>
                                        <th class="w-1">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="gamesTableBody">
                                    <tr><td colspan="6" class="text-center text-muted">Loading...</td></tr>
                                </tbody>
                            </table>
                        </div>
                        <div class="card-footer d-flex align-items-center">
                            <p class="m-0 text-muted">Showing <span id="showingFrom">0</span> to <span id="showingTo">0</span> of <span id="totalEntries">0</span></p>
                            <ul class="pagination m-0 ms-auto" id="pagination"></ul>
                        </div>
                    </div>
                </div>
            </div>

            <footer class="footer footer-transparent d-print-none">
                <div class="container-xl"><div class="text-center">Copyright &copy; 2024 NextPlay.</div></div>
            </footer>
        </div>
    </div>

    <!-- Add Game Modal -->
    <div class="modal modal-blur fade" id="addGameModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header"><h5 class="modal-title">Add New Game</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
                <div class="modal-body">
                    <form id="addGameForm">
                        <div class="row mb-3">
                            <div class="col-md-8"><label class="form-label">Game Name</label><input type="text" class="form-control" name="name" required></div>
                            <div class="col-md-4"><label class="form-label">Category</label><select class="form-select" name="category" id="addCategorySelect" required></select></div>
                        </div>
                        <div class="mb-3"><label class="form-label">Description</label><textarea class="form-control" name="description" rows="3"></textarea></div>
                        <div class="row mb-3">
                            <div class="col-md-4"><label class="form-label">Price (₫)</label><input type="number" class="form-control" name="price" required></div>
                            <div class="col-md-4"><label class="form-label">Discount (%)</label><input type="number" class="form-control" name="discount" value="0" min="0" max="100"></div>
                            <div class="col-md-4"><label class="form-label">Publisher</label><select class="form-select" name="publisher" id="addPublisherSelect"></select></div>
                        </div>
                        <div class="mb-3"><label class="form-label">Image URL</label><input type="url" class="form-control" name="image"></div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="addGame()">Add Game</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Game Modal -->
    <div class="modal modal-blur fade" id="editGameModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header"><h5 class="modal-title">Edit Game</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
                <div class="modal-body">
                    <form id="editGameForm">
                        <input type="hidden" name="id" id="editGameId">
                        <div class="row mb-3">
                            <div class="col-md-8"><label class="form-label">Game Name</label><input type="text" class="form-control" name="name" id="editGameName" required></div>
                            <div class="col-md-4"><label class="form-label">Category</label><select class="form-select" name="category" id="editCategorySelect" required></select></div>
                        </div>
                        <div class="mb-3"><label class="form-label">Description</label><textarea class="form-control" name="description" id="editDescription" rows="3"></textarea></div>
                        <div class="row mb-3">
                            <div class="col-md-4"><label class="form-label">Price (₫)</label><input type="number" class="form-control" name="price" id="editPrice" required></div>
                            <div class="col-md-4"><label class="form-label">Discount (%)</label><input type="number" class="form-control" name="discount" id="editDiscount" min="0" max="100"></div>
                            <div class="col-md-4"><label class="form-label">Publisher</label><select class="form-select" name="publisher" id="editPublisherSelect"></select></div>
                        </div>
                        <div class="mb-3"><label class="form-label">Image URL</label><input type="url" class="form-control" name="image" id="editImage"></div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="updateGame()">Save Changes</button>
                </div>
            </div>
        </div>
    </div>

    <script src="../env.js"></script>
    <script>
        if (!window.ENV?.API_URL) { document.body.innerHTML = '<div class="container mt-5"><div class="alert alert-danger">ENV not loaded!</div></div>'; throw new Error('ENV not loaded!'); }
        
        const API_BASE_URL = window.ENV.API_URL;
        let allGames = [], categories = [], publishers = [];
        let currentPage = 1;
        const itemsPerPage = 10;

        function logout() { fetch(`${API_BASE_URL}/users/logout`, { method: 'POST', credentials: 'include' }).finally(() => window.location.href = '/auth/login.html'); }
        function formatCurrency(amt) { return new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(amt || 0); }

        async function loadData() {
            try {
                const [gamesRes, catsRes, pubsRes] = await Promise.all([
                    fetch(`${API_BASE_URL}/games`, { credentials: 'include' }),
                    fetch(`${API_BASE_URL}/categories`, { credentials: 'include' }),
                    fetch(`${API_BASE_URL}/publishers`, { credentials: 'include' })
                ]);
                
                const gamesData = await gamesRes.json();
                const catsData = await catsRes.json();
                const pubsData = await pubsRes.json();

                if (gamesData.status === 'success') allGames = gamesData.data;
                if (catsData.status === 'success') categories = catsData.data;
                if (pubsData.status === 'success') publishers = pubsData.data;

                updateStats();
                populateFilters();
                renderGames();
            } catch (error) { console.error('Error loading data:', error); }
        }

        function updateStats() {
            document.getElementById('totalGames').textContent = allGames.length;
            document.getElementById('activeGames').textContent = allGames.length;
            document.getElementById('onSaleGames').textContent = allGames.filter(g => g.discount > 0).length;
            document.getElementById('totalCategories').textContent = categories.length;
        }

        function populateFilters() {
            const catFilter = document.getElementById('categoryFilter');
            const pubFilter = document.getElementById('publisherFilter');
            const addCat = document.getElementById('addCategorySelect');
            const editCat = document.getElementById('editCategorySelect');
            const addPub = document.getElementById('addPublisherSelect');
            const editPub = document.getElementById('editPublisherSelect');

            const catOptions = '<option value="">All Categories</option>' + categories.map(c => `<option value="${c.name}">${c.name}</option>`).join('');
            const pubOptions = '<option value="">All Publishers</option>' + publishers.map(p => `<option value="${p.uname}">${p.uname}</option>`).join('');

            catFilter.innerHTML = catOptions;
            addCat.innerHTML = categories.map(c => `<option value="${c.name}">${c.name}</option>`).join('');
            editCat.innerHTML = addCat.innerHTML;
            pubFilter.innerHTML = pubOptions;
            addPub.innerHTML = publishers.map(p => `<option value="${p.uname}">${p.uname}</option>`).join('');
            editPub.innerHTML = addPub.innerHTML;
        }

        function renderGames() {
            const tbody = document.getElementById('gamesTableBody');
            const search = document.getElementById('searchGame').value.toLowerCase();
            const catFilter = document.getElementById('categoryFilter').value;
            const pubFilter = document.getElementById('publisherFilter').value;

            let filtered = allGames.filter(g => {
                const matchSearch = (g.name || '').toLowerCase().includes(search);
                const matchCat = !catFilter || g.category === catFilter;
                const matchPub = !pubFilter || g.publisher === pubFilter;
                return matchSearch && matchCat && matchPub;
            });

            const totalPages = Math.ceil(filtered.length / itemsPerPage);
            const start = (currentPage - 1) * itemsPerPage;
            const paginated = filtered.slice(start, start + itemsPerPage);

            document.getElementById('showingFrom').textContent = filtered.length ? start + 1 : 0;
            document.getElementById('showingTo').textContent = Math.min(start + itemsPerPage, filtered.length);
            document.getElementById('totalEntries').textContent = filtered.length;

            if (paginated.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">No games found</td></tr>';
                return;
            }

            tbody.innerHTML = paginated.map(game => {
                const finalPrice = game.discount ? game.price * (1 - game.discount/100) : game.price;
                
                return `
                <tr>
                    <td>
                        <div class="d-flex align-items-center">
                            <img src="${game.image || '/assets/images/placeholder.jpg'}" class="game-img me-2" onerror="this.src='/assets/images/placeholder.jpg'">
                            <div>
                                <div class="font-weight-medium">${game.name || 'N/A'}</div>
                                <div class="text-muted small">ID: ${game.id}</div>
                            </div>
                        </div>
                    </td>
                    <td><span class="badge bg-azure-lt">${game.category || 'N/A'}</span></td>
                    <td>${game.publisher || 'N/A'}</td>
                    <td>
                        ${game.discount > 0 ? `
                            <span class="text-muted text-decoration-line-through small">${formatCurrency(game.price)}</span><br>
                            <span class="text-green">${formatCurrency(finalPrice)}</span>
                            <span class="badge bg-red-lt">-${game.discount}%</span>
                        ` : formatCurrency(game.price)}
                    </td>
                    <td><span class="badge bg-success">Active</span></td>
                    <td>
                        <div class="btn-list flex-nowrap">
                            <button class="btn btn-sm btn-primary" onclick="editGame(${game.id})"><i class="ti ti-edit"></i></button>
                            <button class="btn btn-sm btn-danger" onclick="deleteGame(${game.id})"><i class="ti ti-trash"></i></button>
                        </div>
                    </td>
                </tr>`;
            }).join('');

            renderPagination(totalPages);
        }

        function renderPagination(totalPages) {
            const pagination = document.getElementById('pagination');
            let html = `<li class="page-item ${currentPage === 1 ? 'disabled' : ''}"><a class="page-link" href="#" onclick="goToPage(${currentPage - 1})"><i class="ti ti-chevron-left"></i></a></li>`;
            for (let i = 1; i <= Math.min(totalPages, 5); i++) {
                html += `<li class="page-item ${currentPage === i ? 'active' : ''}"><a class="page-link" href="#" onclick="goToPage(${i})">${i}</a></li>`;
            }
            html += `<li class="page-item ${currentPage === totalPages ? 'disabled' : ''}"><a class="page-link" href="#" onclick="goToPage(${currentPage + 1})"><i class="ti ti-chevron-right"></i></a></li>`;
            pagination.innerHTML = html;
        }

        function goToPage(page) { currentPage = page; renderGames(); }
        function resetFilters() {
            document.getElementById('searchGame').value = '';
            document.getElementById('categoryFilter').value = '';
            document.getElementById('publisherFilter').value = '';
            currentPage = 1;
            renderGames();
        }

        async function addGame() {
            const form = document.getElementById('addGameForm');
            const data = Object.fromEntries(new FormData(form));
            try {
                const res = await fetch(`${API_BASE_URL}/games`, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    credentials: 'include', body: JSON.stringify(data)
                });
                const result = await res.json();
                if (result.status === 'success') {
                    bootstrap.Modal.getInstance(document.getElementById('addGameModal')).hide();
                    form.reset(); loadData(); alert('Game added!');
                } else alert(result.message || 'Error');
            } catch (e) { console.error(e); alert('Error adding game'); }
        }

        function editGame(id) {
            const game = allGames.find(g => g.id === id);
            if (!game) return;
            document.getElementById('editGameId').value = game.id;
            document.getElementById('editGameName').value = game.name || '';
            document.getElementById('editCategorySelect').value = game.category || '';
            document.getElementById('editDescription').value = game.description || '';
            document.getElementById('editPrice').value = game.price || 0;
            document.getElementById('editDiscount').value = game.discount || 0;
            document.getElementById('editPublisherSelect').value = game.publisher || '';
            document.getElementById('editImage').value = game.image || '';
            new bootstrap.Modal(document.getElementById('editGameModal')).show();
        }

        async function updateGame() {
            const form = document.getElementById('editGameForm');
            const data = Object.fromEntries(new FormData(form));
            try {
                const res = await fetch(`${API_BASE_URL}/games/${data.id}`, {
                    method: 'PUT', headers: { 'Content-Type': 'application/json' },
                    credentials: 'include', body: JSON.stringify(data)
                });
                const result = await res.json();
                if (result.status === 'success') {
                    bootstrap.Modal.getInstance(document.getElementById('editGameModal')).hide();
                    loadData(); alert('Game updated!');
                } else alert(result.message || 'Error');
            } catch (e) { console.error(e); alert('Error updating game'); }
        }

        async function deleteGame(gid) {
            if (!confirm('Delete this game?')) return;
            try {
                const res = await fetch(`${API_BASE_URL}/games/${gid}`, { method: 'DELETE', credentials: 'include' });
                const result = await res.json();
                if (result.status === 'success') { loadData(); alert('Game deleted!'); }
                else alert(result.message || 'Error');
            } catch (e) { console.error(e); alert('Error deleting game'); }
        }

        document.getElementById('searchGame').addEventListener('input', () => { currentPage = 1; renderGames(); });
        document.getElementById('categoryFilter').addEventListener('change', () => { currentPage = 1; renderGames(); });
        document.getElementById('publisherFilter').addEventListener('change', () => { currentPage = 1; renderGames(); });

        document.addEventListener('DOMContentLoaded', loadData);
    </script>
</body>
</html>
