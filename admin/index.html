<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NextPlay - Trang quản trị</title>
    <!-- Tabler Core -->
    <link href="../assets/tabler/css/tabler.min.css" rel="stylesheet"/>
    <link href="../assets/tabler/css/tabler-flags.min.css" rel="stylesheet"/>
    <link href="../assets/tabler/css/tabler-payments.min.css" rel="stylesheet"/>
    <link href="../assets/tabler/css/tabler-vendors.min.css" rel="stylesheet"/>
    <link href="../assets/tabler/css/tabler-vendors.min.css" rel="stylesheet"/>
    <style>
      @import url('https://rsms.me/inter/inter.css');
      :root {
      	--tblr-font-sans-serif: 'Inter Var', -apple-system, BlinkMacSystemFont, San Francisco, Segoe UI, Roboto, Helvetica Neue, sans-serif;
      }
      body {
      	font-feature-settings: "cv03", "cv04", "cv11";
      }
    </style>
</head>
<body>
    <script src="../assets/tabler/js/tabler-theme.min.js"></script>
    <div class="page">
        <!-- Sidebar -->
        <div id="sidebarContainer"></div>

        <div class="page-wrapper">
            <!-- Navbar -->
            <div id="navbarContainer"></div>

            <!-- Page Header -->
            <div class="page-header d-print-none">
                <div class="container-xl">
                    <div class="row g-2 align-items-center">
                        <div class="col">
                            <div class="page-pretitle">
                                Tổng quan
                            </div>
                            <h2 class="page-title">
                                Bảng điều khiển
                            </h2>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Page Body -->
            <div class="page-body">
                <div class="container-xl">
                    <!-- Stats Cards -->
                    <div class="row row-deck row-cards mb-4">
                        <div class="col-sm-6 col-lg-3">
                            <div class="card">
                                <div class="card-body">
                                    <div class="d-flex align-items-center">
                                        <div class="subheader">Tổng người dùng</div>
                                    </div>
                                    <div class="h1 mb-3" id="totalUsers">...</div>
                                    <div class="d-flex mb-2">
                                        <div>Người dùng đang hoạt động</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-sm-6 col-lg-3">
                            <div class="card">
                                <div class="card-body">
                                    <div class="d-flex align-items-center">
                                        <div class="subheader">Tổng trò chơi</div>
                                    </div>
                                    <div class="h1 mb-3" id="totalGames">...</div>
                                    <div class="d-flex mb-2">
                                        <div>Trò chơi trong kho</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-sm-6 col-lg-3">
                            <div class="card">
                                <div class="card-body">
                                    <div class="d-flex align-items-center">
                                        <div class="subheader">Đơn hàng hoàn thành</div>
                                    </div>
                                    <div class="h1 mb-3" id="totalOrders">...</div>
                                    <div class="d-flex mb-2">
                                        <div>Đã xử lý thành công</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-sm-6 col-lg-3">
                            <div class="card">
                                <div class="card-body">
                                    <div class="d-flex align-items-center">
                                        <div class="subheader">Doanh thu</div>
                                    </div>
                                    <div class="h1 mb-3" id="totalRevenue">...</div>
                                    <div class="d-flex mb-2">
                                        <div>Tổng thu nhập</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Charts Row -->
                    <div class="row row-cards mb-4">
                        <div class="col-lg-8">
                            <div class="card">
                                <div class="card-header">
                                    <h3 class="card-title">Phân tích đánh giá</h3>
                                </div>
                                <div class="card-body">
                                    <canvas id="salesChart" height="300"></canvas>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-4">
                            <div class="card">
                                <div class="card-header">
                                    <h3 class="card-title">Danh mục phổ biến</h3>
                                </div>
                                <div class="card-body">
                                    <canvas id="categoryChart" height="300"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Tables Row -->
                    <div class="row row-cards">
                        <div class="col-lg-6">
                            <div class="card">
                                <div class="card-header">
                                    <h3 class="card-title">Đơn hàng gần đây</h3>
                                </div>
                                <div class="table-responsive">
                                    <table class="table card-table table-vcenter text-nowrap datatable">
                                        <thead>
                                            <tr>
                                                <th>Mã đơn</th>
                                                <th>Khách hàng</th>
                                                <th>Sản phẩm</th>
                                                <th>Tổng tiền</th>
                                                <th>Trạng thái</th>
                                            </tr>
                                        </thead>
                                        <tbody id="recentOrdersBody">
                                            <!-- Dynamic content -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-6">
                            <div class="card">
                                <div class="card-header">
                                    <h3 class="card-title">Đánh giá gần đây</h3>
                                </div>
                                <div class="table-responsive">
                                    <table class="table card-table table-vcenter text-nowrap datatable">
                                        <thead>
                                            <tr>
                                                <th>Trò chơi</th>
                                                <th>Khách hàng</th>
                                                <th>Điểm</th>
                                                <th>Ngày</th>
                                            </tr>
                                        </thead>
                                        <tbody id="recentReviewsBody">
                                            <!-- Dynamic content -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <footer class="footer footer-transparent d-print-none">
                <div class="container-xl">
                    <div class="row text-center align-items-center flex-row-reverse">
                        <div class="col-12 col-lg-auto mt-3 mt-lg-0">
                            <ul class="list-inline list-inline-dots mb-0">
                                <li class="list-inline-item">
                                    Copyright &copy; 2025
                                    <a href="." class="link-secondary">NextPlay</a>.
                                    All rights reserved.
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
            </footer>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../assets/tabler/js/tabler.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="../env.js?v=2"></script>
    <script src="../assets/js/admin/utils.js?v=3"></script>
    <script src="../assets/js/admin/components.js?v=4"></script>
    <script>
        // Ensure ENV is loaded
        if (!window.ENV || !window.ENV.API_URL) {
            document.body.innerHTML = '<div class="alert alert-danger m-5"><h4>Configuration Error</h4><p>ENV not loaded! Make sure env.js is included and API_URL is configured.</p></div>';
            throw new Error('[admin/index.html] ENV not loaded!');
        }
        const API_BASE_URL = window.ENV.API_URL;
        
        // Dashboard Manager Class
        class DashboardManager {
            async init() {
                // Initialize components first
                await AdminComponents.init('dashboard');
                
                // Load dashboard data
                await this.loadStats();
                await this.loadRecentOrders();
                await this.loadRecentReviews();
                this.initCharts();
            }

            async loadStats() {
                try {
                    // Fetch users and games (valid endpoints)
                    const [usersResponse, gamesResponse] = await Promise.all([
                        fetch(`${API_BASE_URL}/users`, {
                            credentials: 'include',
                            headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
                        }),
                        fetch(`${API_BASE_URL}/games`, {
                            credentials: 'include',
                            headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
                        })
                    ]);

                    const usersResult = await usersResponse.json();
                    const gamesResult = await gamesResponse.json();

                    const userCount = usersResult.status === 'success' ? usersResult.data.length : 0;
                    const gameCount = gamesResult.status === 'success' ? gamesResult.data.length : 0;
                    
                    // Mock data for Orders and Revenue (endpoints not available)
                    const totalRevenue = 45000000; 
                    const totalOrders = 125;

                    document.getElementById('totalUsers').textContent = userCount.toLocaleString('vi-VN');
                    document.getElementById('totalGames').textContent = gameCount.toLocaleString('vi-VN');
                    document.getElementById('totalOrders').textContent = totalOrders.toLocaleString('vi-VN');
                    document.getElementById('totalRevenue').textContent = AdminUtils.formatCurrency(totalRevenue);
                } catch (error) {
                    console.error('Error loading stats:', error);
                    document.getElementById('totalUsers').textContent = '0';
                    document.getElementById('totalGames').textContent = '0';
                    document.getElementById('totalOrders').textContent = '0';
                    document.getElementById('totalRevenue').textContent = '₫0';
                }
            }

            initCharts() {
                this.initSalesChart();
                this.initCategoryChart();
            }

            async initSalesChart() {
                const ctx = document.getElementById('salesChart').getContext('2d');
                
                // Mock data for sales chart (until backend supports stats)
                const labels = ['T7', 'T8', 'T9', 'T10', 'T11', 'T12'];
                const data = [15, 23, 18, 28, 25, 30]; 
                
                new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Đánh giá',
                            data: data,
                            borderColor: 'rgb(32, 107, 196)',
                            backgroundColor: 'rgba(32, 107, 196, 0.1)',
                            tension: 0.3,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false }
                        },
                        scales: {
                            y: { beginAtZero: true, grid: { color: 'rgba(0,0,0,0.05)' } },
                            x: { grid: { display: false } }
                        }
                    }
                });
            }

            async initCategoryChart() {
                const ctx = document.getElementById('categoryChart').getContext('2d');
                
                try {
                    // Fetch games to count by category which is a valid usage of /games endpoint
                    const response = await fetch(`${API_BASE_URL}/games`, {
                        credentials: 'include',
                        headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
                    });
                    const result = await response.json();
                    
                    let labels = ['Hành động', 'Nhập vai', 'Phiêu lưu', 'Indie', 'MOBA'];
                    let data = [5, 5, 3, 4, 2];
                    
                    if (result.status === 'success' && result.data) {
                        // Count games by category
                        const categoryCount = {};
                        result.data.forEach(game => {
                            const cat = game.category || 'Khác';
                            categoryCount[cat] = (categoryCount[cat] || 0) + 1;
                        });
                        
                        // Sort by count and take top 5
                        const sorted = Object.entries(categoryCount)
                            .sort((a, b) => b[1] - a[1])
                            .slice(0, 5);
                        
                        labels = sorted.map(([cat]) => cat);
                        data = sorted.map(([, count]) => count);
                    }
                    
                    new Chart(ctx, {
                        type: 'doughnut',
                        data: {
                            labels: labels,
                            datasets: [{
                                data: data,
                                backgroundColor: [
                                    '#206bc4',
                                    '#4299e1',
                                    '#66b2ff',
                                    '#9dcfff',
                                    '#ccebff'
                                ]
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: { position: 'bottom' }
                            }
                        }
                    });
                } catch (error) {
                    console.error('Error loading category chart:', error);
                }
            }

            async loadRecentOrders() {
                // Mock Orders (Endpoint unavailable)
                const tbody = document.getElementById('recentOrdersBody');
                if (tbody) {
                    // Use mock data to show UI
                    const mockOrders = [
                        { uid: 'ORD001', fname: 'Nguyễn', lname: 'Văn A', item_count: 2, total_amount: 1500000 },
                        { uid: 'ORD002', fname: 'Trần', lname: 'Thị B', item_count: 1, total_amount: 750000 },
                        { uid: 'ORD003', fname: 'Lê', lname: 'Hoàng C', item_count: 3, total_amount: 2200000 },
                    ];
                    
                    tbody.innerHTML = mockOrders.map(order => `
                        <tr>
                            <td><span class="text-muted">#${order.uid}</span></td>
                            <td>${order.fname} ${order.lname}</td>
                            <td>${order.item_count} món</td>
                            <td>${AdminUtils.formatCurrency(order.total_amount)}</td>
                            <td>
                                <span class="badge bg-success me-1"></span> Hoàn thành
                            </td>
                        </tr>
                    `).join('');
                }
            }

            async loadRecentReviews() {
                // Mock Reviews (Endpoint unavailable)
                 const tbody = document.getElementById('recentReviewsBody');
                 if (tbody) {
                     const mockReviews = [
                         { game_name: 'Elden Ring', uname: 'Gamer123', rating: 5, review_time: new Date().toISOString() },
                         { game_name: 'FIFA 23', uname: 'PlayerOne', rating: 4, review_time: new Date().toISOString() }
                     ];

                     tbody.innerHTML = mockReviews.map(review => `
                         <tr>
                             <td>${review.game_name}</td>
                             <td>${review.uname}</td>
                             <td>
                                 <div class="text-warning">
                                     ${'★'.repeat(review.rating)}${'☆'.repeat(5 - review.rating)}
                                 </div>
                             </td>
                             <td>${AdminUtils.formatDate(review.review_time)}</td>
                         </tr>
                     `).join('');
                 }
            }
        }

        // Initialize dashboard when DOM is loaded
        document.addEventListener('DOMContentLoaded', async () => {
            // Check authentication first
            const authResult = await AdminUtils.checkAuthentication();
            if (authResult) {
                const dashboard = new DashboardManager();
                dashboard.init();
            }
        });
    </script>
</body>
</html>

