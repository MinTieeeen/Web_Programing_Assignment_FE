<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Game Store - Admin Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.2/font/bootstrap-icons.css" rel="stylesheet">
    <link href="../assets/css/admin-dashboard.css" rel="stylesheet">
</head>
<body>
    <!-- Sidebar Container -->
    <div id="sidebarContainer">
        <!-- Sidebar will be loaded here -->
    </div>

    <!-- Main Content -->
    <div class="main-content" id="main-content">
        <!-- Navbar Container -->
        <div id="navbarContainer">
            <!-- Navbar will be loaded here -->
        </div>

        <!-- Dashboard Content -->
        <div class="container-fluid p-4">
            <!-- Stats Cards -->
            <div class="row mb-4">
                <div class="col-xl-3 col-md-6">
                    <div class="card stats-card bg-primary text-white">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h5 class="card-title">Total Users</h5>
                                    <h3 id="totalUsers">1,234</h3>
                                </div>
                                <div class="stats-icon">
                                    <i class="bi bi-people fs-1"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-xl-3 col-md-6">
                    <div class="card stats-card bg-success text-white">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h5 class="card-title">Total Games</h5>
                                    <h3 id="totalGames">567</h3>
                                </div>
                                <div class="stats-icon">
                                    <i class="bi bi-joystick fs-1"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-xl-3 col-md-6">
                    <div class="card stats-card bg-warning text-white">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h5 class="card-title">Total Orders</h5>
                                    <h3 id="totalOrders">2,890</h3>
                                </div>
                                <div class="stats-icon">
                                    <i class="bi bi-cart3 fs-1"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-xl-3 col-md-6">
                    <div class="card stats-card bg-info text-white">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h5 class="card-title">Revenue</h5>
                                    <h3 id="totalRevenue">$45,230</h3>
                                </div>
                                <div class="stats-icon">
                                    <i class="bi bi-currency-dollar fs-1"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Charts Row -->
            <div class="row mb-4">
                <div class="col-xl-8">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">Sales Analytics</h5>
                        </div>
                        <div class="card-body">
                            <canvas id="salesChart" width="400" height="200"></canvas>
                        </div>
                    </div>
                </div>
                <div class="col-xl-4">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">Popular Categories</h5>
                        </div>
                        <div class="card-body">
                            <canvas id="categoryChart" width="400" height="200"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tables Row -->
            <div class="row">
                <div class="col-xl-6">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">Recent Orders</h5>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>Order ID</th>
                                            <th>Customer</th>
                                            <th>Game</th>
                                            <th>Amount</th>
                                            <th>Status</th>
                                        </tr>
                                    </thead>
                                    <tbody id="recentOrdersBody">
                                        <!-- Dynamic content -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-xl-6">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">Recent Reviews</h5>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>Game</th>
                                            <th>Customer</th>
                                            <th>Rating</th>
                                            <th>Date</th>
                                        </tr>
                                    </thead>
                                    <tbody id="recentReviewsBody">
                                        <!-- Dynamic content -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="../assets/js/admin-utils.js"></script>
    <script src="../assets/js/admin-components.js"></script>
    <script>
        // Dashboard Manager Class
        class DashboardManager {
            async init() {
                // Initialize components first
                await AdminComponents.init('dashboard');
                
                // Load dashboard data
                this.loadStats();
                this.initCharts();
                this.loadRecentOrders();
                this.loadRecentReviews();
            }

            async loadStats() {
                try {
                    // Fetch users data
                    const usersResponse = await fetch('/Assignment/NextPlay/users');
                    const usersResult = await usersResponse.json();
                    const users = usersResult.status === 'success' ? usersResult.data : [];
                    
                    // Fetch games data
                    const gamesResponse = await fetch('/Assignment/NextPlay/games');
                    const gamesResult = await gamesResponse.json();
                    const games = gamesResult.status === 'success' ? gamesResult.data : [];
                    
                    // For orders, we'll use a placeholder count since there's no orders endpoint yet
                    const orders = []; // TODO: Replace when orders endpoint is available
                    
                    const totalRevenue = orders.reduce((sum, order) => sum + parseFloat(order.amount || 0), 0);

                    document.getElementById('totalUsers').textContent = users.length.toLocaleString();
                    document.getElementById('totalGames').textContent = games.length.toLocaleString();
                    document.getElementById('totalOrders').textContent = orders.length.toLocaleString();
                    document.getElementById('totalRevenue').textContent = `$${totalRevenue.toLocaleString()}`;
                } catch (error) {
                    console.error('Error loading stats:', error);
                    // Fallback to default values
                    document.getElementById('totalUsers').textContent = '0';
                    document.getElementById('totalGames').textContent = '0';
                    document.getElementById('totalOrders').textContent = '0';
                    document.getElementById('totalRevenue').textContent = '$0';
                }
            }

            initCharts() {
                this.initSalesChart();
                this.initCategoryChart();
            }

            initSalesChart() {
                const ctx = document.getElementById('salesChart').getContext('2d');
                new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'],
                        datasets: [{
                            label: 'Sales ($)',
                            data: [12000, 19000, 15000, 25000, 22000, 30000],
                            borderColor: 'rgb(75, 192, 192)',
                            backgroundColor: 'rgba(75, 192, 192, 0.2)',
                            tension: 0.1
                        }]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });
            }

            initCategoryChart() {
                const ctx = document.getElementById('categoryChart').getContext('2d');
                new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Action', 'RPG', 'Strategy', 'Sports', 'Adventure'],
                        datasets: [{
                            data: [30, 25, 20, 15, 10],
                            backgroundColor: [
                                '#FF6384',
                                '#36A2EB',
                                '#FFCE56',
                                '#4BC0C0',
                                '#9966FF'
                            ]
                        }]
                    },
                    options: {
                        responsive: true
                    }
                });
            }

            async loadRecentOrders() {
                try {
                    // Since there's no orders endpoint yet, show placeholder data
                    const orders = []; // TODO: Replace when orders endpoint is available
                    
                    const tbody = document.getElementById('recentOrdersBody');
                    if (tbody) {
                        if (orders.length === 0) {
                            tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">Chưa có đơn hàng nào</td></tr>';
                        } else {
                            const recentOrders = orders.slice(-5).reverse();
                            tbody.innerHTML = recentOrders.map(order => `
                                <tr>
                                    <td>#${order.id}</td>
                                    <td>${order.user_name}</td>
                                    <td>${order.game_title}</td>
                                    <td>$${order.amount}</td>
                                    <td>
                                        <span class="badge bg-${order.status === 'completed' ? 'success' : 'warning'}">
                                            ${order.status}
                                        </span>
                                    </td>
                                </tr>
                            `).join('');
                        }
                    }
                } catch (error) {
                    console.error('Error loading recent orders:', error);
                    const tbody = document.getElementById('recentOrdersBody');
                    if (tbody) {
                        tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">Không thể tải dữ liệu đơn hàng</td></tr>';
                    }
                }
            }

            async loadRecentReviews() {
                try {
                    // Since there's no reviews endpoint yet, show placeholder data
                    const reviews = []; // TODO: Replace when reviews endpoint is available

                    const tbody = document.getElementById('recentReviewsBody');
                    if (tbody) {
                        if (reviews.length === 0) {
                            tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted">Chưa có đánh giá nào</td></tr>';
                        } else {
                            const recentReviews = reviews.slice(-5).reverse();
                            tbody.innerHTML = recentReviews.map(review => `
                                <tr>
                                    <td>${review.game_title}</td>
                                    <td>${review.user_name}</td>
                                    <td>
                                        ${'★'.repeat(review.rating)}${'☆'.repeat(5 - review.rating)}
                                    </td>
                                    <td>${AdminUtils.formatDate(review.review_date)}</td>
                                </tr>
                            `).join('');
                        }
                    }
                } catch (error) {
                    console.error('Error loading recent reviews:', error);
                    const tbody = document.getElementById('recentReviewsBody');
                    if (tbody) {
                        tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted">Không thể tải dữ liệu đánh giá</td></tr>';
                    }
                }
            }
        }

        // Initialize dashboard when DOM is loaded
        document.addEventListener('DOMContentLoaded', () => {
            const dashboard = new DashboardManager();
            dashboard.init();
        });
    </script>
</body>
</html>

