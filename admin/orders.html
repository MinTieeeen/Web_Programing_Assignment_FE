<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Purchases - NextPlay Admin</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@tabler/core@latest/dist/css/tabler.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@tabler/icons-webfont@latest/dist/tabler-icons.min.css">
    <style>@import url('https://rsms.me/inter/inter.css');</style>
</head>
<body class="layout-fluid">
    <script src="https://cdn.jsdelivr.net/npm/@tabler/core@latest/dist/js/tabler.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <div class="page">
        <aside class="navbar navbar-vertical navbar-expand-lg" data-bs-theme="dark">
            <div class="container-fluid">
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#sidebar-menu"><span class="navbar-toggler-icon"></span></button>
                <h1 class="navbar-brand navbar-brand-autodark"><a href="/admin/index.html"><i class="ti ti-device-gamepad-2 me-2"></i><span>NextPlay Admin</span></a></h1>
                <div class="collapse navbar-collapse" id="sidebar-menu">
                    <ul class="navbar-nav pt-lg-3">
                        <li class="nav-item"><a class="nav-link" href="/admin/index.html"><span class="nav-link-icon"><i class="ti ti-home"></i></span><span class="nav-link-title">Dashboard</span></a></li>
                        <li class="nav-item"><a class="nav-link" href="/admin/users.html"><span class="nav-link-icon"><i class="ti ti-users"></i></span><span class="nav-link-title">Users</span></a></li>
                        <li class="nav-item"><a class="nav-link" href="/admin/admin-users.html"><span class="nav-link-icon"><i class="ti ti-shield-check"></i></span><span class="nav-link-title">Admins</span></a></li>
                        <li class="nav-item"><a class="nav-link" href="/admin/products.html"><span class="nav-link-icon"><i class="ti ti-device-gamepad-2"></i></span><span class="nav-link-title">Games</span></a></li>
                        <li class="nav-item"><a class="nav-link active" href="/admin/orders.html"><span class="nav-link-icon"><i class="ti ti-shopping-cart"></i></span><span class="nav-link-title">Purchases</span></a></li>
                        <li class="nav-item"><a class="nav-link" href="/admin/comments.html"><span class="nav-link-icon"><i class="ti ti-message-circle"></i></span><span class="nav-link-title">Reviews</span></a></li>
                        <li class="nav-item"><a class="nav-link" href="/admin/contacts.html"><span class="nav-link-icon"><i class="ti ti-building"></i></span><span class="nav-link-title">Publishers</span></a></li>
                        <li class="nav-item"><a class="nav-link" href="/admin/posts.html"><span class="nav-link-icon"><i class="ti ti-category"></i></span><span class="nav-link-title">Categories</span></a></li>
                        <li class="nav-item"><a class="nav-link" href="/admin/faqs.html"><span class="nav-link-icon"><i class="ti ti-help"></i></span><span class="nav-link-title">FAQs</span></a></li>
                        <li class="nav-item"><a class="nav-link" href="/admin/news.html"><span class="nav-link-icon"><i class="ti ti-news"></i></span><span class="nav-link-title">News</span></a></li>
                        <li class="nav-item"><a class="nav-link" href="/admin/feedback.html"><span class="nav-link-icon"><i class="ti ti-star"></i></span><span class="nav-link-title">Feedback</span></a></li>
                        <li class="nav-item"><a class="nav-link" href="/admin/settings.html"><span class="nav-link-icon"><i class="ti ti-settings"></i></span><span class="nav-link-title">Settings</span></a></li>
                        <li class="nav-item mt-auto"><a class="nav-link text-danger" href="#" onclick="logout()"><span class="nav-link-icon"><i class="ti ti-logout"></i></span><span class="nav-link-title">Logout</span></a></li>
                    </ul>
                </div>
            </div>
        </aside>
        <div class="page-wrapper">
            <header class="navbar navbar-expand-md d-none d-lg-flex d-print-none">
                <div class="container-xl">
                    <div class="navbar-nav flex-row order-md-last">
                        <div class="nav-item dropdown">
                            <a href="#" class="nav-link d-flex lh-1 text-reset p-0" data-bs-toggle="dropdown">
                                <span class="avatar avatar-sm bg-primary" id="userAvatar">A</span>
                                <div class="d-none d-xl-block ps-2"><div id="userName">Admin</div><div class="mt-1 small text-muted">Administrator</div></div>
                            </a>
                            <div class="dropdown-menu dropdown-menu-end dropdown-menu-arrow">
                                <a href="/admin/settings.html" class="dropdown-item"><i class="ti ti-settings me-2"></i>Settings</a>
                                <div class="dropdown-divider"></div>
                                <a href="#" class="dropdown-item text-danger" onclick="logout()"><i class="ti ti-logout me-2"></i>Logout</a>
                            </div>
                        </div>
                    </div>
                    <div class="flex-grow-1 d-flex">
                        <div class="input-icon w-100" style="max-width: 400px;">
                            <span class="input-icon-addon"><i class="ti ti-search"></i></span>
                            <input type="text" class="form-control" id="searchInput" placeholder="Search purchases..." onkeyup="filterPurchases()">
                        </div>
                    </div>
                </div>
            </header>
            <div class="page-header d-print-none">
                <div class="container-xl">
                    <div class="page-pretitle">Management</div>
                    <h2 class="page-title">Purchases & Orders</h2>
                </div>
            </div>
            <div class="page-body">
                <div class="container-xl">
                    <!-- Stats -->
                    <div class="row row-deck row-cards mb-3">
                        <div class="col-sm-6 col-lg-3">
                            <div class="card card-sm">
                                <div class="card-body">
                                    <div class="row align-items-center">
                                        <div class="col-auto"><span class="bg-success text-white avatar"><i class="ti ti-check"></i></span></div>
                                        <div class="col"><div class="font-weight-medium" id="totalPurchases">0</div><div class="text-muted">Total Purchases</div></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-sm-6 col-lg-3">
                            <div class="card card-sm">
                                <div class="card-body">
                                    <div class="row align-items-center">
                                        <div class="col-auto"><span class="bg-primary text-white avatar"><i class="ti ti-users"></i></span></div>
                                        <div class="col"><div class="font-weight-medium" id="totalCustomers">0</div><div class="text-muted">Customers</div></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-sm-6 col-lg-3">
                            <div class="card card-sm">
                                <div class="card-body">
                                    <div class="row align-items-center">
                                        <div class="col-auto"><span class="bg-yellow text-white avatar"><i class="ti ti-currency-dollar"></i></span></div>
                                        <div class="col"><div class="font-weight-medium" id="totalRevenue">â‚«0</div><div class="text-muted">Total Revenue</div></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-sm-6 col-lg-3">
                            <div class="card card-sm">
                                <div class="card-body">
                                    <div class="row align-items-center">
                                        <div class="col-auto"><span class="bg-azure text-white avatar"><i class="ti ti-chart-bar"></i></span></div>
                                        <div class="col"><div class="font-weight-medium" id="avgGames">0</div><div class="text-muted">Avg Games/User</div></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- Purchases by Customer -->
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Purchases by Customer</h3>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-vcenter card-table table-striped">
                                <thead>
                                    <tr>
                                        <th>Customer</th>
                                        <th>Game</th>
                                        <th>Library</th>
                                        <th>Price</th>
                                        <th class="w-1">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="purchasesTableBody">
                                    <tr><td colspan="5" class="text-center text-muted">Loading...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            <footer class="footer footer-transparent d-print-none"><div class="container-xl"><div class="text-center">Copyright &copy; 2024 NextPlay.</div></div></footer>
        </div>
    </div>

    <!-- View Purchase Modal -->
    <div class="modal modal-blur fade" id="viewPurchaseModal" tabindex="-1">
        <div class="modal-dialog"><div class="modal-content">
            <div class="modal-header"><h5 class="modal-title">Purchase Details</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
            <div class="modal-body" id="viewPurchaseBody"></div>
        </div></div>
    </div>

    <!-- View Customer Library Modal -->
    <div class="modal modal-blur fade" id="viewCustomerLibraryModal" tabindex="-1">
        <div class="modal-dialog modal-lg"><div class="modal-content">
            <div class="modal-header"><h5 class="modal-title">Customer Library</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
            <div class="modal-body" id="viewCustomerLibraryBody"></div>
        </div></div>
    </div>

    <script src="../env.js"></script>
    <script>
        const API_BASE_URL = window.ENV?.API_URL || '';
        let purchases = [];
        
        function logout() { 
            fetch(`${API_BASE_URL}/users/logout`, { method: 'POST', credentials: 'include' })
            .finally(() => window.location.href = '/admin/login.html'); 
        }
        
        function formatCurrency(amt) { 
            return new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(amt || 0); 
        }

        async function loadData() {
            try {
                const [statsRes, purchasesRes] = await Promise.all([
                    fetch(`${API_BASE_URL}/library/stats`, { credentials: 'include' }),
                    fetch(`${API_BASE_URL}/library/all`, { credentials: 'include' })
                ]);
                
                const statsData = await statsRes.json();
                const purchasesData = await purchasesRes.json();
                
                if (statsData.status === 'success') {
                    document.getElementById('totalPurchases').textContent = statsData.data.total_purchases;
                    document.getElementById('totalCustomers').textContent = statsData.data.total_customers;
                    document.getElementById('totalRevenue').textContent = formatCurrency(statsData.data.total_revenue);
                    document.getElementById('avgGames').textContent = statsData.data.avg_games_per_customer;
                }
                
                if (purchasesData.status === 'success') {
                    purchases = purchasesData.data || [];
                    renderPurchases(purchases);
                }
            } catch (e) { 
                console.error(e); 
                document.getElementById('purchasesTableBody').innerHTML = '<tr><td colspan="5" class="text-center text-danger">Error loading data</td></tr>';
            }
        }

        function renderPurchases(data) {
            const tbody = document.getElementById('purchasesTableBody');
            if (data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">No purchases found</td></tr>';
                return;
            }
            
            tbody.innerHTML = data.map(p => `
                <tr>
                    <td>
                        <div class="d-flex align-items-center">
                            <span class="avatar bg-primary text-white me-2">${(p.uname || 'U')[0].toUpperCase()}</span>
                            <div>
                                <div class="font-weight-medium">${p.uname || 'Unknown'}</div>
                                <div class="text-muted small">${p.fname || ''} ${p.lname || ''}</div>
                            </div>
                        </div>
                    </td>
                    <td>
                        <div class="d-flex align-items-center">
                            ${p.thumbnail ? `<img src="${p.thumbnail}" class="avatar me-2" alt="">` : '<span class="avatar bg-azure text-white me-2"><i class="ti ti-device-gamepad-2"></i></span>'}
                            <div>${p.game_name || 'Unknown Game'}</div>
                        </div>
                    </td>
                    <td><span class="badge bg-blue-lt">${p.libname || 'Default'}</span></td>
                    <td>${formatCurrency(p.game_price)}</td>
                    <td>
                        <div class="btn-list flex-nowrap">
                            <button class="btn btn-sm btn-outline-primary" onclick="viewPurchase(${p.uid}, ${p.Gid})" title="View">
                                <i class="ti ti-eye"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-info" onclick="viewCustomerLibrary(${p.uid}, '${p.uname}')" title="View Library">
                                <i class="ti ti-books"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        function filterPurchases() {
            const search = document.getElementById('searchInput').value.toLowerCase();
            
            let filtered = purchases;
            if (search) {
                filtered = filtered.filter(p => 
                    (p.uname || '').toLowerCase().includes(search) ||
                    (p.game_name || '').toLowerCase().includes(search) ||
                    (p.fname || '').toLowerCase().includes(search) ||
                    (p.lname || '').toLowerCase().includes(search)
                );
            }
            
            renderPurchases(filtered);
        }

        function viewPurchase(uid, gid) {
            const purchase = purchases.find(p => p.uid == uid && p.Gid == gid);
            if (!purchase) return;
            
            document.getElementById('viewPurchaseBody').innerHTML = `
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label text-muted">Customer</label>
                            <div class="d-flex align-items-center">
                                <span class="avatar bg-primary text-white me-2">${(purchase.uname || 'U')[0].toUpperCase()}</span>
                                <div>
                                    <strong>${purchase.uname || 'Unknown'}</strong>
                                    <div class="text-muted small">${purchase.fname || ''} ${purchase.lname || ''}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label text-muted">User ID</label>
                            <div>${purchase.uid}</div>
                        </div>
                    </div>
                </div>
                <hr>
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label text-muted">Game</label>
                            <div class="d-flex align-items-center">
                                ${purchase.thumbnail ? `<img src="${purchase.thumbnail}" class="avatar me-2" alt="">` : '<span class="avatar bg-azure text-white me-2"><i class="ti ti-device-gamepad-2"></i></span>'}
                                <strong>${purchase.game_name || 'Unknown'}</strong>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label text-muted">Price</label>
                            <div class="fs-4 text-success">${formatCurrency(purchase.game_price)}</div>
                        </div>
                    </div>
                </div>
                <div class="mb-3">
                    <label class="form-label text-muted">Library</label>
                    <div><span class="badge bg-blue-lt fs-6">${purchase.libname || 'Default'}</span></div>
                </div>
            `;
            new bootstrap.Modal(document.getElementById('viewPurchaseModal')).show();
        }

        function viewCustomerLibrary(uid, uname) {
            const customerPurchases = purchases.filter(p => p.uid == uid);
            const totalSpent = customerPurchases.reduce((sum, p) => sum + (parseFloat(p.game_price) || 0), 0);
            
            document.getElementById('viewCustomerLibraryBody').innerHTML = `
                <div class="row mb-3">
                    <div class="col-md-6">
                        <div class="d-flex align-items-center">
                            <span class="avatar avatar-lg bg-primary text-white me-3">${(uname || 'U')[0].toUpperCase()}</span>
                            <div>
                                <h4 class="mb-0">${uname || 'Unknown'}</h4>
                                <div class="text-muted">${customerPurchases.length} games in library</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6 text-end">
                        <div class="text-muted small">Total Spent</div>
                        <div class="fs-3 text-success">${formatCurrency(totalSpent)}</div>
                    </div>
                </div>
                <hr>
                <div class="list-group list-group-flush" style="max-height: 400px; overflow-y: auto;">
                    ${customerPurchases.map(p => `
                        <div class="list-group-item d-flex justify-content-between align-items-center">
                            <div class="d-flex align-items-center">
                                ${p.thumbnail ? `<img src="${p.thumbnail}" class="avatar me-2" alt="">` : '<span class="avatar bg-azure text-white me-2"><i class="ti ti-device-gamepad-2"></i></span>'}
                                <div>
                                    <div class="font-weight-medium">${p.game_name || 'Unknown'}</div>
                                    <div class="text-muted small">Library: ${p.libname || 'Default'}</div>
                                </div>
                            </div>
                            <span class="badge bg-success">${formatCurrency(p.game_price)}</span>
                        </div>
                    `).join('')}
                </div>
            `;
            new bootstrap.Modal(document.getElementById('viewCustomerLibraryModal')).show();
        }

        document.addEventListener('DOMContentLoaded', loadData);
    </script>
</body>
</html>
