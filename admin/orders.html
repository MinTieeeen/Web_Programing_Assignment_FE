<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quản lý đơn hàng & giỏ hàng - NextPlay</title>
    <!-- Tabler Core -->
    <link href="../assets/tabler/css/tabler.min.css" rel="stylesheet"/>
    <link href="../assets/tabler/css/tabler-flags.min.css" rel="stylesheet"/>
    <link href="../assets/tabler/css/tabler-payments.min.css" rel="stylesheet"/>
    <link href="../assets/tabler/css/tabler-vendors.min.css" rel="stylesheet"/>
    <style>
      @import url('https://rsms.me/inter/inter.css');
      :root {
      	--tblr-font-sans-serif: 'Inter Var', -apple-system, BlinkMacSystemFont, San Francisco, Segoe UI, Roboto, Helvetica Neue, sans-serif;
      }
      body {
      	font-feature-settings: "cv03", "cv04", "cv11";
      }
    </style>
</head>
<body>
    <script src="../assets/tabler/js/tabler-theme.min.js"></script>
    <div class="page">
        <!-- Sidebar -->
        <div id="sidebarContainer"></div>

        <div class="page-wrapper">
            <!-- Navbar -->
            <div id="navbarContainer"></div>

            <!-- Page Header -->
            <div class="page-header d-print-none">
                <div class="container-xl">
                    <div class="row g-2 align-items-center">
                        <div class="col">
                            <h2 class="page-title">
                                Quản lý đơn hàng & giỏ hàng
                            </h2>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Page Body -->
            <div class="page-body">
                <div class="container-xl">
                    <!-- Tabs Navigation -->
                    <div class="card-tabs ">
                        <ul class="nav nav-tabs " role="tablist">
                            <li class="nav-item" role="presentation">
                                <a href="#carts" class="nav-link active" data-bs-toggle="tab" aria-selected="true" role="tab">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="icon me-2" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M6 19m-2 0a2 2 0 1 0 4 0a2 2 0 1 0 -4 0" /><path d="M17 19m-2 0a2 2 0 1 0 4 0a2 2 0 1 0 -4 0" /><path d="M17 17h-11v-14h-2" /><path d="M6 5l14 1l-1 7h-13" /></svg>
                                    Giỏ hàng hoạt động
                                </a>
                            </li>

                        </ul>

                        <div class="tab-content">
                            <!-- Carts Tab -->
                            <div class="tab-pane active show" id="carts" role="tabpanel">
                                <!-- Stats Row -->
                                <div class="row row-deck row-cards mb-4 mt-3">
                                    <div class="col-sm-6 col-lg-3">
                                        <div class="card">
                                            <div class="card-body">
                                                <div class="d-flex align-items-center">
                                                    <div class="subheader">Active Carts</div>
                                                </div>
                                                <div class="h1 mb-3" id="activeCartsCount">89</div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-sm-6 col-lg-3">
                                        <div class="card">
                                            <div class="card-body">
                                                <div class="d-flex align-items-center">
                                                    <div class="subheader">Giỏ hàng hoạt động</div>
                                                </div>
                                                <div class="h1 mb-3" id="activeCartsCount">89</div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-sm-6 col-lg-3">
                                        <div class="card">
                                            <div class="card-body">
                                                <div class="d-flex align-items-center">
                                                    <div class="subheader">Giá trị chờ xử lý</div>
                                                </div>
                                                <div class="h1 mb-3" id="pendingValue">$...</div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-sm-6 col-lg-3">
                                        <div class="card">
                                            <div class="card-body">
                                                <div class="d-flex align-items-center">
                                                    <div class="subheader">Giỏ hàng bị bỏ rơi</div>
                                                </div>
                                                <div class="h1 mb-3" id="abandonedCarts">23</div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-sm-6 col-lg-3">
                                        <div class="card">
                                            <div class="card-body">
                                                <div class="d-flex align-items-center">
                                                    <div class="subheader">Thanh toán thất bại</div>
                                                </div>
                                                <div class="h1 mb-3" id="failedPayments">7</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Filters -->
                                <div class="card mb-3">
                                    <div class="card-body">
                                        <div class="row g-2">
                                            <div class="col-md-4">
                                                <input type="text" class="form-control" id="searchCarts" placeholder="Tìm kiếm theo khách hàng...">
                                            </div>
                                            <div class="col-md-3">
                                                <select class="form-select" id="cartStatusFilter">
                                                    <option value="">Tất cả trạng thái</option>
                                                    <option value="active">Hoạt động</option>
                                                    <option value="abandoned">Bị bỏ rơi</option>
                                                    <option value="pending">Chờ thanh toán</option>
                                                </select>
                                            </div>

                                        </div>
                                    </div>
                                </div>

                                <!-- Carts Table -->
                                <div class="card">
                                    <div class="card-header">
                                        <h3 class="card-title">Giỏ hàng đang hoạt động</h3>
                                    </div>
                                    <div class="table-responsive">
                                        <table class="table card-table table-vcenter text-nowrap datatable" id="cartsTable">
                                            <thead>
                                                <tr>
                                                    <th>ID Giỏ hàng</th>
                                                    <th>Khách hàng</th>
                                                    <th>Sản phẩm</th>
                                                    <th>Tổng tiền</th>

                                                    <th>Trạng thái</th>
                                                    <th>Cập nhật cuối</th>
                                                    <th>Thao tác</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <!-- Dynamic content -->
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>


                        </div>
                    </div>
                </div>
            </div>
            
             <footer class="footer footer-transparent d-print-none">
                <div class="container-xl">
                    <div class="row text-center align-items-center flex-row-reverse">
                        <div class="col-12 col-lg-auto mt-3 mt-lg-0">
                            <ul class="list-inline list-inline-dots mb-0">
                                <li class="list-inline-item">
                                    Copyright &copy; 2025
                                    <a href="." class="link-secondary">NextPlay</a>.
                                    All rights reserved.
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
            </footer>
        </div>
    </div>

    <!-- Order Details Modal -->
    <div class="modal modal-blur fade" id="orderDetailsModal" tabindex="-1" role="dialog" aria-hidden="true">
        <div class="modal-dialog modal-xl modal-dialog-centered" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Chi tiết đơn hàng</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="orderDetailsContent">
                    <!-- Dynamic content -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn me-auto" data-bs-dismiss="modal">Đóng</button>
                    <button type="button" class="btn btn-danger" onclick="refundOrder()" id="refundBtn">
                        <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 11l-4 4l4 4m-4 -4h11a4 4 0 0 0 0 -8h-1" /></svg>
                        Hoàn tiền
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../assets/tabler/js/tabler.min.js"></script>
    <script src="../env.js?v=2"></script>
    <script src="../assets/js/admin/utils.js?v=2"></script>
    <script src="../assets/js/admin/components.js?v=2"></script>
    <script>
        // Ensure ENV is loaded
        if (!window.ENV || !window.ENV.API_URL) {
            document.body.innerHTML = '<div class="alert alert-danger m-5"><h4>Configuration Error</h4><p>ENV not loaded! Make sure env.js is included and API_URL is configured.</p></div>';
            throw new Error('[admin/orders.html] ENV not loaded!');
        }
        const API_BASE_URL = window.ENV.API_URL;
        let allCarts = [];
        let allOrders = [];

        // Initialize page
        document.addEventListener('DOMContentLoaded', async () => {
            const authResult = await AdminUtils.checkAuthentication();
            if (authResult) {
                await AdminComponents.init('orders');
                await loadStats();
                await loadCarts();
                // await loadOrders(); // Removed
                setupFilters();
            }
        });

        // Load cart and order statistics
        async function loadStats() {
            try {
                const response = await fetch(`${API_BASE_URL}/admin/carts/stats`, {
                    credentials: 'include',
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
                });
                const result = await response.json();
                
                if (result.status === 'success') {
                    const stats = result.data.stats;
                    
                    // Cart stats
                    document.getElementById('activeCartsCount').textContent = stats.active_carts || 0;
                    document.getElementById('pendingValue').textContent = AdminUtils.formatCurrency(stats.pending_value || 0);
                    
                    // Order stats
                    document.getElementById('totalOrders').textContent = stats.completed_orders || 0;
                    document.getElementById('totalRevenue').textContent = AdminUtils.formatCurrency(stats.total_revenue || 0);
                    
                    // Calculate avg order value
                    const avgValue = stats.completed_orders > 0 ? 
                        (stats.total_revenue / stats.completed_orders) : 0;
                    document.getElementById('avgOrderValue').textContent = AdminUtils.formatCurrency(avgValue);
                }
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }

        // Load active carts
        async function loadCarts() {
            try {
                const response = await fetch(`${API_BASE_URL}/admin/carts`, {
                    credentials: 'include',
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
                });
                const result = await response.json();
                
                if (result.status === 'success') {
                    allCarts = result.data;
                    displayCarts();
                }
            } catch (error) {
                console.error('Error loading carts:', error);
            }
        }

        function displayCarts() {
            const tbody = document.querySelector('#cartsTable tbody');
            const searchTerm = document.getElementById('searchCarts')?.value.toLowerCase() || '';
            
            const filtered = allCarts.filter(cart => {
                return !searchTerm || 
                    cart.uname.toLowerCase().includes(searchTerm) ||
                    (cart.email && cart.email.toLowerCase().includes(searchTerm));
            });

            if (filtered.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="text-center text-muted py-4">Không có giỏ hàng hoạt động</td></tr>';
                return;
            }

            tbody.innerHTML = filtered.map(cart => `
                <tr>
                    <td><span class="text-muted">#${cart.uid}</span></td>
                    <td>
                        <div class="d-flex align-items-center">
                            ${cart.avatar 
                                ? `<img src="${cart.avatar}" class="avatar me-2" style="background-image: url(${cart.avatar})">` 
                                : `<span class="avatar me-2 bg-blue-lt">${(cart.fname || cart.uname)[0].toUpperCase()}</span>`
                            }
                            <div class="flex-fill">
                                <div class="font-weight-medium">${cart.fname || ''} ${cart.lname || cart.uname}</div>
                                <div class="text-muted"><a href="#" class="text-reset">${cart.email}</a></div>
                            </div>
                        </div>
                    </td>
                    <td>${cart.item_count} món</td>
                    <td><strong>${AdminUtils.formatCurrency(cart.total_amount)}</strong></td>
                    <td><span class="badge bg-warning me-1"></span> Hoạt động</td>
                    <td>${AdminUtils.formatDate(cart.created_date)}</td>
                    <td>
                        <button class="btn btn-icon btn-outline-info" onclick="viewCartDetails(${cart.uid})">
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M10 12a2 2 0 1 0 4 0a2 2 0 0 0 -4 0" /><path d="M21 12c-2.4 4 -5.4 6 -9 6c-3.6 0 -6.6 -2 -9 -6c2.4 -4 5.4 -6 9 -6c3.6 0 6.6 2 9 6" /></svg>
                        </button>
                    </td>
                </tr>
            `).join('');
        }



        // View cart details
        async function viewCartDetails(uid) {
            try {
                const response = await fetch(`${API_BASE_URL}/admin/carts/${uid}`, {
                    credentials: 'include',
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
                });
                const result = await response.json();
                
                if (result.status === 'success') {
                    const cart = result.data;
                    showCartModal(cart, 'Giỏ hàng');
                }
            } catch (error) {
                console.error('Error loading cart details:', error);
            }
        }

        // View order details
        async function viewOrderDetails(uid) {
            try {
                const response = await fetch(`${API_BASE_URL}/carts/${uid}/purchased`, {
                    credentials: 'include',
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
                });
                const result = await response.json();
                
                if (result.status === 'success') {
                    const order = result.data;
                    showCartModal(order, 'Đơn hàng');
                }
            } catch (error) {
                console.error('Error loading order details:', error);
            }
        }

        function showCartModal(data, type) {
            const content = document.getElementById('orderDetailsContent');
            const itemsHtml = data.items && data.items.length > 0 
                ? data.items.map(item => `
                    <tr>
                        <td>
                            <div class="d-flex align-items-center">
                                <span class="avatar me-2" style="background-image: url(${item.thumbnail || 'https://via.placeholder.com/50'})"></span>
                                ${item.name}
                            </div>
                        </td>
                        <td>${AdminUtils.formatCurrency(item.price)}</td>
                        <td>${item.quantity}</td>
                        <td>${AdminUtils.formatCurrency(item.subtotal)}</td>
                    </tr>
                `).join('')
                : '<tr><td colspan="4" class="text-center">Không có sản phẩm</td></tr>';

            content.innerHTML = `
                <div class="row mb-4">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header"><h3 class="card-title">Thông tin khách hàng</h3></div>
                            <div class="card-body">
                                <p class="mb-1"><strong>Tên:</strong> ${data.fname || ''} ${data.lname || data.uname}</p>
                                <p class="mb-0"><strong>Email:</strong> ${data.email}</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header"><h3 class="card-title">Thông tin ${type}</h3></div>
                            <div class="card-body">
                                <p class="mb-1"><strong>Trạng thái:</strong> <span class="badge bg-${data.status === 'purchased' ? 'success' : 'warning'}">${data.status}</span></p>
                                <p class="mb-0"><strong>Ngày:</strong> ${AdminUtils.formatDate(data.created_date)}</p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="card">
                    <div class="table-responsive">
                        <table class="table table-vcenter card-table">
                            <thead>
                                <tr>
                                    <th>Trò chơi</th>
                                    <th>Giá</th>
                                    <th>SL</th>
                                    <th>Thành tiền</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${itemsHtml}
                            </tbody>
                            <tfoot>
                                <tr>
                                    <th colspan="3" class="text-end">Tổng cộng:</th>
                                    <th>${AdminUtils.formatCurrency(data.total)}</th>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
            `;
            
            document.getElementById('refundBtn').style.display = data.status === 'purchased' ? 'block' : 'none';
            new bootstrap.Modal(document.getElementById('orderDetailsModal')).show();
        }

        function setupFilters() {
            document.getElementById('searchCarts')?.addEventListener('input', displayCarts);
            document.getElementById('searchCarts')?.addEventListener('input', displayCarts);
            // document.getElementById('searchOrders')?.addEventListener('input', displayOrders);
        }

        function refundOrder() {
            alert('Chức năng hoàn tiền chưa được triển khai');
        }
    </script>
</body>
</html>
