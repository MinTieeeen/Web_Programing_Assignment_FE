<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Users - NextPlay Admin</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@tabler/core@latest/dist/css/tabler.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@tabler/icons-webfont@latest/dist/tabler-icons.min.css">
    <style>@import url('https://rsms.me/inter/inter.css');</style>
</head>
<body class="layout-fluid">
    <script src="https://cdn.jsdelivr.net/npm/@tabler/core@latest/dist/js/tabler.min.js"></script>
    
    <div class="page">
        <!-- Sidebar -->
        <aside class="navbar navbar-vertical navbar-expand-lg" data-bs-theme="dark">
            <div class="container-fluid">
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#sidebar-menu">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <h1 class="navbar-brand navbar-brand-autodark">
                    <a href="/admin/index.html">
                        <i class="ti ti-device-gamepad-2 me-2"></i>
                        <span class="nav-link-title">NextPlay Admin</span>
                    </a>
                </h1>
                <div class="collapse navbar-collapse" id="sidebar-menu">
                    <ul class="navbar-nav pt-lg-3">
                        <li class="nav-item"><a class="nav-link" href="/admin/index.html"><span class="nav-link-icon d-md-none d-lg-inline-block"><i class="ti ti-home"></i></span><span class="nav-link-title">Dashboard</span></a></li>
                        <li class="nav-item"><a class="nav-link active" href="/admin/users.html"><span class="nav-link-icon d-md-none d-lg-inline-block"><i class="ti ti-users"></i></span><span class="nav-link-title">Users</span></a></li>
                        <li class="nav-item"><a class="nav-link" href="/admin/admin-users.html"><span class="nav-link-icon d-md-none d-lg-inline-block"><i class="ti ti-shield-check"></i></span><span class="nav-link-title">Admins</span></a></li>
                        <li class="nav-item"><a class="nav-link" href="/admin/products.html"><span class="nav-link-icon d-md-none d-lg-inline-block"><i class="ti ti-device-gamepad-2"></i></span><span class="nav-link-title">Games</span></a></li>
                        <li class="nav-item"><a class="nav-link" href="/admin/orders.html"><span class="nav-link-icon d-md-none d-lg-inline-block"><i class="ti ti-shopping-cart"></i></span><span class="nav-link-title">Orders</span></a></li>
                        <li class="nav-item"><a class="nav-link" href="/admin/comments.html"><span class="nav-link-icon d-md-none d-lg-inline-block"><i class="ti ti-message-circle"></i></span><span class="nav-link-title">Reviews</span></a></li>
                        <li class="nav-item"><a class="nav-link" href="/admin/contacts.html"><span class="nav-link-icon d-md-none d-lg-inline-block"><i class="ti ti-building"></i></span><span class="nav-link-title">Publishers</span></a></li>
                        <li class="nav-item"><a class="nav-link" href="/admin/posts.html"><span class="nav-link-icon d-md-none d-lg-inline-block"><i class="ti ti-category"></i></span><span class="nav-link-title">Categories</span></a></li>
                        <li class="nav-item"><a class="nav-link" href="/admin/faqs.html"><span class="nav-link-icon d-md-none d-lg-inline-block"><i class="ti ti-help"></i></span><span class="nav-link-title">FAQs</span></a></li>
                        <li class="nav-item"><a class="nav-link" href="/admin/news.html"><span class="nav-link-icon d-md-none d-lg-inline-block"><i class="ti ti-news"></i></span><span class="nav-link-title">News</span></a></li>
                        <li class="nav-item"><a class="nav-link" href="/admin/feedback.html"><span class="nav-link-icon d-md-none d-lg-inline-block"><i class="ti ti-star"></i></span><span class="nav-link-title">Feedback</span></a></li>
                        <li class="nav-item"><a class="nav-link" href="/admin/settings.html"><span class="nav-link-icon d-md-none d-lg-inline-block"><i class="ti ti-settings"></i></span><span class="nav-link-title">Settings</span></a></li>
                        <li class="nav-item mt-auto"><a class="nav-link text-danger" href="#" onclick="logout()"><span class="nav-link-icon d-md-none d-lg-inline-block"><i class="ti ti-logout"></i></span><span class="nav-link-title">Logout</span></a></li>
                    </ul>
                </div>
            </div>
        </aside>

        <div class="page-wrapper">
            <!-- Header -->
            <header class="navbar navbar-expand-md d-none d-lg-flex d-print-none">
                <div class="container-xl">
                    <div class="navbar-nav flex-row order-md-last">
                        <div class="d-none d-md-flex me-3">
                            <a href="/" class="nav-link px-0" title="Back to Store"><i class="ti ti-home"></i></a>
                        </div>
                        <div class="nav-item dropdown">
                            <a href="#" class="nav-link d-flex lh-1 text-reset p-0" data-bs-toggle="dropdown">
                                <span class="avatar avatar-sm bg-primary" id="userAvatar">A</span>
                                <div class="d-none d-xl-block ps-2">
                                    <div id="userName">Admin</div>
                                    <div class="mt-1 small text-muted">Administrator</div>
                                </div>
                            </a>
                            <div class="dropdown-menu dropdown-menu-end dropdown-menu-arrow">
                                <a href="/admin/settings.html" class="dropdown-item"><i class="ti ti-settings me-2"></i> Settings</a>
                                <div class="dropdown-divider"></div>
                                <a href="#" class="dropdown-item text-danger" onclick="logout()"><i class="ti ti-logout me-2"></i> Logout</a>
                            </div>
                        </div>
                    </div>
                </div>
            </header>

            <!-- Page Header -->
            <div class="page-header d-print-none">
                <div class="container-xl">
                    <div class="row align-items-center">
                        <div class="col-auto">
                            <div class="page-pretitle">Management</div>
                            <h2 class="page-title">Users</h2>
                        </div>
                        <div class="col-auto ms-auto">
                            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addUserModal">
                                <i class="ti ti-plus me-2"></i> Add User
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Page Body -->
            <div class="page-body">
                <div class="container-xl">
                    <!-- Filters -->
                    <div class="card mb-3">
                        <div class="card-body">
                            <div class="row g-3">
                                <div class="col-md-4">
                                    <div class="input-icon">
                                        <span class="input-icon-addon"><i class="ti ti-search"></i></span>
                                        <input type="text" class="form-control" id="searchUser" placeholder="Search users...">
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <select class="form-select" id="statusFilter">
                                        <option value="">All Status</option>
                                        <option value="active">Active</option>
                                        <option value="inactive">Inactive</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <input type="date" class="form-control" id="dateFilter">
                                </div>
                                <div class="col-md-2">
                                    <button class="btn btn-secondary w-100" onclick="resetFilters()">
                                        <i class="ti ti-refresh me-1"></i> Reset
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Users Table -->
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Users List</h3>
                            <div class="card-actions">
                                <span class="text-muted" id="userCount">0 users</span>
                            </div>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-vcenter card-table table-striped">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>User</th>
                                        <th>Email</th>
                                        <th>Date of Birth</th>
                                        <th>Balance</th>
                                        <th>Status</th>
                                        <th class="w-1">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="usersTableBody">
                                    <tr>
                                        <td colspan="7" class="text-center text-muted">Loading...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        <div class="card-footer d-flex align-items-center">
                            <p class="m-0 text-muted">Showing <span id="showingFrom">0</span> to <span id="showingTo">0</span> of <span id="totalEntries">0</span> entries</p>
                            <ul class="pagination m-0 ms-auto" id="pagination"></ul>
                        </div>
                    </div>
                </div>
            </div>

            <footer class="footer footer-transparent d-print-none">
                <div class="container-xl">
                    <div class="text-center">Copyright &copy; 2024 NextPlay. All rights reserved.</div>
                </div>
            </footer>
        </div>
    </div>

    <!-- Add User Modal -->
    <div class="modal modal-blur fade" id="addUserModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add New User</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="addUserForm">
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label">Username</label>
                                <input type="text" class="form-control" name="uname" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Email</label>
                                <input type="email" class="form-control" name="email" required>
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label">First Name</label>
                                <input type="text" class="form-control" name="fname">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Last Name</label>
                                <input type="text" class="form-control" name="lname">
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label">Password</label>
                                <input type="password" class="form-control" name="password" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Date of Birth</label>
                                <input type="date" class="form-control" name="dob">
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="addUser()">Add User</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit User Modal -->
    <div class="modal modal-blur fade" id="editUserModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Edit User</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editUserForm">
                        <input type="hidden" name="uid" id="editUserId">
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label">Username</label>
                                <input type="text" class="form-control" name="uname" id="editUsername" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Email</label>
                                <input type="email" class="form-control" name="email" id="editEmail" required>
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label">First Name</label>
                                <input type="text" class="form-control" name="fname" id="editFirstName">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Last Name</label>
                                <input type="text" class="form-control" name="lname" id="editLastName">
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label">Balance</label>
                                <input type="number" class="form-control" name="balance" id="editBalance">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Date of Birth</label>
                                <input type="date" class="form-control" name="dob" id="editDob">
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="updateUser()">Save Changes</button>
                </div>
            </div>
        </div>
    </div>

    <script src="../env.js"></script>
    <script>
        if (!window.ENV || !window.ENV.API_URL) {
            document.body.innerHTML = '<div class="container mt-5"><div class="alert alert-danger">ENV not loaded!</div></div>';
            throw new Error('ENV not loaded!');
        }
        
        const API_BASE_URL = window.ENV.API_URL;
        let allUsers = [];
        let currentPage = 1;
        const itemsPerPage = 10;

        function logout() {
            fetch(`${API_BASE_URL}/users/logout`, { method: 'POST', credentials: 'include' })
                .finally(() => window.location.href = '/auth/login.html');
        }

        function formatCurrency(amount) {
            return new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(amount || 0);
        }

        function formatDate(dateStr) {
            if (!dateStr) return 'N/A';
            return new Date(dateStr).toLocaleDateString('vi-VN');
        }

        async function loadUsers() {
            try {
                const response = await fetch(`${API_BASE_URL}/users`, { credentials: 'include' });
                const result = await response.json();
                
                if (result.status === 'success') {
                    allUsers = result.data.filter(u => u.role !== 'admin');
                    document.getElementById('userCount').textContent = `${allUsers.length} users`;
                    renderUsers();
                }
            } catch (error) {
                console.error('Error loading users:', error);
            }
        }

        function renderUsers() {
            const tbody = document.getElementById('usersTableBody');
            const search = document.getElementById('searchUser').value.toLowerCase();
            
            let filtered = allUsers.filter(u => 
                u.uname?.toLowerCase().includes(search) || 
                u.email?.toLowerCase().includes(search) ||
                u.fname?.toLowerCase().includes(search) ||
                u.lname?.toLowerCase().includes(search)
            );

            const totalPages = Math.ceil(filtered.length / itemsPerPage);
            const start = (currentPage - 1) * itemsPerPage;
            const paginated = filtered.slice(start, start + itemsPerPage);

            document.getElementById('showingFrom').textContent = start + 1;
            document.getElementById('showingTo').textContent = Math.min(start + itemsPerPage, filtered.length);
            document.getElementById('totalEntries').textContent = filtered.length;

            if (paginated.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">No users found</td></tr>';
                return;
            }

            tbody.innerHTML = paginated.map(user => {
                const isLocked = user.lockout_time && new Date(user.lockout_time) > new Date();
                const statusBadge = isLocked 
                    ? '<span class="badge bg-danger">Locked</span>' 
                    : '<span class="badge bg-success">Active</span>';
                
                return `
                <tr>
                    <td class="text-muted">${user.uid}</td>
                    <td>
                        <div class="d-flex align-items-center">
                            <span class="avatar avatar-sm me-2" style="background-image: url('${user.avatar || ''}')">
                                ${!user.avatar ? (user.uname || 'U')[0].toUpperCase() : ''}
                            </span>
                            <div>
                                <div class="font-weight-medium">${user.uname || 'N/A'}</div>
                                <div class="text-muted small">${user.fname || ''} ${user.lname || ''}</div>
                            </div>
                        </div>
                    </td>
                    <td>${user.email || 'N/A'}</td>
                    <td>${formatDate(user.DOB)}</td>
                    <td>${formatCurrency(user.balance)}</td>
                    <td>${statusBadge}</td>
                    <td>
                        <div class="btn-list flex-nowrap">
                            <button class="btn btn-sm btn-primary" onclick="editUser(${user.uid})">
                                <i class="ti ti-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="deleteUser(${user.uid})">
                                <i class="ti ti-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `}).join('');

            renderPagination(totalPages);
        }

        function renderPagination(totalPages) {
            const pagination = document.getElementById('pagination');
            let html = '';
            
            html += `<li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
                <a class="page-link" href="#" onclick="goToPage(${currentPage - 1})">
                    <i class="ti ti-chevron-left"></i>
                </a>
            </li>`;
            
            for (let i = 1; i <= totalPages; i++) {
                html += `<li class="page-item ${currentPage === i ? 'active' : ''}">
                    <a class="page-link" href="#" onclick="goToPage(${i})">${i}</a>
                </li>`;
            }
            
            html += `<li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
                <a class="page-link" href="#" onclick="goToPage(${currentPage + 1})">
                    <i class="ti ti-chevron-right"></i>
                </a>
            </li>`;
            
            pagination.innerHTML = html;
        }

        function goToPage(page) {
            currentPage = page;
            renderUsers();
        }

        function resetFilters() {
            document.getElementById('searchUser').value = '';
            document.getElementById('statusFilter').value = '';
            document.getElementById('dateFilter').value = '';
            currentPage = 1;
            renderUsers();
        }

        async function addUser() {
            const form = document.getElementById('addUserForm');
            const formData = new FormData(form);
            const data = Object.fromEntries(formData);

            try {
                const response = await fetch(`${API_BASE_URL}/users/register`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify(data)
                });
                const result = await response.json();
                
                if (result.status === 'success') {
                    bootstrap.Modal.getInstance(document.getElementById('addUserModal')).hide();
                    form.reset();
                    loadUsers();
                    alert('User added successfully!');
                } else {
                    alert(result.message || 'Error adding user');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error adding user');
            }
        }

        function editUser(uid) {
            const user = allUsers.find(u => u.uid === uid);
            if (!user) return;

            document.getElementById('editUserId').value = user.uid;
            document.getElementById('editUsername').value = user.uname || '';
            document.getElementById('editEmail').value = user.email || '';
            document.getElementById('editFirstName').value = user.fname || '';
            document.getElementById('editLastName').value = user.lname || '';
            document.getElementById('editBalance').value = user.balance || 0;
            document.getElementById('editDob').value = user.dob || '';

            new bootstrap.Modal(document.getElementById('editUserModal')).show();
        }

        async function updateUser() {
            const form = document.getElementById('editUserForm');
            const formData = new FormData(form);
            const data = Object.fromEntries(formData);
            const uid = data.uid;

            try {
                const response = await fetch(`${API_BASE_URL}/users/${uid}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify(data)
                });
                const result = await response.json();
                
                if (result.status === 'success') {
                    bootstrap.Modal.getInstance(document.getElementById('editUserModal')).hide();
                    loadUsers();
                    alert('User updated successfully!');
                } else {
                    alert(result.message || 'Error updating user');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error updating user');
            }
        }

        async function deleteUser(uid) {
            if (!confirm('Are you sure you want to delete this user?')) return;

            try {
                const response = await fetch(`${API_BASE_URL}/users/${uid}`, {
                    method: 'DELETE',
                    credentials: 'include'
                });
                const result = await response.json();
                
                if (result.status === 'success') {
                    loadUsers();
                    alert('User deleted successfully!');
                } else {
                    alert(result.message || 'Error deleting user');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error deleting user');
            }
        }

        document.getElementById('searchUser').addEventListener('input', () => {
            currentPage = 1;
            renderUsers();
        });

        document.addEventListener('DOMContentLoaded', loadUsers);
    </script>
</body>
</html>
