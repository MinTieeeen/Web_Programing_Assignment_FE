<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NextPlay - Quản lý người dùng</title>
    <!-- Tabler Core -->
    <link href="../assets/tabler/css/tabler.min.css" rel="stylesheet"/>
    <link href="../assets/tabler/css/tabler-flags.min.css" rel="stylesheet"/>
    <link href="../assets/tabler/css/tabler-payments.min.css" rel="stylesheet"/>
    <link href="../assets/tabler/css/tabler-vendors.min.css" rel="stylesheet"/>
    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../assets/tabler/js/tabler.min.js"></script>
    <script src="../env.js?v=2"></script>
    <style>
      @import url('https://rsms.me/inter/inter.css');
      :root {
      	--tblr-font-sans-serif: 'Inter Var', -apple-system, BlinkMacSystemFont, San Francisco, Segoe UI, Roboto, Helvetica Neue, sans-serif;
      }
      body {
      	font-feature-settings: "cv03", "cv04", "cv11";
      }
    </style>
</head>
<body>
    <script src="../assets/tabler/js/tabler-theme.min.js"></script>
    <div class="page">
        <!-- Sidebar -->
        <div id="sidebarContainer"></div>

        <div class="page-wrapper">
            <!-- Navbar -->
            <div id="navbarContainer"></div>

            <!-- Page Header -->
            <div class="page-header d-print-none">
                <div class="container-xl">
                    <div class="row g-2 align-items-center">
                        <div class="col">
                            <h2 class="page-title">
                                Quản lý người dùng
                            </h2>
                        </div>
                        <div class="col-auto ms-auto d-print-none">
                            <div class="btn-list">

                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Page Body -->
            <div class="page-body">
                <div class="container-xl">
                    <!-- Filters -->
                    <div class="card mb-3">
                        <div class="card-body">
                            <div class="row g-2">
                                <div class="col-md-4">
                                    <div class="input-icon">
                                        <span class="input-icon-addon">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M10 10m-7 0a7 7 0 1 0 14 0a7 7 0 0 0 -14 0" /><path d="M21 21l-6 -6" /></svg>
                                        </span>
                                        <input type="text" class="form-control" id="searchUser" placeholder="Tìm kiếm người dùng...">
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <select class="form-select" id="statusFilter">
                                        <option value="">Tất cả trạng thái</option>
                                        <option value="active">Hoạt động</option>
                                        <option value="inactive">Không hoạt động</option>
                                        <option value="suspended">Bị đình chỉ</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <input type="date" class="form-control" id="dateFilter">
                                </div>
                                <div class="col-md-2">
                                    <button class="btn btn-outline-secondary w-100" onclick="resetFilters()">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M20 11a8.1 8.1 0 0 0 -15.5 -2m-.5 -4v4h4" /><path d="M4 13a8.1 8.1 0 0 0 15.5 2m.5 4v-4h-4" /></svg>
                                        Đặt lại
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Users Table -->
                    <div class="card">
                        <div class="table-responsive">
                            <table class="table card-table table-vcenter text-nowrap datatable" id="usersTable">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Avatar</th>
                                        <th>Tài khoản</th>
                                        <th>Tên</th>
                                        <th>Email</th>
                                        <th>Ngày sinh</th>
                                        <th>Số dư</th>
                                        <th>Trạng thái</th>
                                        <th>Hành động</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Dynamic content will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                        <div class="card-footer d-flex align-items-center justify-content-center">
                            <ul class="pagination m-0" id="usersPagination">
                                <!-- Pagination will be generated dynamically -->
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
            
             <footer class="footer footer-transparent d-print-none">
                <div class="container-xl">
                    <div class="row text-center align-items-center flex-row-reverse">
                        <div class="col-12 col-lg-auto mt-3 mt-lg-0">
                            <ul class="list-inline list-inline-dots mb-0">
                                <li class="list-inline-item">
                                    Copyright &copy; 2025
                                    <a href="." class="link-secondary">NextPlay</a>.
                                    All rights reserved.
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
            </footer>
        </div>
    </div>

    <!-- Add User Modal -->




    <!-- View User Modal -->
    <div class="modal modal-blur fade" id="viewUserModal" tabindex="-1" role="dialog" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Chi tiết người dùng</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-3 text-center border-end">
                            <img id="viewUserAvatar" src="" class="avatar avatar-xl mb-3 rounded-circle" alt="Avatar">
                            <h3 id="viewUserFullName" class="mb-1"></h3>
                            <div id="viewUserUsername" class="text-muted mb-2"></div>
                            <span id="viewUserStatus" class="badge bg-green text-green-fg"></span>
                        </div>
                        <div class="col-md-9">
                            <ul class="nav nav-tabs" data-bs-toggle="tabs">
                                <li class="nav-item">
                                    <a href="#tabs-overview" class="nav-link active" data-bs-toggle="tab">Tổng quan</a>
                                </li>
                                <li class="nav-item">
                                    <a href="#tabs-games" class="nav-link" data-bs-toggle="tab">Game sở hữu</a>
                                </li>
                                <li class="nav-item">
                                    <a href="#tabs-activity" class="nav-link" data-bs-toggle="tab">Lịch sử hoạt động</a>
                                </li>
                            </ul>
                            <div class="tab-content mt-3">
                                <div class="tab-pane active show" id="tabs-overview">
                                    <table class="table table-borderless">
                                        <tbody>
                                            <tr>
                                                <td width="30%"><strong>ID:</strong></td>
                                                <td id="viewUserId"></td>
                                            </tr>
                                            <tr>
                                                <td><strong>Email:</strong></td>
                                                <td id="viewUserEmail"></td>
                                            </tr>
                                            <tr>
                                                <td><strong>Ngày sinh:</strong></td>
                                                <td id="viewUserDob"></td>
                                            </tr>
                                            <tr>
                                                <td><strong>Số dư:</strong></td>
                                                <td id="viewUserBalance" class="text-success fw-bold"></td>
                                            </tr>
                                            <tr>
                                                <td><strong>Ngày tham gia:</strong></td>
                                                <td id="viewUserJoined"></td>
                                            </tr>
                                            <tr>
                                                <td><strong>Lần đăng nhập cuối:</strong></td>
                                                <td id="viewUserLastLogin"></td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                                <div class="tab-pane" id="tabs-games">
                                    <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                                        <table class="table table-vcenter card-table" id="viewUserGamesTable">
                                            <thead>
                                                <tr>
                                                    <th>Game</th>
                                                    <th>Giá</th>
                                                    <th>Ngày mua</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <!-- Dynamic Content -->
                                            </tbody>
                                        </table>
                                        <div id="viewUserGamesEmpty" class="text-center p-3 text-muted d-none">
                                            Chưa sở hữu game nào.
                                        </div>
                                    </div>
                                </div>
                                <div class="tab-pane" id="tabs-activity">
                                    <h4>Đánh giá Game</h4>
                                    <div class="table-responsive mb-3" style="max-height: 250px; overflow-y: auto;">
                                        <table class="table table-vcenter card-table" id="viewUserFeedbacksTable">
                                            <thead>
                                                <tr>
                                                    <th>Game</th>
                                                    <th>Đánh giá</th>
                                                    <th>Nội dung</th>
                                                    <th>Ngày</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <!-- Dynamic Content -->
                                            </tbody>
                                        </table>
                                        <div id="viewUserFeedbacksEmpty" class="text-center p-2 text-muted d-none">
                                            Chưa có đánh giá nào.
                                        </div>
                                    </div>

                                    <h4>Bình luận Tin tức</h4>
                                    <div class="table-responsive" style="max-height: 250px; overflow-y: auto;">
                                        <table class="table table-vcenter card-table" id="viewUserCommentsTable">
                                            <thead>
                                                <tr>
                                                    <th>Tin tức ID</th> <!-- Could be Title if joined -->
                                                    <th>Nội dung</th>
                                                    <th>Ngày</th> <!-- If available -->
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <!-- Dynamic Content -->
                                            </tbody>
                                        </table>
                                        <div id="viewUserCommentsEmpty" class="text-center p-2 text-muted d-none">
                                            Chưa có bình luận nào.
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Reset Password Modal -->
    <div class="modal modal-blur fade" id="resetPasswordModal" tabindex="-1" role="dialog" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Đặt lại mật khẩu</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="resetPasswordForm">
                        <input type="hidden" id="resetUserId">
                        <p class="text-muted">Đặt mật khẩu mới cho người dùng <strong id="resetTargetUsername"></strong>.</p>
                        <div class="mb-3">
                            <label class="form-label">Mật khẩu mới</label>
                            <input type="password" class="form-control" id="newPassword" required minlength="8" autocomplete="new-password">
                            <small class="form-hint">Tối thiểu 8 ký tự, bao gồm chữ hoa, chữ thường, số và ký tự đặc biệt.</small>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Xác nhận mật khẩu</label>
                            <input type="password" class="form-control" id="confirmNewPassword" required autocomplete="new-password">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn me-auto" data-bs-dismiss="modal">Hủy</button>
                    <button type="button" class="btn btn-danger" onclick="adminUsers.submitResetPassword()">Đặt lại mật khẩu</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Lock User Modal -->
    <div class="modal modal-blur fade" id="lockUserModal" tabindex="-1" role="dialog" aria-hidden="true">
        <div class="modal-dialog modal-sm modal-dialog-centered" role="document">
            <div class="modal-content">
                <div class="modal-body">
                    <div class="modal-title">Khóa tài khoản?</div>
                    <input type="hidden" id="lockUserId">
                    <div class="mb-2">Bạn có chắc chắn muốn khóa tài khoản <strong id="lockTargetUsername"></strong>?</div>
                    <div class="mb-3">
                        <label class="form-label">Thời gian khóa</label>
                        <select class="form-select" id="lockDuration">
                            <option value="15 minutes">15 phút</option>
                            <option value="1 hour">1 giờ</option>
                            <option value="1 day">1 ngày</option>
                            <option value="7 days">7 ngày</option>
                            <option value="30 days">30 ngày</option>
                            <option value="permanent" selected>Vĩnh viễn</option>
                        </select>
                    </div>
                    <div class="mb-2">
                         <label class="form-check">
                            <input class="form-check-input" type="checkbox" id="confirmLock">
                            <span class="form-check-label">Xác nhận khóa người dùng này</span>
                        </label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-link link-secondary me-auto" data-bs-dismiss="modal">Hủy</button>
                    <button type="button" class="btn btn-danger" onclick="adminUsers.submitLockUser()">Khóa tài khoản</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="../assets/tabler/js/tabler.min.js"></script>
    <script src="../env.js?v=2"></script>
    <script src="../assets/js/admin/utils.js?v=2"></script>
    <script src="../assets/js/admin/components.js?v=2"></script>
    <script src="../assets/js/admin/users.js?v=2"></script>
    <script>
        // Initialize components when DOM is loaded
        document.addEventListener('DOMContentLoaded', async () => {
            // Check authentication first
            const authResult = await AdminUtils.checkAuthentication();
            if (authResult) {
                await AdminComponents.init('users');
                // Initialize the existing UserManager if it exists
                if (typeof UserManager !== 'undefined') {
                    const userManager = new UserManager();
                    userManager.init();
                }
            }
        });
    </script>
</body>
</html>

