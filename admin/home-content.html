<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quản lý Trang chủ - NextPlay Admin</title>
    <!-- Tabler Core -->
    <link href="../assets/tabler/css/tabler.min.css" rel="stylesheet"/>
    <link href="../assets/tabler/css/tabler-flags.min.css" rel="stylesheet"/>
    <link href="../assets/tabler/css/tabler-vendors.min.css" rel="stylesheet"/>
    <link href="../assets/css/toast.css" rel="stylesheet"/>
    <style>
      @import url('https://rsms.me/inter/inter.css');
      :root {
      	--tblr-font-sans-serif: 'Inter Var', -apple-system, BlinkMacSystemFont, San Francisco, Segoe UI, Roboto, Helvetica Neue, sans-serif;
      }
      .field-value {
          font-weight: 500;
          color: #1e293b;
      }
      .field-empty {
          color: #94a3b8;
          font-style: italic;
      }
      .view-mode, .edit-mode-container {
          background-color: #f8fafc;
          border: 1px solid #e2e8f0;
          border-radius: 8px;
          padding: 0.75rem 1rem;
          transition: all 0.2s ease;
      }
      .view-mode {
          cursor: default;
      }
      .view-mode .btn-edit-icon {
          opacity: 0.5;
          transition: all 0.2s ease;
          border-radius: 50%;
          padding: 4px;
      }
      .view-mode:hover .btn-edit-icon {
          opacity: 1;
          background-color: #e2e8f0;
          color: #3b82f6;
          transform: scale(1.1);
      }
      .edit-mode {
          display: none;
      }
      .edit-mode-container {
          background-color: #fff;
          border: 1px solid #cbd5e1;
          box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
          animation: slideDown 0.2s ease-out;
      }
      @keyframes slideDown {
          from { opacity: 0; transform: translateY(-5px); }
          to { opacity: 1; transform: translateY(0); }
      }
      .edit-actions {
          margin-top: 0.75rem;
          padding-top: 0.75rem;
          border-top: 1px dashed #e2e8f0;
          display: flex;
          justify-content: flex-end;
          gap: 0.75rem;
      }
      .edit-actions .btn {
          font-weight: 500;
          padding-left: 1.25rem;
          padding-right: 1.25rem;
      }
    </style>
</head>
<body>
    <script src="../assets/tabler/js/tabler-theme.min.js"></script>
    <div class="page">
        <!-- Sidebar -->
        <div id="sidebarContainer"></div>

        <div class="page-wrapper">
            <!-- Navbar -->
            <div id="navbarContainer"></div>

            <!-- Page Header -->
            <div class="page-header d-print-none">
                <div class="container-xl">
                    <div class="row g-2 align-items-center">
                        <div class="col">
                            <h2 class="page-title">
                                Quản lý Trang chủ
                            </h2>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Page Body -->
            <div class="page-body">
                <div class="container-xl">
                    <div class="row row-cards">
                        <!-- Homepage Content Section -->
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header">
                                    <h3 class="card-title">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-home me-2" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M5 12l-2 0l9 -9l9 9l-2 0" /><path d="M5 12v7a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-7" /><path d="M9 21v-6a2 2 0 0 1 2 -2h2a2 2 0 0 1 2 2v6" /></svg>
                                        Nội dung Hero & Thống kê
                                    </h3>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <h4>Hero Section</h4>
                                            <!-- Hero Title -->
                                            <div class="mb-4" id="group_home_hero_title">
                                                <label class="form-label">Tiêu đề chính</label>
                                                <div class="view-mode p-2 border rounded bg-light position-relative">
                                                     <div class="field-value" id="view_home_hero_title" style="white-space: pre-wrap;"></div>
                                                     <button class="btn btn-sm btn-icon btn-ghost-primary btn-edit-icon position-absolute top-0 end-0 m-2" onclick="toggleEdit('home_hero_title')">
                                                        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-pencil" width="20" height="20" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M4 20h4l10.5 -10.5a1.5 1.5 0 0 0 -4 -4l-10.5 10.5v4" /><path d="M13.5 6.5l4 4" /></svg>
                                                    </button>
                                                </div>
                                                <div class="edit-mode edit-mode-container">
                                                    <textarea class="form-control mb-2" id="input_home_hero_title" rows="2"></textarea>
                                                    <div class="edit-actions">
                                                        <button class="btn btn-sm btn-outline-secondary" onclick="toggleEdit('home_hero_title', false)">Hủy</button>
                                                        <button class="btn btn-sm btn-primary" onclick="saveContent('home', 'hero', 'title', 'home_hero_title')">Lưu thay đổi</button>
                                                    </div>
                                                </div>
                                            </div>

                                            <!-- Hero Description -->
                                            <div class="mb-4" id="group_home_hero_desc">
                                                <label class="form-label">Mô tả</label>
                                                <div class="view-mode p-2 border rounded bg-light position-relative">
                                                     <div class="field-value" id="view_home_hero_desc" style="white-space: pre-wrap;"></div>
                                                     <button class="btn btn-sm btn-icon btn-ghost-primary btn-edit-icon position-absolute top-0 end-0 m-2" onclick="toggleEdit('home_hero_desc')">
                                                        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-pencil" width="20" height="20" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M4 20h4l10.5 -10.5a1.5 1.5 0 0 0 -4 -4l-10.5 10.5v4" /><path d="M13.5 6.5l4 4" /></svg>
                                                    </button>
                                                </div>
                                                <div class="edit-mode edit-mode-container">
                                                    <textarea class="form-control mb-2" id="input_home_hero_desc" rows="3"></textarea>
                                                    <div class="edit-actions">
                                                        <button class="btn btn-sm btn-outline-secondary" onclick="toggleEdit('home_hero_desc', false)">Hủy</button>
                                                        <button class="btn btn-sm btn-primary" onclick="saveContent('home', 'hero', 'description', 'home_hero_desc')">Lưu thay đổi</button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="col-md-6">
                                            <h4>Stats Section (Thống kê)</h4>
                                            
                                            <!-- Stat 1 -->
                                            <div class="row">
                                                <div class="col-6 mb-3" id="group_home_stat_1_val">
                                                    <label class="form-label small">Stat 1 Value</label>
                                                     <div class="input-group input-group-sm">
                                                        <input type="text" class="form-control" id="input_home_stat_1_val" placeholder="100+">
                                                        <button class="btn btn-outline-primary" type="button" onclick="saveContent('home', 'stats', 'stat_1_value', 'home_stat_1_val')">Lưu</button>
                                                    </div>
                                                </div>
                                                 <div class="col-6 mb-3" id="group_home_stat_1_lbl">
                                                    <label class="form-label small">Stat 1 Label</label>
                                                     <div class="input-group input-group-sm">
                                                        <input type="text" class="form-control" id="input_home_stat_1_lbl" placeholder="Game đa dạng">
                                                        <button class="btn btn-outline-primary" type="button" onclick="saveContent('home', 'stats', 'stat_1_label', 'home_stat_1_lbl')">Lưu</button>
                                                    </div>
                                                </div>
                                            </div>

                                            <!-- Stat 2 -->
                                            <div class="row">
                                                <div class="col-6 mb-3" id="group_home_stat_2_val">
                                                    <label class="form-label small">Stat 2 Value</label>
                                                     <div class="input-group input-group-sm">
                                                        <input type="text" class="form-control" id="input_home_stat_2_val" placeholder="50K+">
                                                        <button class="btn btn-outline-primary" type="button" onclick="saveContent('home', 'stats', 'stat_2_value', 'home_stat_2_val')">Lưu</button>
                                                    </div>
                                                </div>
                                                 <div class="col-6 mb-3" id="group_home_stat_2_lbl">
                                                    <label class="form-label small">Stat 2 Label</label>
                                                     <div class="input-group input-group-sm">
                                                        <input type="text" class="form-control" id="input_home_stat_2_lbl" placeholder="Người chơi">
                                                        <button class="btn btn-outline-primary" type="button" onclick="saveContent('home', 'stats', 'stat_2_label', 'home_stat_2_lbl')">Lưu</button>
                                                    </div>
                                                </div>
                                            </div>
                                            
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
             <footer class="footer footer-transparent d-print-none">
                <div class="container-xl">
                    <div class="row text-center align-items-center flex-row-reverse">
                        <div class="col-12 col-lg-auto mt-3 mt-lg-0">
                            <ul class="list-inline list-inline-dots mb-0">
                                <li class="list-inline-item">
                                    Copyright &copy; 2025
                                    <a href="." class="link-secondary">NextPlay</a>.
                                    All rights reserved.
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
            </footer>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../assets/tabler/js/tabler.min.js"></script>
    <script src="../env.js?v=2"></script>
    <script src="../assets/js/admin/utils.js?v=2"></script>
    <script src="../assets/js/admin/components.js?v=2"></script>
    <!-- Toast JS -->
    <script src="../assets/js/toast.js"></script>
    <script>
        if (!window.ENV || !window.ENV.API_URL) {
            throw new Error('[admin/home-content.html] ENV not loaded!');
        }
        const API_BASE_URL = window.ENV.API_URL;
        
        let currentContent = {};

        document.addEventListener('DOMContentLoaded', async () => {
            // Init with 'home-content' to highlight sidebar if we add it
            await AdminComponents.init('home-content');
            loadContent();
        });

        async function loadContent() {
            try {
                const response = await fetch(`${API_BASE_URL}/content`);
                const result = await response.json();
                
                if (result.status === 'success') {
                    currentContent = result.data;
                    
                    // Home Hero
                    const homeHero = (currentContent.home && currentContent.home.hero) || {};
                    const homeStats = (currentContent.home && currentContent.home.stats) || {};

                    renderField('home_hero_title', homeHero.title);
                    renderField('home_hero_desc', homeHero.description);

                    if(document.getElementById('input_home_stat_1_val')) document.getElementById('input_home_stat_1_val').value = homeStats.stat_1_value || '';
                    if(document.getElementById('input_home_stat_1_lbl')) document.getElementById('input_home_stat_1_lbl').value = homeStats.stat_1_label || '';
                    if(document.getElementById('input_home_stat_2_val')) document.getElementById('input_home_stat_2_val').value = homeStats.stat_2_value || '';
                    if(document.getElementById('input_home_stat_2_lbl')) document.getElementById('input_home_stat_2_lbl').value = homeStats.stat_2_label || '';

                } else {
                    console.error('Failed to load content:', result);
                    Toast.error('Không thể tải nội dung trang');
                }

            } catch (error) {
                console.error('Error loading content:', error);
                Toast.error('Không thể tải nội dung trang');
            }
        }
        
        function renderField(key, value) {
            const viewEl = document.getElementById(`view_${key}`);
            const inputEl = document.getElementById(`input_${key}`);
            
            if (viewEl) {
                if (value && value.trim() !== '') {
                    viewEl.textContent = value;
                    viewEl.classList.remove('field-empty');
                } else {
                    viewEl.textContent = '(Chưa có thông tin)';
                    viewEl.classList.add('field-empty');
                }
            }
            if (inputEl) inputEl.value = value || '';
        }

        function toggleEdit(key, isEdit = true) {
            const group = document.getElementById(`group_${key}`);
            if (!group) return;

            const viewMode = group.querySelector('.view-mode');
            const editMode = group.querySelector('.edit-mode');
            const inputEl = document.getElementById(`input_${key}`);

            if (isEdit) {
                viewMode.style.display = 'none';
                editMode.style.display = 'block'; 
                inputEl.focus();
            } else {
                viewMode.style.display = 'flex'; // Restore proper display
                editMode.style.display = 'none';
            }
        }

        const readableNames = {
            'title': 'Tiêu đề chính',
            'description': 'Mô tả Hero',
            'stat_1_value': 'Giá trị Thống kê 1',
            'stat_1_label': 'Nhãn Thống kê 1',
            'stat_2_value': 'Giá trị Thống kê 2',
            'stat_2_label': 'Nhãn Thống kê 2'
        };

        async function saveContent(pageKey, sectionKey, contentKey, uniqueId) {
            const inputId = `input_${uniqueId}`;
            const value = document.getElementById(inputId).value;
            
            try {
                const response = await fetch(`${API_BASE_URL}/admin/content`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: JSON.stringify({
                        page_key: pageKey,
                        section_key: sectionKey,
                        content_key: contentKey,
                        content_value: value
                    })
                });

                const result = await response.json();
                if (result.status === 'success' || response.ok) {
                    const displayName = readableNames[contentKey] || contentKey;
                    Toast.success(`Đã lưu ${displayName} thành công`);
                    renderField(uniqueId, value);
                    toggleEdit(uniqueId, false);
                } else {
                    Toast.error('Lưu thất bại: ' + (result.message || 'Lỗi server'));
                }
            } catch (error) {
                console.error('Error saving content:', error);
                Toast.error('Lỗi kết nối');
            }
        }
    </script>
</body>
</html>
