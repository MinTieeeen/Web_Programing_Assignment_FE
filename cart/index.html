<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Giỏ hàng - NextPlay</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.2/font/bootstrap-icons.css">
  <link rel="stylesheet" href="../assets/css/style.css">
  <link rel="stylesheet" href="../assets/css/header.css?v=sidebar_fix">
  <link rel="stylesheet" href="../assets/css/footer.css">
  <link rel="stylesheet" href="../assets/css/toast.css">
  <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
  <link rel="stylesheet" href="../assets/css/cart.css?v=1">
</head>
<body>
  <div data-include="header"></div>

  <div class="container cart-container">
    <h2 class="mb-4">Giỏ hàng của bạn</h2>
    
    <div class="row" id="cart-content">
        <!-- Cart Items will be injected here -->
    </div>
  </div>

  <div data-include="footer"></div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="../env.js?v=2"></script>
  <script src="../assets/js/include-components.js?v=4"></script>
  <script src="../assets/js/auth.js?v=3"></script>
  <script src="../assets/js/toast.js"></script>
  <script src="../assets/js/cart.js?v=3"></script>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
        if (!localStorage.getItem('user')) {
            Toast.warning('Vui lòng đăng nhập để xem giỏ hàng!');
            window.location.href = '../auth/login.html';
            return;
        }
        renderCart();
    });

    async function renderCart() {
        const items = await Cart.fetchItems();
        const container = document.getElementById('cart-content');
        
        if (items.length === 0) {
            container.innerHTML = `
                <div class="col-12 empty-cart">
                    <i class="bi bi-cart-x"></i>
                    <h3>Giỏ hàng trống</h3>
                    <p class="text-secondary">Bạn chưa thêm game nào vào giỏ hàng.</p>
                    <a href="../products/index.html" class="btn btn-primary mt-3">Tiếp tục mua sắm</a>
                </div>
            `;
            return;
        }

        const total = items.reduce((sum, item) => sum + item.price, 0);
        const totalDisplay = new Intl.NumberFormat('vi-VN').format(total) + ' đ';

        const itemsHtml = items.map(item => `
            <div class="cart-item">
                <img src="${item.image}" alt="${item.name}">
                <div class="cart-item-info">
                    <div class="cart-item-title">${item.name}</div>
                    <div class="cart-item-price">
                        ${item.price === 0 ? 'Miễn phí' : new Intl.NumberFormat('vi-VN').format(item.price) + ' đ'}
                    </div>
                </div>
                <button onclick="removeItem(${item.id})" class="btn-remove">
                    <i class="bi bi-trash"></i> Xóa
                </button>
            </div>
        `).join('');

        container.innerHTML = `
            <div class="col-lg-8">
                ${itemsHtml}
            </div>
            <div class="col-lg-4">
                <div class="cart-summary">
                    <h4 class="mb-4">Tóm tắt đơn hàng</h4>
                    <div class="summary-row">
                        <span>Số dư hiện tại</span>
                        <span id="user-balance" class="text-success"></span>
                    </div>
                    <div class="summary-row">
                        <span>Tạm tính</span>
                        <span>${totalDisplay}</span>
                    </div>
                    <div class="summary-row">
                        <span>Giảm giá</span>
                        <span>0 đ</span>
                    </div>
                    <div class="summary-row summary-total">
                        <span>Tổng cộng</span>
                        <span class="text-info">${totalDisplay}</span>
                    </div>
                    <button onclick="Cart.checkout()" class="btn-checkout">
                        Thanh toán ngay
                    </button>
                    <a href="../products/index.html" class="d-block text-center mt-3 text-secondary text-decoration-none">
                        Tiếp tục mua sắm
                    </a>
                </div>
            </div>
        `;

        // Fetch and display user balance after rendering
        if (window.Cart && window.Cart.fetchUserBalance) {
            window.Cart.fetchUserBalance();
        }
    }

    function removeItem(id) {
        Toast.confirm('Bạn có chắc muốn xóa game này khỏi giỏ hàng?', () => {
            Cart.removeItem(id);
            // renderCart will be called by Cart.removeItem if it reloads, 
            // but since Cart.removeItem reloads the page if on cart page, we might not need this.
            // However, let's keep it consistent with previous logic or rely on reload.
            // Actually Cart.removeItem does location.reload() if on cart page.
        });
    }

  </script>
</body>
</html>
