<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Giỏ hàng - NextPlay</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.2/font/bootstrap-icons.css">
  <link rel="stylesheet" href="../assets/css/style.css">
  <link rel="stylesheet" href="../assets/css/header.css?v=balanced_v3">
  <link rel="stylesheet" href="../assets/css/footer.css">
  <link rel="stylesheet" href="../assets/css/toast.css">
  <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
  <style>
    body {
        background-color: #0f1f2b;
        color: #fff;
    }
    .cart-container {
        padding-top: 100px;
        min-height: 80vh;
    }
    .cart-item {
        background: #1a2c3a;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 15px;
        display: flex;
        align-items: center;
        gap: 20px;
    }
    .cart-item img {
        width: 120px;
        height: 68px;
        object-fit: cover;
        border-radius: 4px;
    }
    .cart-item-info {
        flex-grow: 1;
    }
    .cart-item-title {
        font-size: 1.1rem;
        font-weight: bold;
        margin-bottom: 5px;
        color: #fff;
    }
    .cart-item-price {
        color: #66c0f4;
        font-weight: bold;
    }
    .btn-remove {
        color: #ef4444;
        background: none;
        border: none;
        cursor: pointer;
        transition: color 0.2s;
    }
    .btn-remove:hover {
        color: #dc2626;
        text-decoration: underline;
    }
    .cart-summary {
        background: #1a2c3a;
        border-radius: 8px;
        padding: 20px;
        position: sticky;
        top: 100px;
    }
    .summary-row {
        display: flex;
        justify-content: space-between;
        margin-bottom: 15px;
        color: #cdd9e5;
    }
    .summary-total {
        border-top: 1px solid #2a475e;
        padding-top: 15px;
        margin-top: 15px;
        font-size: 1.2rem;
        font-weight: bold;
        color: #fff;
    }
    .btn-checkout {
        width: 100%;
        color: white;
        padding: 15px 35px;
        border-radius: 10px;
        border: 1px solid #72a1de81;
        background-color: #2200493d;
        box-shadow: 0 0 5px #72a1de81;
        cursor: pointer;
        transition: 0.3s;
        font-weight: 700;
        margin-top: 20px;
        font-size: 16px;
    }
    .btn-checkout:hover {
        box-shadow: 0 0 15px #72a1de81;
        background-color: #2200496d;
    }
    .btn-primary {
        color: white;
        padding: 12px 30px;
        border-radius: 10px;
        border: 1px solid #72a1de81;
        background-color: #2200493d;
        box-shadow: 0 0 5px #72a1de81;
        cursor: pointer;
        transition: 0.3s;
        font-weight: 600;
    }
    .btn-primary:hover {
        box-shadow: 0 0 15px #72a1de81;
        background-color: #2200496d;
        border-color: #72a1de;
    }
    .empty-cart {
        text-align: center;
        padding: 50px 0;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        min-height: 60vh;
    }
    .empty-cart i {
        font-size: 4rem;
        color: #2a475e;
        margin-bottom: 20px;
    }
  </style>
</head>
<body>
  <div data-include="header"></div>

  <div class="container cart-container">
    <h2 class="mb-4">Giỏ hàng của bạn</h2>
    
    <div class="row" id="cart-content">
        <!-- Cart Items will be injected here -->
    </div>
  </div>

  <div data-include="footer"></div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="../env.js?v=2"></script>
  <script src="../assets/js/include-components.js?v=4"></script>
  <script src="../assets/js/auth.js?v=3"></script>
  <script src="../assets/js/toast.js"></script>
  <script src="../assets/js/cart.js?v=3"></script>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
        if (!localStorage.getItem('user')) {
            Toast.warning('Vui lòng đăng nhập để xem giỏ hàng!');
            window.location.href = '../auth/login.html';
            return;
        }
        renderCart();
    });

    async function renderCart() {
        const items = await Cart.fetchItems();
        const container = document.getElementById('cart-content');
        
        if (items.length === 0) {
            container.innerHTML = `
                <div class="col-12 empty-cart">
                    <i class="bi bi-cart-x"></i>
                    <h3>Giỏ hàng trống</h3>
                    <p class="text-secondary">Bạn chưa thêm game nào vào giỏ hàng.</p>
                    <a href="../products/index.html" class="btn btn-primary mt-3">Tiếp tục mua sắm</a>
                </div>
            `;
            return;
        }

        const total = items.reduce((sum, item) => sum + item.price, 0);
        const totalDisplay = new Intl.NumberFormat('vi-VN').format(total) + ' đ';

        const itemsHtml = items.map(item => `
            <div class="cart-item">
                <img src="${item.image}" alt="${item.name}">
                <div class="cart-item-info">
                    <div class="cart-item-title">${item.name}</div>
                    <div class="cart-item-price">
                        ${item.price === 0 ? 'Miễn phí' : new Intl.NumberFormat('vi-VN').format(item.price) + ' đ'}
                    </div>
                </div>
                <button onclick="removeItem(${item.id})" class="btn-remove">
                    <i class="bi bi-trash"></i> Xóa
                </button>
            </div>
        `).join('');

        container.innerHTML = `
            <div class="col-lg-8">
                ${itemsHtml}
            </div>
            <div class="col-lg-4">
                <div class="cart-summary">
                    <h4 class="mb-4">Tóm tắt đơn hàng</h4>
                    <div class="summary-row">
                        <span>Số dư hiện tại</span>
                        <span id="user-balance" class="text-success"></span>
                    </div>
                    <div class="summary-row">
                        <span>Tạm tính</span>
                        <span>${totalDisplay}</span>
                    </div>
                    <div class="summary-row">
                        <span>Giảm giá</span>
                        <span>0 đ</span>
                    </div>
                    <div class="summary-row summary-total">
                        <span>Tổng cộng</span>
                        <span class="text-info">${totalDisplay}</span>
                    </div>
                    <button onclick="Cart.checkout()" class="btn-checkout">
                        Thanh toán ngay
                    </button>
                    <a href="../products/index.html" class="d-block text-center mt-3 text-secondary text-decoration-none">
                        Tiếp tục mua sắm
                    </a>
                </div>
            </div>
        `;

        // Fetch and display user balance after rendering
        if (window.Cart && window.Cart.fetchUserBalance) {
            window.Cart.fetchUserBalance();
        }
    }

    function removeItem(id) {
        Toast.confirm('Bạn có chắc muốn xóa game này khỏi giỏ hàng?', () => {
            Cart.removeItem(id);
            // renderCart will be called by Cart.removeItem if it reloads, 
            // but since Cart.removeItem reloads the page if on cart page, we might not need this.
            // However, let's keep it consistent with previous logic or rely on reload.
            // Actually Cart.removeItem does location.reload() if on cart page.
        });
    }

  </script>
</body>
</html>
