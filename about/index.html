<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Về Chúng Tôi - NextPlay</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.2/font/bootstrap-icons.css">
    <link rel="stylesheet" href="../assets/css/style.css">
    <link rel="stylesheet" href="../assets/css/header.css">
    <link rel="stylesheet" href="../assets/css/footer.css">
    <link rel="stylesheet" href="../assets/css/about.css">
</head>
<body>
    <div data-include="header"></div>

    <!-- Admin Controls -->
    <div id="admin-controls" class="d-none">
        <button id="btn-edit" class="btn btn-warning"><i class="bi bi-pencil-square"></i> Chỉnh sửa trang</button>
        <div id="edit-actions" class="d-none">
            <button id="btn-save" class="btn btn-success"><i class="bi bi-check-lg"></i> Lưu thay đổi</button>
            <button id="btn-cancel" class="btn btn-secondary"><i class="bi bi-x-lg"></i> Hủy</button>
        </div>
    </div>

    <!-- Hero Section -->
    <section class="hero-section">
        <div class="container text-center">
            <h1 class="hero-title editable" data-key="hero_title">Loading...</h1>
            <p class="hero-subtitle editable" data-key="hero_subtitle">Loading...</p>
        </div>
    </section>

    <!-- Intro Section -->
    <section class="intro-section">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-lg-6 mb-4 mb-lg-0">
                    <div class="intro-img-wrapper editable-img-wrapper">
                        <img src="" alt="Intro" class="img-fluid rounded-4 shadow-lg editable-img" data-key="intro_image">
                        <div class="img-overlay">
                            <button class="btn btn-light btn-sm" onclick="changeImage('intro_image')">Đổi ảnh</button>
                        </div>
                    </div>
                </div>
                <div class="col-lg-6">
                    <h2 class="section-title editable" data-key="intro_title">Loading...</h2>
                    <p class="section-text editable" data-key="intro_text">Loading...</p>
                    
                    <!-- Stats -->
                    <div class="row mt-5" id="stats-container">
                        <!-- Injected via JS -->
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Features Section -->
    <section class="features-section">
        <div class="container">
            <div class="row" id="features-container">
                <!-- Injected via JS -->
            </div>
        </div>
    </section>

    <div data-include="footer"></div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../assets/js/include-components.js"></script>
    <script src="../assets/js/auth.js?v=2"></script>
    <script src="../assets/js/cart.js?v=2"></script>
    <script>
        let pageData = {};
        let isEditing = false;

        document.addEventListener('DOMContentLoaded', async () => {
            await loadPageContent();
            checkAdminRole();
        });

        async function loadPageContent() {
            try {
                // Fix API URL if needed (handle port 8000 issue)
                let apiUrl = window.API_URL || 'http://localhost/BTL_LTW/BTL_LTW_BE';
                if (apiUrl.includes(':8000')) apiUrl = 'http://localhost/BTL_LTW/BTL_LTW_BE';

                const response = await fetch(`${apiUrl}/index.php/pages/about`);
                const result = await response.json();

                if (result.status === 'success') {
                    pageData = result.data.content;
                    renderPage();
                }
            } catch (error) {
                console.error('Error loading page content:', error);
            }
        }

        function renderPage() {
            // Render Text Fields
            document.querySelectorAll('.editable').forEach(el => {
                const key = el.dataset.key;
                if (pageData[key]) el.textContent = pageData[key];
            });

            // Render Images
            document.querySelectorAll('.editable-img').forEach(el => {
                const key = el.dataset.key;
                if (pageData[key]) el.src = pageData[key];
            });

            // Render Stats
            const statsContainer = document.getElementById('stats-container');
            if (pageData.stats) {
                statsContainer.innerHTML = pageData.stats.map((stat, index) => `
                    <div class="col-4 text-center">
                        <h3 class="stat-value editable-nested" data-group="stats" data-index="${index}" data-field="value">${stat.value}</h3>
                        <p class="stat-label editable-nested" data-group="stats" data-index="${index}" data-field="label">${stat.label}</p>
                    </div>
                `).join('');
            }

            // Render Features
            const featuresContainer = document.getElementById('features-container');
            if (pageData.features) {
                featuresContainer.innerHTML = pageData.features.map((feature, index) => `
                    <div class="col-md-4 mb-4">
                        <div class="feature-card text-center">
                            <div class="feature-icon">
                                <i class="bi ${feature.icon}"></i>
                            </div>
                            <h4 class="feature-title editable-nested" data-group="features" data-index="${index}" data-field="title">${feature.title}</h4>
                            <p class="feature-desc editable-nested" data-group="features" data-index="${index}" data-field="desc">${feature.desc}</p>
                        </div>
                    </div>
                `).join('');
            }
        }

        function checkAdminRole() {
            const userStr = localStorage.getItem('user');
            if (userStr) {
                const user = JSON.parse(userStr);
                // Simple check: if role is admin (assuming 'role' field exists, or specific username)
                // For demo purposes, let's allow 'admin' or specific user
                if (user.role === 'admin' || user.uname === 'admin') {
                    document.getElementById('admin-controls').classList.remove('d-none');
                }
            }
        }

        // --- CMS Logic ---

        const btnEdit = document.getElementById('btn-edit');
        const btnSave = document.getElementById('btn-save');
        const btnCancel = document.getElementById('btn-cancel');
        const editActions = document.getElementById('edit-actions');

        btnEdit.addEventListener('click', () => {
            isEditing = true;
            toggleEditMode(true);
        });

        btnCancel.addEventListener('click', () => {
            isEditing = false;
            toggleEditMode(false);
            renderPage(); // Revert changes
        });

        btnSave.addEventListener('click', async () => {
            await saveChanges();
            isEditing = false;
            toggleEditMode(false);
        });

        function toggleEditMode(enable) {
            btnEdit.classList.toggle('d-none', enable);
            editActions.classList.toggle('d-none', !enable);

            // Toggle contenteditable for simple text
            document.querySelectorAll('.editable, .editable-nested').forEach(el => {
                el.contentEditable = enable;
                el.classList.toggle('editing', enable);
            });

            // Toggle image overlays
            document.querySelectorAll('.img-overlay').forEach(el => {
                el.style.display = enable ? 'flex' : 'none';
            });
        }

        function changeImage(key) {
            const newUrl = prompt("Nhập URL hình ảnh mới:", pageData[key]);
            if (newUrl) {
                pageData[key] = newUrl;
                document.querySelector(`img[data-key="${key}"]`).src = newUrl;
            }
        }

        async function saveChanges() {
            // Collect data from DOM
            document.querySelectorAll('.editable').forEach(el => {
                pageData[el.dataset.key] = el.innerText;
            });

            // Collect nested data (stats, features)
            // Note: For simplicity, we update pageData directly from DOM for nested items
            // This requires re-parsing the DOM structure carefully or just updating the specific fields
            
            if (pageData.stats) {
                pageData.stats.forEach((stat, index) => {
                    stat.value = document.querySelector(`.stat-value[data-index="${index}"]`).innerText;
                    stat.label = document.querySelector(`.stat-label[data-index="${index}"]`).innerText;
                });
            }

            if (pageData.features) {
                pageData.features.forEach((feat, index) => {
                    feat.title = document.querySelector(`.feature-title[data-index="${index}"]`).innerText;
                    feat.desc = document.querySelector(`.feature-desc[data-index="${index}"]`).innerText;
                });
            }

            // Send to Backend
            try {
                let apiUrl = window.API_URL || 'http://localhost/BTL_LTW/BTL_LTW_BE';
                if (apiUrl.includes(':8000')) apiUrl = 'http://localhost/BTL_LTW/BTL_LTW_BE';

                const response = await fetch(`${apiUrl}/index.php/pages/about`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        title: 'Về Chúng Tôi', // Keep title constant or make editable
                        content: pageData
                    })
                });

                const result = await response.json();
                if (result.status === 'success') {
                    alert('Đã lưu thay đổi thành công!');
                } else {
                    alert('Lỗi khi lưu: ' + result.message);
                }
            } catch (error) {
                console.error('Error saving:', error);
                alert('Có lỗi xảy ra khi lưu.');
            }
        }
    </script>
</body>
</html>
